<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-CICD/Kubernetes">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">Kubernetes | Hi ~ 被你找到了哟</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://bothinli.github.io/blog/docs/CICD/Kubernetes"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Kubernetes | Hi ~ 被你找到了哟"><meta data-rh="true" name="description" content="kubernetes详细教程"><meta data-rh="true" property="og:description" content="kubernetes详细教程"><link data-rh="true" rel="icon" href="/blog/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://bothinli.github.io/blog/docs/CICD/Kubernetes"><link data-rh="true" rel="alternate" href="https://bothinli.github.io/blog/docs/CICD/Kubernetes" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://bothinli.github.io/blog/docs/CICD/Kubernetes" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://BWG0DEIDEP-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/blog/rss.xml" title="Hi ~ 被你找到了哟 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/blog/atom.xml" title="Hi ~ 被你找到了哟 Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Hi ~ 被你找到了哟" href="/blog/opensearch.xml">

<meta name="referrer" content="no-referrer"><link rel="stylesheet" href="/blog/assets/css/styles.75b33eb2.css">
<link rel="preload" href="/blog/assets/js/runtime~main.53b44da0.js" as="script">
<link rel="preload" href="/blog/assets/js/main.20f910f3.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><div class="announcementBar_mb4j" style="background-color:#fafbfc;color:#091E42" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">⭐️ 如果这个网站能帮助到你，欢迎给一个star支持作者  <a target="_blank" rel="noopener noreferrer" href="https://github.com/bothinli/blog">GitHub</a></div><button type="button" aria-label="关闭" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/blog/"><b class="navbar__title text--truncate">bothin的个人博客</b></a></div><div class="navbar__items navbar__items--right"><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog/docs/">正文</a><a class="navbar__item navbar__link" href="/blog/blog/面经">面经</a><a href="https://github.com/bothinli/blog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/blog/"><b>bothin的个人博客</b></a><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/blog/docs/">正文</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/blog/docs/CICD/">CICD</a><button aria-label="打开/收起侧边栏菜单「CICD」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/CICD/Docker笔记">Docker笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/CICD/DevOps学习笔记">DevOps学习笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/CICD/jenkins-install">jenkins-install</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/CICD/声明式pipeline语法">声明式pipeline语法</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/CICD/share-library">jenkins共享库</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/CICD/jenkins-api">jenkins-api</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blog/docs/CICD/jenkins源码学习">Jenkins源码学习</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/blog/docs/CICD/Kubernetes">Kubernetes</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/blog/docs/python/正则表达式">python</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/blog/docs/Django/DjangoAdmin使用">Django</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/blog/docs/部署学习/nginx">部署学习</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/blog/docs/线上问题/慢查询导致服务无法响应">线上问题</a></div></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/blog/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/blog/docs/CICD/"><span itemprop="name">CICD</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Kubernetes</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Kubernetes</h1></header><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="kubernetes详细教程">kubernetes详细教程<a href="#kubernetes详细教程" class="hash-link" aria-label="kubernetes详细教程的直接链接" title="kubernetes详细教程的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-kubernetes介绍">1. Kubernetes介绍<a href="#1-kubernetes介绍" class="hash-link" aria-label="1. Kubernetes介绍的直接链接" title="1. Kubernetes介绍的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11-应用部署方式演变">1.1 应用部署方式演变<a href="#11-应用部署方式演变" class="hash-link" aria-label="1.1 应用部署方式演变的直接链接" title="1.1 应用部署方式演变的直接链接">​</a></h4><p> 在部署应用程序的方式上，主要经历了三个时代：</p><ul><li><p><strong>传统部署</strong>：互联网早期，会直接将应用程序部署在物理机上</p><p> 优点：简单，不需要其它技术的参与</p><p> 缺点：不能为应用程序定义资源使用边界，很难合理地分配计算资源，而且程序之间容易产生影响</p></li><li><p><strong>虚拟化部署</strong>：可以在一台物理机上运行多个虚拟机，每个虚拟机都是独立的一个环境</p><p> 优点：程序环境不会相互产生影响，提供了一定程度的安全性</p><p> 缺点：增加了操作系统，浪费了部分资源</p></li><li><p><strong>容器化部署</strong>：与虚拟化类似，但是共享了操作系统</p><p>   优点：</p><p>   可以保证每个容器拥有自己的文件系统、CPU、内存、进程空间等</p><p>   运行应用程序所需要的资源都被容器包装，并和底层基础架构解耦</p><p>   容器化的应用程序可以跨云服务商、跨Linux操作系统发行版进行部署</p><p><img loading="lazy" alt="image-20200505183738289" src="/blog/assets/images/image-20200505183738289-e58302dd8b880122c67400fd5ca39c34.png" width="1112" height="418" class="img_ev3q"></p><p>容器化部署方式给带来很多的便利，但是也会出现一些问题，比如说：</p></li><li><p>一个容器故障停机了，怎么样让另外一个容器立刻启动去替补停机的容器</p></li><li><p>当并发访问量变大的时候，怎么样做到横向扩展容器数量</p><p>这些容器管理的问题统称为<strong>容器编排</strong>问题，为了解决这些容器编排问题，就产生了一些容器编排的软件：</p></li><li><p><strong>Swarm</strong>：Docker自己的容器编排工具</p></li><li><p><strong>Mesos</strong>：Apache的一个资源统一管控的工具，需要和Marathon结合使用</p></li><li><p><strong>Kubernetes</strong>：Google开源的的容器编排工具</p><p><img loading="lazy" alt="image-20200524150339551" src="/blog/assets/images/image-20200524150339551-5aff6492d9eab99cd1414e52c8d34053.png" width="593" height="272" class="img_ev3q"></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="12-kubernetes简介">1.2 kubernetes简介<a href="#12-kubernetes简介" class="hash-link" aria-label="1.2 kubernetes简介的直接链接" title="1.2 kubernetes简介的直接链接">​</a></h4><p><img loading="lazy" alt="image-20200406232838722" src="/blog/assets/images/image-20200406232838722-d1daf86627aeca3e09ec01eb926b3b33.png" width="541" height="281" class="img_ev3q"></p><p>kubernetes，是一个全新的基于容器技术的分布式架构领先方案，是谷歌严格保密十几年的秘密武器----Borg系统的一个开源版本，于2014年9月发布第一个版本，2015年7月发布第一个正式版本。</p><p>kubernetes的本质是<strong>一组服务器集群</strong>，它可以在集群的每个节点上运行特定的程序，来对节点中的容器进行管理。目的是实现资源管理的自动化，主要提供了如下的主要功能：</p></li><li><p><strong>自我修复</strong>：一旦某一个容器崩溃，能够在1秒中左右迅速启动新的容器</p></li><li><p><strong>弹性伸缩</strong>：可以根据需要，自动对集群中正在运行的容器数量进行调整</p></li><li><p><strong>服务发现</strong>：服务可以通过自动发现的形式找到它所依赖的服务</p></li><li><p><strong>负载均衡</strong>：如果一个服务起动了多个容器，能够自动实现请求的负载均衡</p></li><li><p><strong>版本回退</strong>：如果发现新发布的程序版本有问题，可以立即回退到原来的版本</p></li><li><p><strong>存储编排</strong>：可以根据容器自身的需求自动创建存储卷</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="13-kubernetes组件">1.3 kubernetes组件<a href="#13-kubernetes组件" class="hash-link" aria-label="1.3 kubernetes组件的直接链接" title="1.3 kubernetes组件的直接链接">​</a></h4><p>一个kubernetes集群主要是由<strong>控制节点(master)</strong>、<strong>工作节点(node)</strong>构成，每个节点上都会安装不同的组件。</p><p><strong>master：集群的控制平面，负责集群的决策 ( 管理 )</strong></p><p> <strong>ApiServer</strong> : 资源操作的唯一入口，接收用户输入的命令，提供认证、授权、API注册和发现等机制</p><p> <strong>Scheduler</strong> : 负责集群资源调度，按照预定的调度策略将Pod调度到相应的node节点上</p><p> <strong>ControllerManager</strong> : 负责维护集群的状态，比如程序部署安排、故障检测、自动扩展、滚动更新等</p><p> <strong>Etcd</strong> ：负责存储集群中各种资源对象的信息</p><p><strong>node：集群的数据平面，负责为容器提供运行环境 ( 干活 )</strong></p><p> <strong>Kubelet</strong> : 负责维护容器的生命周期，即通过控制docker，来创建、更新、销毁容器</p><p> <strong>KubeProxy</strong> : 负责提供集群内部的服务发现和负载均衡</p><p> <strong>Docker</strong> : 负责节点上容器的各种操作</p><p><img loading="lazy" alt="image-20200406184656917" src="/blog/assets/images/image-20200406184656917-ed92f8d2184b2383cf7992a3dcb69b0b.png" width="1436" height="745" class="img_ev3q"></p><p>下面，以部署一个nginx服务来说明kubernetes系统各个组件调用关系：</p></li></ul><ol><li><p>首先要明确，一旦kubernetes环境启动之后，master和node都会将自身的信息存储到etcd数据库中</p></li><li><p>一个nginx服务的安装请求会首先被发送到master节点的apiServer组件</p></li><li><p>apiServer组件会调用scheduler组件来决定到底应该把这个服务安装到哪个node节点上</p><p>在此时，它会从etcd中读取各个node节点的信息，然后按照一定的算法进行选择，并将结果告知apiServer</p></li><li><p>apiServer调用controller-manager去调度Node节点安装nginx服务</p></li><li><p>kubelet接收到指令后，会通知docker，然后由docker来启动一个nginx的pod</p><p>pod是kubernetes的最小操作单元，容器必须跑在pod中至此，</p></li><li><p>一个nginx服务就运行了，如果需要访问nginx，就需要通过kube-proxy来对pod产生访问的代理</p><p>这样，外界用户就可以访问集群中的nginx服务了</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="14-kubernetes概念">1.4 kubernetes概念<a href="#14-kubernetes概念" class="hash-link" aria-label="1.4 kubernetes概念的直接链接" title="1.4 kubernetes概念的直接链接">​</a></h4><p><strong>Master</strong>：集群控制节点，每个集群需要至少一个master节点负责集群的管控</p><p><strong>Node</strong>：工作负载节点，由master分配容器到这些node工作节点上，然后node节点上的docker负责容器的运行</p><p><strong>Pod</strong>：kubernetes的最小控制单元，容器都是运行在pod中的，一个pod中可以有1个或者多个容器</p><p><strong>Controller</strong>：控制器，通过它来实现对pod的管理，比如启动pod、停止pod、伸缩pod的数量等等</p><p><strong>Service</strong>：pod对外服务的统一入口，下面可以维护者同一类的多个pod</p><p><strong>Label</strong>：标签，用于对pod进行分类，同一类pod会拥有相同的标签</p><p><strong>NameSpace</strong>：命名空间，用来隔离pod的运行环境</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-kubernetes集群环境搭建">2. kubernetes集群环境搭建<a href="#2-kubernetes集群环境搭建" class="hash-link" aria-label="2. kubernetes集群环境搭建的直接链接" title="2. kubernetes集群环境搭建的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="21-前置知识点">2.1 前置知识点<a href="#21-前置知识点" class="hash-link" aria-label="2.1 前置知识点的直接链接" title="2.1 前置知识点的直接链接">​</a></h4><p>目前生产部署Kubernetes 集群主要有两种方式：</p><p><strong>kubeadm</strong></p><p>Kubeadm 是一个K8s 部署工具，提供kubeadm init 和kubeadm join，用于快速部署Kubernetes 集群。</p><p>官方地址：<a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/</a></p><p><strong>二进制包</strong></p><p>从github 下载发行版的二进制包，手动部署每个组件，组成Kubernetes 集群。</p><p>Kubeadm 降低部署门槛，但屏蔽了很多细节，遇到问题很难排查。如果想更容易可控，推荐使用二进制包部署Kubernetes 集群，虽然手动部署麻烦点，期间可以学习很多工作原理，也利于后期维护。</p><p><img loading="lazy" alt="image-20200404094800622" src="/blog/assets/images/image-20200404094800622-411b106bafe867e713fed91896b6ba33.png" width="1291" height="513" class="img_ev3q"></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="22-kubeadm-部署方式介绍">2.2 kubeadm 部署方式介绍<a href="#22-kubeadm-部署方式介绍" class="hash-link" aria-label="2.2 kubeadm 部署方式介绍的直接链接" title="2.2 kubeadm 部署方式介绍的直接链接">​</a></h4><p>kubeadm 是官方社区推出的一个用于快速部署kubernetes 集群的工具，这个工具能通过两条指令完成一个kubernetes 集群的部署：</p></li></ol><ul><li><p>创建一个Master 节点kubeadm init</p></li><li><p>将Node 节点加入到当前集群中$ kubeadm join &lt;Master 节点的IP 和端口</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="23-安装要求">2.3 安装要求<a href="#23-安装要求" class="hash-link" aria-label="2.3 安装要求的直接链接" title="2.3 安装要求的直接链接">​</a></h4><p>在开始之前，部署Kubernetes 集群机器需要满足以下几个条件：</p></li><li><p>一台或多台机器，操作系统CentOS7.x-86_x64</p></li><li><p>硬件配置：2GB 或更多RAM，2 个CPU 或更多CPU，硬盘30GB 或更多</p></li><li><p>集群中所有机器之间网络互通</p></li><li><p>可以访问外网，需要拉取镜像</p></li><li><p>禁止swap 分区</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="24-最终目标">2.4 最终目标<a href="#24-最终目标" class="hash-link" aria-label="2.4 最终目标的直接链接" title="2.4 最终目标的直接链接">​</a></h4></li><li><p>在所有节点上安装Docker 和kubeadm</p></li><li><p>部署Kubernetes Master</p></li><li><p>部署容器网络插件</p></li><li><p>部署Kubernetes Node，将节点加入Kubernetes 集群中</p></li><li><p>部署Dashboard Web 页面，可视化查看Kubernetes 资源</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="25-准备环境">2.5 准备环境<a href="#25-准备环境" class="hash-link" aria-label="2.5 准备环境的直接链接" title="2.5 准备环境的直接链接">​</a></h4><p><img loading="lazy" alt="image-20210609000002940" src="/blog/assets/images/image-20210609000002940-d55c5517774a32d76822d4d36aeba83a.png" width="662" height="455" class="img_ev3q"></p><table><thead><tr><th>角色</th><th>IP地址</th><th>组件</th></tr></thead><tbody><tr><td>master01</td><td>192.168.5.3</td><td>docker，kubectl，kubeadm，kubelet</td></tr><tr><td>node01</td><td>192.168.5.4</td><td>docker，kubectl，kubeadm，kubelet</td></tr><tr><td>node02</td><td>192.168.5.5</td><td>docker，kubectl，kubeadm，kubelet</td></tr></tbody></table><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="26-环境初始化">2.6 环境初始化<a href="#26-环境初始化" class="hash-link" aria-label="2.6 环境初始化的直接链接" title="2.6 环境初始化的直接链接">​</a></h4><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="261-检查操作系统的版本">2.6.1 检查操作系统的版本<a href="#261-检查操作系统的版本" class="hash-link" aria-label="2.6.1 检查操作系统的版本的直接链接" title="2.6.1 检查操作系统的版本的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 此方式下安装kubernetes集群要求Centos版本要在</span><span class="token number" style="color:#36acaa">7.5</span><span class="token plain">或之上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># cat </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">redhat</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Centos</span><span class="token plain"> </span><span class="token maybe-class-name">Linux</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7.5</span><span class="token number" style="color:#36acaa">.1804</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">Core</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="262-主机名解析">2.6.2 主机名解析<a href="#262-主机名解析" class="hash-link" aria-label="2.6.2 主机名解析的直接链接" title="2.6.2 主机名解析的直接链接">​</a></h5><p>为了方便集群节点间的直接调用，在这个配置一下主机名解析，企业中推荐使用内部DNS服务器</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 主机名成解析 编辑三台服务器的</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">hosts文件，添加下面内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">192.168</span><span class="token number" style="color:#36acaa">.90</span><span class="token number" style="color:#36acaa">.100</span><span class="token plain"> master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">192.168</span><span class="token number" style="color:#36acaa">.90</span><span class="token number" style="color:#36acaa">.106</span><span class="token plain"> node1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">192.168</span><span class="token number" style="color:#36acaa">.90</span><span class="token number" style="color:#36acaa">.107</span><span class="token plain"> node2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="263-时间同步">2.6.3 时间同步<a href="#263-时间同步" class="hash-link" aria-label="2.6.3 时间同步的直接链接" title="2.6.3 时间同步的直接链接">​</a></h5><p>kubernetes要求集群中的节点时间必须精确一直，这里使用chronyd服务从网络同步时间</p><p>企业中建议配置内部的会见同步服务器</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 启动chronyd服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># systemctl start chronyd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># systemctl enable chronyd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># date</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="264-禁用iptable和firewalld服务">2.6.4 禁用iptable和firewalld服务<a href="#264-禁用iptable和firewalld服务" class="hash-link" aria-label="2.6.4 禁用iptable和firewalld服务的直接链接" title="2.6.4 禁用iptable和firewalld服务的直接链接">​</a></h5><p>kubernetes和docker 在运行的中会产生大量的iptables规则，为了不让系统规则跟它们混淆，直接关闭系统的规则</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> 关闭firewalld服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># systemctl stop firewalld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># systemctl disable firewalld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> 关闭iptables服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># systemctl stop iptables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># systemctl disable iptables</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="265-禁用selinux">2.6.5 禁用selinux<a href="#265-禁用selinux" class="hash-link" aria-label="2.6.5 禁用selinux的直接链接" title="2.6.5 禁用selinux的直接链接">​</a></h5><p>selinux是linux系统下的一个安全服务，如果不关闭它，在安装集群中会产生各种各样的奇葩问题</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 编辑 </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">selinux</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">config 文件，修改</span><span class="token constant" style="color:#36acaa">SELINUX</span><span class="token plain">的值为disable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 注意修改完毕之后需要重启linux服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">SELINUX</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">disabled</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="266-禁用swap分区">2.6.6 禁用swap分区<a href="#266-禁用swap分区" class="hash-link" aria-label="2.6.6 禁用swap分区的直接链接" title="2.6.6 禁用swap分区的直接链接">​</a></h5><p>swap分区指的是虚拟内存分区，它的作用是物理内存使用完，之后将磁盘空间虚拟成内存来使用，启用swap设备会对系统的性能产生非常负面的影响，因此kubernetes要求每个节点都要禁用swap设备，但是如果因为某些原因确实不能关闭swap分区，就需要在集群安装过程中通过明确的参数进行配置说明</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 编辑分区配置文件</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">fstab，注释掉swap分区一行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 注意修改完毕之后需要重启linux服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vim </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">fstab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">注释掉 </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dev</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mapper</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">centos</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">swap swap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dev</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mapper</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">centos</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">swap swap</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="267-修改linux的内核参数">2.6.7 修改linux的内核参数<a href="#267-修改linux的内核参数" class="hash-link" aria-label="2.6.7 修改linux的内核参数的直接链接" title="2.6.7 修改linux的内核参数的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 修改linux的内核采纳数，添加网桥过滤和地址转发功能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 编辑</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sysctl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">d</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kubernetes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">conf文件，添加如下配置：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">bridge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">bridge</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nf</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">call</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ip6tables </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">bridge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">bridge</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nf</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">call</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">iptables </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">ipv4</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">ip_forward</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 重新加载配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># sysctl </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 加载网桥过滤模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># modprobe br_netfilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看网桥过滤模块是否加载成功</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># lsmod </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> grep br_netfilter</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="268-配置ipvs功能">2.6.8 配置ipvs功能<a href="#268-配置ipvs功能" class="hash-link" aria-label="2.6.8 配置ipvs功能的直接链接" title="2.6.8 配置ipvs功能的直接链接">​</a></h5><p>在Kubernetes中Service有两种带来模型，一种是基于iptables的，一种是基于ipvs的两者比较的话，ipvs的性能明显要高一些，但是如果要使用它，需要手动载入ipvs模块</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">1.</span><span class="token plain">安装ipset和ipvsadm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># yum install ipset ipvsadmin </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">2.</span><span class="token plain">添加需要加载的模块写入脚本文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># cat </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token constant" style="color:#36acaa">EOF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sysconfig</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">modules</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">ipvs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">modules</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">modprobe </span><span class="token operator" style="color:#393A34">--</span><span class="token plain"> ip_vs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">modprobe </span><span class="token operator" style="color:#393A34">--</span><span class="token plain"> ip_vs_rr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">modprobe </span><span class="token operator" style="color:#393A34">--</span><span class="token plain"> ip_vs_wrr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">modprobe </span><span class="token operator" style="color:#393A34">--</span><span class="token plain"> ip_vs_sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">modprobe </span><span class="token operator" style="color:#393A34">--</span><span class="token plain"> nf_conntrack_ipv4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">3.</span><span class="token plain">为脚本添加执行权限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># chmod </span><span class="token operator" style="color:#393A34">+</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sysconfig</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">modules</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">ipvs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">modules</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">4.</span><span class="token plain">执行脚本文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bash </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sysconfig</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">modeules</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">ipvs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">modules</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">5.</span><span class="token plain">查看对应的模块是否加载成功</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># lsmod </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> grep </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ip_vs </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">e nf_conntrack_ipv4</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="269-安装docker">2.6.9 安装docker<a href="#269-安装docker" class="hash-link" aria-label="2.6.9 安装docker的直接链接" title="2.6.9 安装docker的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">、切换镜像源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># wget https</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mirrors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">aliyun</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">docker</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ce</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">linux</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">centos</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">docker</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ce</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">repo</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">O</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">yum</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">repos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">d</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">docker</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ce</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">repo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">、查看当前镜像源中支持的docker版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># yum list docker</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ce </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">showduplicates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">、安装特定版本的docker</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 必须制定</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">setopt</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">obsoletes</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">，否则yum会自动安装更高版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># yum install </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">setopt</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">obsoletes</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> docker</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ce</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">18.06</span><span class="token number" style="color:#36acaa">.3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">ce</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">el7</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">、添加一个配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token maybe-class-name">Docker</span><span class="token plain"> 在默认情况下使用Vgroup </span><span class="token maybe-class-name">Driver为cgroupfs，而Kubernetes推荐使用systemd来替代cgroupfs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># mkdir </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># cat </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token constant" style="color:#36acaa">EOF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">docker</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">daemon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">&quot;exec-opts&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;native.cgroupdriver=systemd&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">&quot;registry-mirrors&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;https://kn0t2bca.mirror.aliyuncs.com&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">、启动dokcer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># systemctl restart docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># systemctl enable docker</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2610-安装kubernetes组件">2.6.10 安装Kubernetes组件<a href="#2610-安装kubernetes组件" class="hash-link" aria-label="2.6.10 安装Kubernetes组件的直接链接" title="2.6.10 安装Kubernetes组件的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">、由于kubernetes的镜像在国外，速度比较慢，这里切换成国内的镜像源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">、编辑</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">yum</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">repos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">d</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kubernetes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">repo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">添加下面的配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubernetes</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">name</span><span class="token operator" style="color:#393A34">=</span><span class="token maybe-class-name">Kubernetes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">baseurl</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">http</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mirror</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">aliyun</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">yum</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">repos</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">el7</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">x86_64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enabled</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpgchech</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">repo_gpgcheck</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpgkey</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">http</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mirrors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">aliyun</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">yum</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">doc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">yum</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">gpg</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token literal-property property" style="color:#36acaa">http</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mirrors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">aliyun</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">yum</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">doc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rpm</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">package</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">gpg</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">、安装kubeadm、kubelet和kubectl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># yum install </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">setopt</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">obsoletes</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> kubeadm</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.4</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> kubelet</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.4</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> kubectl</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.4</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">、配置kubelet的cgroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#编辑</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sysconfig</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 添加下面的配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">KUBELET_CGROUP_ARGS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;--cgroup-driver=systemd&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">KUBE_PROXY_MODE</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;ipvs&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">、设置kubelet开机自启</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># systemctl enable kubelet</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2611-准备集群镜像">2.6.11 准备集群镜像<a href="#2611-准备集群镜像" class="hash-link" aria-label="2.6.11 准备集群镜像的直接链接" title="2.6.11 准备集群镜像的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 在安装kubernetes集群之前，必须要提前准备好集群需要的镜像，所需镜像可以通过下面命令查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubeadm config images list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 下载镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 此镜像kubernetes的仓库中，由于网络原因，无法连接，下面提供了一种替换方案</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">images</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">apiserver</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">17.4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">controller</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">manager</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">17.4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">scheduler</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">17.4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">proxy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">17.4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">pause</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">3.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">etcd</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">3.4</span><span class="token number" style="color:#36acaa">.3</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">coredns</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.6</span><span class="token number" style="color:#36acaa">.5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> imageName </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">images</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">@</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token keyword control-flow" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    docker pull registry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">cn</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hangzhou</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">aliyuncs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">google_containers</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">$imageName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    docker tag registry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">cn</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hangzhou</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">aliyuncs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">google_containers</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">$imageName k8s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">gcr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">$imageName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    docker rmi registry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">cn</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hangzhou</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">aliyuncs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">google_containers</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">$imageName </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2611-集群初始化">2.6.11 集群初始化<a href="#2611-集群初始化" class="hash-link" aria-label="2.6.11 集群初始化的直接链接" title="2.6.11 集群初始化的直接链接">​</a></h5><p> 下面的操作只需要在master节点上执行即可</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建集群</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubeadm init </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">apiserver</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">advertise</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">address</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">192.168</span><span class="token number" style="color:#36acaa">.90</span><span class="token number" style="color:#36acaa">.100</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">image</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">repository registry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">aliyuncs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">google_containers </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">version</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">17.4</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cidr</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.96</span><span class="token number" style="color:#36acaa">.0</span><span class="token number" style="color:#36acaa">.0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">12</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">network</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cidr</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.0</span><span class="token number" style="color:#36acaa">.0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">16</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建必要文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># mkdir </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">p $</span><span class="token constant" style="color:#36acaa">HOME</span><span class="token operator" style="color:#393A34">/</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">kube</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># sudo cp </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">admin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">conf</span><span class="token plain"> $</span><span class="token constant" style="color:#36acaa">HOME</span><span class="token operator" style="color:#393A34">/</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">kube</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># sudo chown </span><span class="token function" style="color:#d73a49">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">u</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> $</span><span class="token constant" style="color:#36acaa">HOME</span><span class="token operator" style="color:#393A34">/</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">kube</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">config</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> 下面的操作只需要在node节点上执行即可</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm join </span><span class="token number" style="color:#36acaa">192.168</span><span class="token number" style="color:#36acaa">.0</span><span class="token number" style="color:#36acaa">.100</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">6443</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">token awk15p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">t6bamck54w69u4s8</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">discovery</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">token</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ca</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cert</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hash sha256</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">a94fa09562466d32d29523ab6cff122186f1127599fa4dcd5fa0152694f17117 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在master上查看节点信息</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">ROLES</span><span class="token plain">     </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">VERSION</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">master  </span><span class="token maybe-class-name">NotReady</span><span class="token plain">  master   6m    v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">17.4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node1   </span><span class="token maybe-class-name">NotReady</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none  22s   v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">17.4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node2   </span><span class="token maybe-class-name">NotReady</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none  19s   v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">17.4</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2613-安装网络插件只在master节点操作即可">2.6.13 安装网络插件，只在master节点操作即可<a href="#2613-安装网络插件只在master节点操作即可" class="hash-link" aria-label="2.6.13 安装网络插件，只在master节点操作即可的直接链接" title="2.6.13 安装网络插件，只在master节点操作即可的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wget https</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">raw</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">githubusercontent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">coreos</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">flannel</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">master</span><span class="token operator" style="color:#393A34">/</span><span class="token maybe-class-name">Documentation</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">flannel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>由于外网不好访问，如果出现无法访问的情况，可以直接用下面的 记得文件名是kube-flannel.yml，位置：/root/kube-flannel.yml内容：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">https</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">github</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">flannel</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">flannel</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">tree</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">master</span><span class="token operator" style="color:#393A34">/</span><span class="token maybe-class-name">Documentation</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">flannel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>![截屏2021-10-01 下午10.23.00]<!-- -->(images/截屏2021-10-01 下午10.23.00.png)</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2614-使用kubeadm-reset重置集群">2.6.14 使用kubeadm reset重置集群<a href="#2614-使用kubeadm-reset重置集群" class="hash-link" aria-label="2.6.14 使用kubeadm reset重置集群的直接链接" title="2.6.14 使用kubeadm reset重置集群的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#在master节点之外的节点进行操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm reset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl stop kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl stop docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">rf </span><span class="token operator" style="color:#393A34">/</span><span class="token keyword" style="color:#00009f">var</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">cni</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">rf </span><span class="token operator" style="color:#393A34">/</span><span class="token keyword" style="color:#00009f">var</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kubelet</span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">rm -rf /etc/cni/</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">ifconfig cni0 down</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">ifconfig flannel.1 down</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">ifconfig docker0 down</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">ip link delete cni0</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">ip link delete flannel.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">##重启kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">systemctl restart kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">##重启docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">systemctl restart docker</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2615-重启kubelet和docker">2.6.15 重启kubelet和docker<a href="#2615-重启kubelet和docker" class="hash-link" aria-label="2.6.15 重启kubelet和docker的直接链接" title="2.6.15 重启kubelet和docker的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 重启kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 重启docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart docker</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用配置文件启动fannel</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">flannel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>等待它安装完毕 发现已经是 集群的状态已经是Ready</p><p><img loading="lazy" src="https://gitee.com/yooome/golang/raw/main/k8s%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/images/2232696-20210621233106024-1676033717.png" alt="img" class="img_ev3q"></p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2616-kubeadm中的命令">2.6.16 kubeadm中的命令<a href="#2616-kubeadm中的命令" class="hash-link" aria-label="2.6.16 kubeadm中的命令的直接链接" title="2.6.16 kubeadm中的命令的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 生成 新的token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubeadm token create </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">print</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">join</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">command</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="27-集群测试">2.7 集群测试<a href="#27-集群测试" class="hash-link" aria-label="2.7 集群测试的直接链接" title="2.7 集群测试的直接链接">​</a></h4><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="271-创建一个nginx服务">2.7.1 创建一个nginx服务<a href="#271-创建一个nginx服务" class="hash-link" aria-label="2.7.1 创建一个nginx服务的直接链接" title="2.7.1 创建一个nginx服务的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create deployment nginx  </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">image</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.14</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">alpine</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="272-暴露端口">2.7.2 暴露端口<a href="#272-暴露端口" class="hash-link" aria-label="2.7.2 暴露端口的直接链接" title="2.7.2 暴露端口的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl expose deploy nginx  </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">target</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">80</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">type</span><span class="token operator" style="color:#393A34">=</span><span class="token maybe-class-name">NodePort</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="273-查看服务">2.7.3 查看服务<a href="#273-查看服务" class="hash-link" aria-label="2.7.3 查看服务的直接链接" title="2.7.3 查看服务的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">svc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="274-查看pod">2.7.4 查看pod<a href="#274-查看pod" class="hash-link" aria-label="2.7.4 查看pod的直接链接" title="2.7.4 查看pod的直接链接">​</a></h5><p><img loading="lazy" src="https://gitee.com/yooome/golang/raw/main/k8s%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/images/2232696-20210621233130477-111035427.png" alt="img" class="img_ev3q"></p><p>浏览器测试结果：</p><p><img loading="lazy" src="https://gitee.com/yooome/golang/raw/main/k8s%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/images/2232696-20210621233157075-1117518703.png" alt="img" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3-资源管理">3. 资源管理<a href="#3-资源管理" class="hash-link" aria-label="3. 资源管理的直接链接" title="3. 资源管理的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="31-资源管理介绍">3.1 资源管理介绍<a href="#31-资源管理介绍" class="hash-link" aria-label="3.1 资源管理介绍的直接链接" title="3.1 资源管理介绍的直接链接">​</a></h4><p>在kubernetes中，所有的内容都抽象为资源，用户需要通过操作资源来管理kubernetes。</p><p> kubernetes的本质上就是一个集群系统，用户可以在集群中部署各种服务，所谓的部署服务，其实就是在kubernetes集群中运行一个个的容器，并将指定的程序跑在容器中。</p><p> kubernetes的最小管理单元是pod而不是容器，所以只能将容器放在<code>Pod</code>中，而kubernetes一般也不会直接管理Pod，而是通过<code>Pod控制器</code>来管理Pod的。</p><p> Pod可以提供服务之后，就要考虑如何访问Pod中服务，kubernetes提供了<code>Service</code>资源实现这个功能。</p><p> 当然，如果Pod中程序的数据需要持久化，kubernetes还提供了各种<code>存储</code>系统。</p><p><img loading="lazy" alt="image-20200406225334627" src="/blog/assets/images/image-20200406225334627-5ddaad8f206467d99804670770f5683f.png" width="1211" height="662" class="img_ev3q"></p><p> 学习kubernetes的核心，就是学习如何对集群上的<code>Pod、Pod控制器、Service、存储</code>等各种资源进行操作</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="32-yaml语言介绍">3.2 YAML语言介绍<a href="#32-yaml语言介绍" class="hash-link" aria-label="3.2 YAML语言介绍的直接链接" title="3.2 YAML语言介绍的直接链接">​</a></h4><p>YAML是一个类似 XML、JSON 的标记性语言。它强调以<strong>数据</strong>为中心，并不是以标识语言为重点。因而YAML本身的定义比较简单，号称&quot;一种人性化的数据格式语言&quot;。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">heima</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">age15</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">age</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">addressBeijing</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">heima</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">heima</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">age</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">address</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Beijing</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>YAML的语法比较简单，主要有下面几个：</p></li><li><p>大小写敏感</p></li><li><p>使用缩进表示层级关系</p></li><li><p>缩进不允许使用tab，只允许空格( 低版本限制 )</p></li><li><p>缩进的空格数不重要，只要相同层级的元素左对齐即可</p></li><li><p>&#x27;#&#x27;表示注释</p><p>YAML支持以下几种数据类型：</p></li><li><p>纯量：单个的、不可再分的值</p></li><li><p>对象：键值对的集合，又称为映射（mapping）/ 哈希（hash） / 字典（dictionary）</p></li><li><p>数组：一组按次序排列的值，又称为序列（sequence） / 列表（list）</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 纯量</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 就是指的一个简单的值，字符串、布尔值、整数、浮点数、Null、时间、日期</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> 布尔类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">c1</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">或者True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> 整型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">c2</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">234</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> 浮点型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">c3</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3.14</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token plain">类型 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">c4</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token plain">  # 使用</span><span class="token operator" style="color:#393A34">~</span><span class="token plain">表示</span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> 日期类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">c5</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2018</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">02</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">17</span><span class="token plain">    # 日期必须使用</span><span class="token constant" style="color:#36acaa">ISO</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8601</span><span class="token plain">格式，即yyyy</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">MM</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> 时间类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">c6</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2018</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">02</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">17T15</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">02</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">31</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">08</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">00</span><span class="token plain">  # 时间使用</span><span class="token constant" style="color:#36acaa">ISO</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8601</span><span class="token plain">格式，时间和日期之间使用</span><span class="token constant" style="color:#36acaa">T</span><span class="token plain">连接，最后使用</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">代表时区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> 字符串类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">c7</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> heima     # 简单写法，直接写值 </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 如果字符串中间有特殊字符，必须使用双引号或者单引号包裹 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">c8</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> line1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    line2     # 字符串过多的情况可以拆成多行，每一行会被转化成一个空格</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token function" style="color:#d73a49">形式一</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">推荐</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">heima</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">age</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">address</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Beijing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token function" style="color:#d73a49">形式二</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">了解</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">heima</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token literal-property property" style="color:#36acaa">age</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">15</span><span class="token punctuation" style="color:#393A34">,</span><span class="token literal-property property" style="color:#36acaa">address</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Beijing</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 数组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token function" style="color:#d73a49">形式一</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">推荐</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">address</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> 顺义</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> 昌平  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token function" style="color:#d73a49">形式二</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">了解</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">address</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">顺义</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">昌平</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> 小提示：</p><p> 1 书写yaml切记<code>:</code> 后面要加一个空格</p><p> 2 如果需要将多段yaml配置放在一个文件中，中间要使用<code>---</code>分隔</p><p> 3 下面是一个yaml转json的网站，可以通过它验证yaml是否书写正确</p><p> <a href="https://www.json2yaml.com/convert-yaml-to-json" target="_blank" rel="noopener noreferrer">https://www.json2yaml.com/convert-yaml-to-json</a></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="33-资源管理方式">3.3 资源管理方式<a href="#33-资源管理方式" class="hash-link" aria-label="3.3 资源管理方式的直接链接" title="3.3 资源管理方式的直接链接">​</a></h4></li><li><p>命令式对象管理：直接使用命令去操作kubernetes资源</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl run nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">image</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>命令式对象配置：通过命令配置和配置文件去操作kubernetes资源</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">patch </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>声明式对象配置：通过apply命令和配置文件去操作kubernetes资源</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><table><thead><tr><th>类型</th><th>操作对象</th><th>适用环境</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>命令式对象管理</td><td>对象</td><td>测试</td><td>简单</td><td>只能操作活动对象，无法审计、跟踪</td></tr><tr><td>命令式对象配置</td><td>文件</td><td>开发</td><td>可以审计、跟踪</td><td>项目大时，配置文件多，操作麻烦</td></tr><tr><td>声明式对象配置</td><td>目录</td><td>开发</td><td>支持目录操作</td><td>意外情况下难以调试</td></tr></tbody></table><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="331-命令式对象管理">3.3.1 命令式对象管理<a href="#331-命令式对象管理" class="hash-link" aria-label="3.3.1 命令式对象管理的直接链接" title="3.3.1 命令式对象管理的直接链接">​</a></h5><p><strong>kubectl命令</strong></p><p>kubectl是kubernetes集群的命令行工具，通过它能够对集群本身进行管理，并能够在集群上进行容器化应用的安装部署。kubectl命令的语法如下：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">command</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>comand</strong>：指定要对资源执行的操作，例如create、get、delete</p><p><strong>type</strong>：指定资源类型，比如deployment、pod、service</p><p><strong>name</strong>：指定资源的名称，名称大小写敏感</p><p><strong>flags</strong>：指定额外的可选参数</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 查看所有pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pod </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看某个pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pod pod_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看某个pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">以yaml格式展示结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pod pod_name </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>资源类型</strong></p><p>kubernetes中所有的内容都抽象为资源，可以通过下面的命令进行查看:</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl api</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">resources</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>经常使用的资源有下面这些：</p><table><thead><tr><th>资源分类</th><th>资源名称</th><th>缩写</th><th>资源作用</th></tr></thead><tbody><tr><td>集群级别资源</td><td>nodes</td><td>no</td><td>集群组成部分</td></tr><tr><td>namespaces</td><td>ns</td><td>隔离Pod</td><td></td></tr><tr><td>pod资源</td><td>pods</td><td>po</td><td>装载容器</td></tr><tr><td>pod资源控制器</td><td>replicationcontrollers</td><td>rc</td><td>控制pod资源</td></tr><tr><td></td><td>replicasets</td><td>rs</td><td>控制pod资源</td></tr><tr><td></td><td>deployments</td><td>deploy</td><td>控制pod资源</td></tr><tr><td></td><td>daemonsets</td><td>ds</td><td>控制pod资源</td></tr><tr><td></td><td>jobs</td><td></td><td>控制pod资源</td></tr><tr><td></td><td>cronjobs</td><td>cj</td><td>控制pod资源</td></tr><tr><td></td><td>horizontalpodautoscalers</td><td>hpa</td><td>控制pod资源</td></tr><tr><td></td><td>statefulsets</td><td>sts</td><td>控制pod资源</td></tr><tr><td>服务发现资源</td><td>services</td><td>svc</td><td>统一pod对外接口</td></tr><tr><td></td><td>ingress</td><td>ing</td><td>统一pod对外接口</td></tr><tr><td>存储资源</td><td>volumeattachments</td><td></td><td>存储</td></tr><tr><td></td><td>persistentvolumes</td><td>pv</td><td>存储</td></tr><tr><td></td><td>persistentvolumeclaims</td><td>pvc</td><td>存储</td></tr><tr><td>配置资源</td><td>configmaps</td><td>cm</td><td>配置</td></tr><tr><td></td><td>secrets</td><td></td><td>配置</td></tr></tbody></table><p><strong>操作</strong></p><p>kubernetes允许对资源进行多种操作，可以通过--help查看详细的操作命令</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">help</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>经常使用的操作有下面这些：</p><table><thead><tr><th>命令分类</th><th>命令</th><th>翻译</th><th>命令作用</th></tr></thead><tbody><tr><td>基本命令</td><td>create</td><td>创建</td><td>创建一个资源</td></tr><tr><td></td><td>edit</td><td>编辑</td><td>编辑一个资源</td></tr><tr><td></td><td>get</td><td>获取</td><td>获取一个资源</td></tr><tr><td></td><td>patch</td><td>更新</td><td>更新一个资源</td></tr><tr><td></td><td>delete</td><td>删除</td><td>删除一个资源</td></tr><tr><td></td><td>explain</td><td>解释</td><td>展示资源文档</td></tr><tr><td>运行和调试</td><td>run</td><td>运行</td><td>在集群中运行一个指定的镜像</td></tr><tr><td></td><td>expose</td><td>暴露</td><td>暴露资源为Service</td></tr><tr><td></td><td>describe</td><td>描述</td><td>显示资源内部信息</td></tr><tr><td></td><td>logs</td><td>日志输出容器在 pod 中的日志</td><td>输出容器在 pod 中的日志</td></tr><tr><td></td><td>attach</td><td>缠绕进入运行中的容器</td><td>进入运行中的容器</td></tr><tr><td></td><td>exec</td><td>执行容器中的一个命令</td><td>执行容器中的一个命令</td></tr><tr><td></td><td>cp</td><td>复制</td><td>在Pod内外复制文件</td></tr><tr><td></td><td>rollout</td><td>首次展示</td><td>管理资源的发布</td></tr><tr><td></td><td>scale</td><td>规模</td><td>扩(缩)容Pod的数量</td></tr><tr><td></td><td>autoscale</td><td>自动调整</td><td>自动调整Pod的数量</td></tr><tr><td>高级命令</td><td>apply</td><td>rc</td><td>通过文件对资源进行配置</td></tr><tr><td></td><td>label</td><td>标签</td><td>更新资源上的标签</td></tr><tr><td>其他命令</td><td>cluster-info</td><td>集群信息</td><td>显示集群信息</td></tr><tr><td></td><td>version</td><td>版本</td><td>显示当前Server和Client的版本</td></tr></tbody></table><p>下面以一个namespace / pod的创建和删除简单演示下命令的使用：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建一个namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create namespace dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dev created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 获取namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">              </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">default</span><span class="token plain">           </span><span class="token maybe-class-name">Active</span><span class="token plain">   21h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dev               </span><span class="token maybe-class-name">Active</span><span class="token plain">   21s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">node</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lease   </span><span class="token maybe-class-name">Active</span><span class="token plain">   21h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">public</span><span class="token plain">       </span><span class="token maybe-class-name">Active</span><span class="token plain">   21h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">system       </span><span class="token maybe-class-name">Active</span><span class="token plain">   21h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 在此namespace下创建并运行一个nginx的Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl run pod </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">image</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">latest </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl run </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">generator</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">apps</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">v1</span><span class="token plain"> is </span><span class="token constant" style="color:#36acaa">DEPRECATED</span><span class="token plain"> and will be removed </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> a future version</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token property-access maybe-class-name">Use</span><span class="token plain"> kubectl run </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">generator</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">run</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1 or kubectl create instead</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property-access">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pod created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看新创建的pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">  </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          21s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 删除指定的pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> pod pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">864f9875b9</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pcw7x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod </span><span class="token string" style="color:#e3116c">&quot;pod&quot;</span><span class="token plain"> deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 删除指定的namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> ns dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace </span><span class="token string" style="color:#e3116c">&quot;dev&quot;</span><span class="token plain"> deleted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="332-命令式对象配置">3.3.2 命令式对象配置<a href="#332-命令式对象配置" class="hash-link" aria-label="3.3.2 命令式对象配置的直接链接" title="3.3.2 命令式对象配置的直接链接">​</a></h3><p>命令式对象配置就是使用命令配合配置文件一起来操作kubernetes资源。</p><p>1） 创建一个nginxpod.yaml，内容如下：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Namespace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginxpod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">containers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">latest</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2）执行create命令，创建资源：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f nginxpod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dev created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nginxpod created</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此时发现创建了两个资源对象，分别是namespace和pod</p><p>3）执行get命令，查看资源：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">#  kubectl get </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f nginxpod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">            </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dev   </span><span class="token maybe-class-name">Active</span><span class="token plain">   18s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">            </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nginxpod    </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          17s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这样就显示了两个资源对象的信息</p><p>4）执行delete命令，删除资源：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f nginxpod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace </span><span class="token string" style="color:#e3116c">&quot;dev&quot;</span><span class="token plain"> deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod </span><span class="token string" style="color:#e3116c">&quot;nginxpod&quot;</span><span class="token plain"> deleted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此时发现两个资源对象被删除了</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">总结</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    命令式对象配置的方式操作资源，可以简单的认为：命令  </span><span class="token operator" style="color:#393A34">+</span><span class="token plain">  yaml配置文件（里面是命令需要的各种参数）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="333-声明式对象配置">3.3.3 声明式对象配置<a href="#333-声明式对象配置" class="hash-link" aria-label="3.3.3 声明式对象配置的直接链接" title="3.3.3 声明式对象配置的直接链接">​</a></h3><p>声明式对象配置跟命令式对象配置很相似，但是它只有一个命令apply。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 首先执行一次kubectl apply </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f yaml文件，发现创建了资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">#  kubectl apply </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f nginxpod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dev created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nginxpod created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 再次执行一次kubectl apply </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f yaml文件，发现说资源没有变动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">#  kubectl apply </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f nginxpod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dev unchanged</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nginxpod unchanged</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">总结</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    其实声明式对象配置就是使用apply描述一个资源最终的状态（在yaml中定义状态）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    使用apply操作资源：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        如果资源不存在，就创建，相当于 kubectl create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        如果资源已存在，就更新，相当于 kubectl patch</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> 扩展：kubectl可以在node节点上运行吗 ?</p><p>kubectl的运行是需要进行配置的，它的配置文件是$HOME/.kube，如果想要在node节点运行此命令，需要将master上的.kube文件复制到node节点上，即在master节点上执行下面操作：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">scp  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">r  </span><span class="token constant" style="color:#36acaa">HOME</span><span class="token operator" style="color:#393A34">/</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">kube</span><span class="token plain">   node1</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">HOME</span><span class="token operator" style="color:#393A34">/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> 使用推荐: 三种方式应该怎么用 ?</p><p>创建/更新资源 使用声明式对象配置 kubectl apply -f XXX.yaml</p><p>删除资源 使用命令式对象配置 kubectl delete -f XXX.yaml</p><p>查询资源 使用命令式对象管理 kubectl get(describe) 资源名称</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4-实战入门">4. 实战入门<a href="#4-实战入门" class="hash-link" aria-label="4. 实战入门的直接链接" title="4. 实战入门的直接链接">​</a></h3><p>本章节将介绍如何在kubernetes集群中部署一个nginx服务，并且能够对其进行访问。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="41-namespace">4.1 Namespace<a href="#41-namespace" class="hash-link" aria-label="4.1 Namespace的直接链接" title="4.1 Namespace的直接链接">​</a></h4><p>Namespace是kubernetes系统中的一种非常重要资源，它的主要作用是用来实现<strong>多套环境的资源隔离</strong>或者<strong>多租户的资源隔离</strong>。</p><p>默认情况下，kubernetes集群中的所有的Pod都是可以相互访问的。但是在实际中，可能不想让两个Pod之间进行互相的访问，那此时就可以将两个Pod划分到不同的namespace下。kubernetes通过将集群内部的资源分配到不同的Namespace中，可以形成逻辑上的&quot;组&quot;，以方便不同的组的资源进行隔离使用和管理。</p><p>可以通过kubernetes的授权机制，将不同的namespace交给不同租户进行管理，这样就实现了多租户的资源隔离。此时还能结合kubernetes的资源配额机制，限定不同租户能占用的资源，例如CPU使用量、内存使用量等等，来实现租户可用资源的管理。</p><p><img loading="lazy" alt="image-20200407100850484" src="/blog/assets/images/image-20200407100850484-83fec7a58d334cadd6219e6dde5211ab.png" width="1097" height="572" class="img_ev3q"></p><p>kubernetes在集群启动之后，会默认创建几个namespace</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl  </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">              </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">default</span><span class="token plain">           </span><span class="token maybe-class-name">Active</span><span class="token plain">   45h     #  所有未指定Namespace的对象都会被分配在</span><span class="token keyword module" style="color:#00009f">default</span><span class="token plain">命名空间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">node</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lease   </span><span class="token maybe-class-name">Active</span><span class="token plain">   45h     #  集群节点之间的心跳维护，v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">13</span><span class="token plain">开始引入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">public</span><span class="token plain">       </span><span class="token maybe-class-name">Active</span><span class="token plain">   45h     #  此命名空间下的资源可以被所有人访问（包括未认证用户）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">system       </span><span class="token maybe-class-name">Active</span><span class="token plain">   45h     #  所有由Kubernetes系统创建的资源都处于这个命名空间</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>下面来看namespace资源的具体操作：</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="411-查看">4.1.1 <strong>查看</strong><a href="#411-查看" class="hash-link" aria-label="411-查看的直接链接" title="411-查看的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> 查看所有的ns  命令：kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">              </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">default</span><span class="token plain">           </span><span class="token maybe-class-name">Active</span><span class="token plain">   45h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">node</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lease   </span><span class="token maybe-class-name">Active</span><span class="token plain">   45h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">public</span><span class="token plain">       </span><span class="token maybe-class-name">Active</span><span class="token plain">   45h     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">system       </span><span class="token maybe-class-name">Active</span><span class="token plain">   45h     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> 查看指定的ns   命令：kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> ns ns名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> ns </span><span class="token keyword module" style="color:#00009f">default</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">      </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">default</span><span class="token plain">   </span><span class="token maybe-class-name">Active</span><span class="token plain">   45h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> 指定输出格式  命令：kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> ns ns名称  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o 格式参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># kubernetes支持的格式有很多，比较常见的是wide、json、yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> ns </span><span class="token keyword module" style="color:#00009f">default</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Namespace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">creationTimestamp</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2021-05-08T04:44:16Z&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">default</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">resourceVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;151&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">selfLink</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">api</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">namespaces</span><span class="token operator" style="color:#393A34">/</span><span class="token keyword module" style="color:#00009f">default</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">uid</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> 7405f73a</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">e486</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">43d4</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">9db6</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">145f1409f090</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">finalizers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">status</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">phase</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Active</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> 查看ns详情  命令：kubectl describe ns ns名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl describe ns </span><span class="token keyword module" style="color:#00009f">default</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">         </span><span class="token keyword module" style="color:#00009f">default</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">       </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Annotations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Status</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">       </span><span class="token maybe-class-name">Active</span><span class="token plain">  # </span><span class="token maybe-class-name">Active</span><span class="token plain"> 命名空间正在使用中  </span><span class="token maybe-class-name">Terminating</span><span class="token plain"> 正在删除命名空间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token maybe-class-name">ResourceQuota</span><span class="token plain"> 针对namespace做的资源限制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token maybe-class-name">LimitRange针对namespace中的每个组件做的资源限制</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">No</span><span class="token plain"> resource quota</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property-access maybe-class-name">No</span><span class="token plain"> </span><span class="token maybe-class-name">LimitRange</span><span class="token plain"> resource</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="412-创建">4.1.2 <strong>创建</strong><a href="#412-创建" class="hash-link" aria-label="412-创建的直接链接" title="412-创建的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create ns dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dev created</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="413-删除">4.1.3 <strong>删除</strong><a href="#413-删除" class="hash-link" aria-label="413-删除的直接链接" title="413-删除的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 删除namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> ns dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace </span><span class="token string" style="color:#e3116c">&quot;dev&quot;</span><span class="token plain"> deleted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="414-配置方式">4.1.4 <strong>配置方式</strong><a href="#414-配置方式" class="hash-link" aria-label="414-配置方式的直接链接" title="414-配置方式的直接链接">​</a></h5><p>首先准备一个yaml文件：ns-dev.yaml</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Namespace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后就可以执行对应的创建和删除命令了：</p><p>创建：kubectl create -f ns-dev.yaml</p><p>删除：kubectl delete -f ns-dev.yaml</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="42-pod">4.2 Pod<a href="#42-pod" class="hash-link" aria-label="4.2 Pod的直接链接" title="4.2 Pod的直接链接">​</a></h4><p>Pod是kubernetes集群进行管理的最小单元，程序要运行必须部署在容器中，而容器必须存在于Pod中。</p><p>Pod可以认为是容器的封装，一个Pod中可以存在一个或者多个容器。</p><p><img loading="lazy" alt="image-20200407121501907" src="/blog/assets/images/image-20200407121501907-697ca688e34b7d0d92284682633b5d44.png" width="633" height="464" class="img_ev3q"></p><p>kubernetes在集群启动之后，集群中的各个组件也都是以Pod方式运行的。可以通过下面命令查看：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAMESPACE</span><span class="token plain">     </span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                             </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">system   coredns</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6955765f44</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">68g6v         </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2d1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">system   coredns</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6955765f44</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cs5r8         </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2d1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">system   etcd</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master                      </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2d1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">system   kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">apiserver</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master            </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2d1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">system   kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">controller</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">manager</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2d1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">system   kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">flannel</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ds</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">amd64</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">47r25      </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2d1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">system   kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">flannel</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ds</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">amd64</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ls5lh      </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2d1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">system   kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">proxy</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">685tk                 </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2d1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">system   kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">proxy</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">87spt                 </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2d1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">system   kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">scheduler</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master            </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2d1h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="421-创建并运行">4.2.1 创建并运行<a href="#421-创建并运行" class="hash-link" aria-label="4.2.1 创建并运行的直接链接" title="4.2.1 创建并运行的直接链接">​</a></h5><p>kubernetes没有提供单独运行Pod的命令，都是通过Pod控制器来实现的</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 命令格式： kubectl </span><span class="token function" style="color:#d73a49">run</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pod控制器名称</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">参数</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">image  指定Pod的镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">port   指定端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">namespace  指定namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl run nginx </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">image</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">latest </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">namespace dev </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nginx created</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="422-查看pod信息">4.2.2 查看pod信息<a href="#422-查看pod信息" class="hash-link" aria-label="4.2.2 查看pod信息的直接链接" title="4.2.2 查看pod信息的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 查看Pod基本信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          43s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看Pod的详细信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl describe pod nginx </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">         nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">    dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Priority</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Node</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">         node1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">192.168</span><span class="token number" style="color:#36acaa">.5</span><span class="token number" style="color:#36acaa">.4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Start</span><span class="token plain"> </span><span class="token maybe-class-name">Time</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">   </span><span class="token maybe-class-name">Wed</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">08</span><span class="token plain"> </span><span class="token maybe-class-name">May</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">09</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">29</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">24</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0800</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">       pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">template</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hash</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">5ff7956ff6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              run</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Annotations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Status</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">       </span><span class="token maybe-class-name">Running</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">IP</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.23</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">IPs</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">IP</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.23</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Controlled</span><span class="token plain"> </span><span class="token maybe-class-name">By</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  </span><span class="token maybe-class-name">ReplicaSet</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token maybe-class-name">Container</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">   docker</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">4c62b8c0648d2512380f4ffa5da2c99d16e05634979973449c98e9b829f6253c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">Image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">          nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token maybe-class-name">Image</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">       docker</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pullable</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nginx@sha256</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">485b610fefec7ff6c463ced9623314a04ed67e3945b9c08d7e53a47f6d108dc7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">Port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">80</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token maybe-class-name">Host</span><span class="token plain"> </span><span class="token maybe-class-name">Port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">State</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">          </span><span class="token maybe-class-name">Running</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">Started</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">      </span><span class="token maybe-class-name">Wed</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">08</span><span class="token plain"> </span><span class="token maybe-class-name">May</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">09</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">30</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">01</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0800</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">Ready</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">          </span><span class="token maybe-class-name">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token maybe-class-name">Restart</span><span class="token plain"> </span><span class="token maybe-class-name">Count</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">Environment</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">Mounts</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">/</span><span class="token keyword" style="color:#00009f">var</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">run</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">secrets</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kubernetes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">serviceaccount </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">token</span><span class="token operator" style="color:#393A34">-</span><span class="token function" style="color:#d73a49">hwvvw</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ro</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Conditions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Type</span><span class="token plain">              </span><span class="token maybe-class-name">Status</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Initialized</span><span class="token plain">       </span><span class="token maybe-class-name">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Ready</span><span class="token plain">             </span><span class="token maybe-class-name">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">ContainersReady</span><span class="token plain">   </span><span class="token maybe-class-name">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">PodScheduled</span><span class="token plain">      </span><span class="token maybe-class-name">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Volumes</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword module" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">token</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hwvvw</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">Type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">        </span><span class="token function maybe-class-name" style="color:#d73a49">Secret</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a volume populated by a </span><span class="token maybe-class-name">Secret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">SecretName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  </span><span class="token keyword module" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">token</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hwvvw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">Optional</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">    </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">QoS</span><span class="token plain"> </span><span class="token maybe-class-name">Class</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">       </span><span class="token maybe-class-name">BestEffort</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Node</span><span class="token operator" style="color:#393A34">-</span><span class="token maybe-class-name">Selectors</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Tolerations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">     node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">kubernetes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">not</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ready</span><span class="token operator" style="color:#393A34">:</span><span class="token maybe-class-name">NoExecute</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> 300s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">kubernetes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">unreachable</span><span class="token operator" style="color:#393A34">:</span><span class="token maybe-class-name">NoExecute</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> 300s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Events</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Type</span><span class="token plain">    </span><span class="token maybe-class-name">Reason</span><span class="token plain">     </span><span class="token maybe-class-name">Age</span><span class="token plain">        </span><span class="token maybe-class-name">From</span><span class="token plain">               </span><span class="token maybe-class-name">Message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">       </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">               </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">  </span><span class="token maybe-class-name">Scheduled</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">unknown  </span><span class="token keyword module" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">scheduler  </span><span class="token maybe-class-name">Successfully</span><span class="token plain"> assigned dev</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">5ff7956ff6</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">fg2db to node1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">  </span><span class="token maybe-class-name">Pulling</span><span class="token plain">    4m11s      kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Pulling</span><span class="token plain"> image </span><span class="token string" style="color:#e3116c">&quot;nginx:latest&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">  </span><span class="token maybe-class-name">Pulled</span><span class="token plain">     3m36s      kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Successfully</span><span class="token plain"> pulled image </span><span class="token string" style="color:#e3116c">&quot;nginx:latest&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">  </span><span class="token maybe-class-name">Created</span><span class="token plain">    3m36s      kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Created</span><span class="token plain"> container nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">  </span><span class="token maybe-class-name">Started</span><span class="token plain">    3m36s      kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Started</span><span class="token plain"> container nginx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="423-访问pod">4.2.3 访问Pod<a href="#423-访问pod" class="hash-link" aria-label="4.2.3 访问Pod的直接链接" title="4.2.3 访问Pod的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 获取podIP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">             </span><span class="token constant" style="color:#36acaa">NODE</span><span class="token plain">    </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          190s   </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.23</span><span class="token plain">   node1   </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#访问</span><span class="token constant" style="color:#36acaa">POD</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># curl http</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.23</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">!</span><span class="token constant" style="color:#36acaa">DOCTYPE</span><span class="token plain"> html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">head</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">titleWelcome to nginx</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">title</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">head</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">p</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">emThank you </span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> using nginx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">em</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">html</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="424-删除指定pod">4.2.4 删除指定Pod<a href="#424-删除指定pod" class="hash-link" aria-label="4.2.4 删除指定Pod的直接链接" title="4.2.4 删除指定Pod的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 删除指定Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> pod nginx </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod </span><span class="token string" style="color:#e3116c">&quot;nginx&quot;</span><span class="token plain"> deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 此时，显示删除Pod成功，但是再查询，发现又新产生了一个 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          21s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 这是因为当前Pod是由Pod控制器创建的，控制器会监控Pod状况，一旦发现Pod死亡，会立即重建</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 此时要想删除Pod，必须删除Pod控制器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 先来查询一下当前namespace下的Pod控制器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> deploy </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n  dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">UP</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">TO</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">DATE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AVAILABLE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           9m7s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 接下来，删除此PodPod控制器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> deploy nginx </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;nginx&quot;</span><span class="token plain"> deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 稍等片刻，再查询Pod，发现Pod被删除了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">No</span><span class="token plain"> resources found </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> dev namespace</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="425-配置操作">4.2.5 配置操作<a href="#425-配置操作" class="hash-link" aria-label="4.2.5 配置操作的直接链接" title="4.2.5 配置操作的直接链接">​</a></h5><p>创建一个pod-nginx.yaml，内容如下：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containerPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">protocol</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TCP</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后就可以执行对应的创建和删除命令了：</p><p>创建：kubectl create -f pod-nginx.yaml</p><p>删除：kubectl delete -f pod-nginx.yaml</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="43-label">4.3 Label<a href="#43-label" class="hash-link" aria-label="4.3 Label的直接链接" title="4.3 Label的直接链接">​</a></h4><p>Label是kubernetes系统中的一个重要概念。它的作用就是在资源上添加标识，用来对它们进行区分和选择。</p><p>Label的特点：</p></li><li><p>一个Label会以key/value键值对的形式附加到各种对象上，如Node、Pod、Service等等</p></li><li><p>一个资源对象可以定义任意数量的Label ，同一个Label也可以被添加到任意数量的资源对象上去</p></li><li><p>Label通常在资源对象定义时确定，当然也可以在对象创建后动态添加或者删除</p><p>可以通过Label实现资源的多维度分组，以便灵活、方便地进行资源分配、调度、配置、部署等管理工作。</p><p> 一些常用的Label 示例如下：</p></li><li><p>版本标签：&quot;version&quot;:&quot;release&quot;, &quot;version&quot;:&quot;stable&quot;......</p></li><li><p>环境标签：&quot;environment&quot;:&quot;dev&quot;，&quot;environment&quot;:&quot;test&quot;，&quot;environment&quot;:&quot;pro&quot;</p></li><li><p>架构标签：&quot;tier&quot;:&quot;frontend&quot;，&quot;tier&quot;:&quot;backend&quot;</p><p>标签定义完毕之后，还要考虑到标签的选择，这就要使用到Label Selector，即：</p><p>Label用于给某个资源对象定义标识</p><p>Label Selector用于查询和筛选拥有某些标签的资源对象</p><p>当前有两种Label Selector：</p></li><li><p>基于等式的Label Selector</p><p>name = slave: 选择所有包含Label中key=&quot;name&quot;且value=&quot;slave&quot;的对象</p><p>env != production: 选择所有包括Label中的key=&quot;env&quot;且value不等于&quot;production&quot;的对象</p></li><li><p>基于集合的Label Selector</p><p>  name in (master, slave): 选择所有包含Label中的key=&quot;name&quot;且value=&quot;master&quot;或&quot;slave&quot;的对象</p><p>  name not in (frontend): 选择所有包含Label中的key=&quot;name&quot;且value不等于&quot;frontend&quot;的对象</p><p>标签的选择条件可以使用多个，此时将多个Label Selector进行组合，使用逗号&quot;,&quot;进行分隔即可。例如：</p><p>name=slave，env!=production</p><p>name not in (frontend)，env!=production</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="431-命令方式">4.3.1 命令方式<a href="#431-命令方式" class="hash-link" aria-label="4.3.1 命令方式的直接链接" title="4.3.1 命令方式的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 为pod资源打标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl label pod nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod version</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1.0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod labeled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 为pod资源更新标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl label pod nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod version</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2.0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">overwrite</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod labeled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pod nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">show</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">        </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">LABELS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          10m   version</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 筛选标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">l version</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2.0</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">show</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">        </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">LABELS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          17m   version</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">l version</span><span class="token operator" style="color:#393A34">!=</span><span class="token number" style="color:#36acaa">2.0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">show</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">No</span><span class="token plain"> resources found </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> dev namespace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property-access">#删除标签</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl label pod nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod version</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod labeled</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="432-配置方式">4.3.2 配置方式<a href="#432-配置方式" class="hash-link" aria-label="4.3.2 配置方式的直接链接" title="4.3.2 配置方式的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">version</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;3.0&quot;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">env</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;test&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containerPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">protocol</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TCP</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后就可以执行对应的更新命令了：kubectl apply -f pod-nginx.yaml</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="44-deployment">4.4 Deployment<a href="#44-deployment" class="hash-link" aria-label="4.4 Deployment的直接链接" title="4.4 Deployment的直接链接">​</a></h4><p>在kubernetes中，Pod是最小的控制单元，但是kubernetes很少直接控制Pod，一般都是通过Pod控制器来完成的。Pod控制器用于pod的管理，确保pod资源符合预期的状态，当pod的资源出现故障时，会尝试进行重启或重建pod。</p><p>在kubernetes中Pod控制器的种类有很多，本章节只介绍一种：Deployment。</p><p><img loading="lazy" alt="image-20200408193950807" src="/blog/assets/images/image-20200408193950807-62ab097e9ba92ed09770eebcd90d3f85.png" width="765" height="418" class="img_ev3q"></p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="441-命令操作">4.4.1 命令操作<a href="#441-命令操作" class="hash-link" aria-label="4.4.1 命令操作的直接链接" title="4.4.1 命令操作的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 命令格式</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> kubectl create deployment 名称  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">参数</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">image  指定pod的镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">port   指定端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">replicas  指定创建pod数量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">namespace  指定namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl run nginx </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">image</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">latest </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">replicas</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nginx created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看创建的Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                     </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">5ff7956ff6</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6k8cb   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          19s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">5ff7956ff6</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">jxfjt   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          19s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">5ff7956ff6</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v6jqw   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          19s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看deployment的信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> deploy </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">UP</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">TO</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">DATE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AVAILABLE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx   </span><span class="token number" style="color:#36acaa">3</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">3</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">           2m42s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token constant" style="color:#36acaa">UP</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">TO</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">DATE</span><span class="token plain">：成功升级的副本数量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token constant" style="color:#36acaa">AVAILABLE</span><span class="token plain">：可用副本的数量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> deploy </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UP</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">TO</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">DATE</span><span class="token plain">  </span><span class="token constant" style="color:#36acaa">AVAILABLE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">     </span><span class="token constant" style="color:#36acaa">CONTAINERS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">IMAGES</span><span class="token plain">              </span><span class="token constant" style="color:#36acaa">SELECTOR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx   </span><span class="token number" style="color:#36acaa">3</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">3</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">           2m51s   nginx        nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">latest        run</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看deployment的详细信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl describe deploy nginx </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">                   nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">              dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">CreationTimestamp</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">      </span><span class="token maybe-class-name">Wed</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">08</span><span class="token plain"> </span><span class="token maybe-class-name">May</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">14</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">14</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0800</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">                 run</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Annotations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">            deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">kubernetes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">revision</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">               run</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Replicas</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">               </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> desired </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> updated </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> total </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> available </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> unavailable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">StrategyType</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">           </span><span class="token maybe-class-name">RollingUpdate</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">MinReadySeconds</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">RollingUpdateStrategy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">25</span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> max unavailable</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">25</span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> max surge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Pod</span><span class="token plain"> </span><span class="token maybe-class-name">Template</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">Labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  run</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">Containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">Image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">        nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">Port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">80</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token maybe-class-name">Host</span><span class="token plain"> </span><span class="token maybe-class-name">Port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">Environment</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">Mounts</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">       </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">Volumes</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Conditions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Type</span><span class="token plain">           </span><span class="token maybe-class-name">Status</span><span class="token plain">  </span><span class="token maybe-class-name">Reason</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">           </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Available</span><span class="token plain">      </span><span class="token maybe-class-name">True</span><span class="token plain">    </span><span class="token maybe-class-name">MinimumReplicasAvailable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Progressing</span><span class="token plain">    </span><span class="token maybe-class-name">True</span><span class="token plain">    </span><span class="token maybe-class-name">NewReplicaSetAvailable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">OldReplicaSets</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">NewReplicaSet</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">   nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">5</span><span class="token function" style="color:#d73a49">ff7956ff6</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> replicas created</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Events</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Type</span><span class="token plain">    </span><span class="token maybe-class-name">Reason</span><span class="token plain">             </span><span class="token maybe-class-name">Age</span><span class="token plain">    </span><span class="token maybe-class-name">From</span><span class="token plain">                   </span><span class="token maybe-class-name">Message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">             </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">                   </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">  </span><span class="token maybe-class-name">ScalingReplicaSet</span><span class="token plain">  5m43s  deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">controller  </span><span class="token maybe-class-name">Scaled</span><span class="token plain"> up replicaset nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">5ff7956ff6 to </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 删除 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> deploy nginx </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;nginx&quot;</span><span class="token plain"> deleted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="442-配置操作">4.4.2 配置操作<a href="#442-配置操作" class="hash-link" aria-label="4.4.2 配置操作的直接链接" title="4.4.2 配置操作的直接链接">​</a></h5><p>创建一个deploy-nginx.yaml，内容如下：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Deployment</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">replicas</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">matchLabels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">run</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">template</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">run</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> containerPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token literal-property property" style="color:#36acaa">protocol</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TCP</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后就可以执行对应的创建和删除命令了：</p><p>创建：kubectl create -f deploy-nginx.yaml</p><p>删除：kubectl delete -f deploy-nginx.yaml</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="45-service">4.5 Service<a href="#45-service" class="hash-link" aria-label="4.5 Service的直接链接" title="4.5 Service的直接链接">​</a></h4><p>通过上节课的学习，已经能够利用Deployment来创建一组Pod来提供具有高可用性的服务。</p><p>虽然每个Pod都会分配一个单独的Pod IP，然而却存在如下两问题：</p></li><li><p>Pod IP 会随着Pod的重建产生变化</p></li><li><p>Pod IP 仅仅是集群内可见的虚拟IP，外部无法访问</p><p>这样对于访问这个服务带来了难度。因此，kubernetes设计了Service来解决这个问题。</p><p>Service可以看作是一组同类Pod<strong>对外的访问接口</strong>。借助Service，应用可以方便地实现服务发现和负载均衡。</p><p><img loading="lazy" alt="image-20200408194716912" src="/blog/assets/images/image-20200408194716912-080686a9bbb35623cfd4236b8a3140ec.png" width="1073" height="497" class="img_ev3q"></p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="451-创建集群内部可访问的service">4.5.1 创建集群内部可访问的Service<a href="#451-创建集群内部可访问的service" class="hash-link" aria-label="4.5.1 创建集群内部可访问的Service的直接链接" title="4.5.1 创建集群内部可访问的Service的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 暴露Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl expose deploy nginx </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">svc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nginx1 </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">type</span><span class="token operator" style="color:#393A34">=</span><span class="token maybe-class-name">ClusterIP</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">target</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">svc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nginx1 exposed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> svc svc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nginx1 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">         </span><span class="token constant" style="color:#36acaa">TYPE</span><span class="token plain">        </span><span class="token constant" style="color:#36acaa">CLUSTER</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">       </span><span class="token constant" style="color:#36acaa">EXTERNAL</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">PORT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">     </span><span class="token constant" style="color:#36acaa">SELECTOR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">svc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nginx1   </span><span class="token maybe-class-name">ClusterIP</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">10.109</span><span class="token number" style="color:#36acaa">.179</span><span class="token number" style="color:#36acaa">.231</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none        </span><span class="token number" style="color:#36acaa">80</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain">    3m51s   run</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 这里产生了一个</span><span class="token constant" style="color:#36acaa">CLUSTER</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">，这就是service的</span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">，在Service的生命周期中，这个地址是不会变动的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 可以通过这个</span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">访问当前service对应的</span><span class="token constant" style="color:#36acaa">POD</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># curl </span><span class="token number" style="color:#36acaa">10.109</span><span class="token number" style="color:#36acaa">.179</span><span class="token number" style="color:#36acaa">.231</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">!</span><span class="token constant" style="color:#36acaa">DOCTYPE</span><span class="token plain"> html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">head</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">titleWelcome to nginx</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">title</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">head</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">h1Welcome to nginx</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">h1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">html</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="452-创建集群外部也可访问的service">4.5.2 创建集群外部也可访问的Service<a href="#452-创建集群外部也可访问的service" class="hash-link" aria-label="4.5.2 创建集群外部也可访问的Service的直接链接" title="4.5.2 创建集群外部也可访问的Service的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 上面创建的Service的type类型为ClusterIP，这个ip地址只用集群内部可访问</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 如果需要创建外部也可以访问的Service，需要修改type为NodePort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl expose deploy nginx </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">svc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nginx2 </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">type</span><span class="token operator" style="color:#393A34">=</span><span class="token maybe-class-name">NodePort</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">target</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">svc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nginx2 exposed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 此时查看，会发现出现了NodePort类型的Service，而且有一对Port（</span><span class="token number" style="color:#36acaa">80</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">31928</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">TC</span><span class="token plain">）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> svc  svc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nginx2  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">          </span><span class="token constant" style="color:#36acaa">TYPE</span><span class="token plain">        </span><span class="token constant" style="color:#36acaa">CLUSTER</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">       </span><span class="token constant" style="color:#36acaa">EXTERNAL</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">PORT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">        </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">SELECTOR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">svc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nginx2    </span><span class="token maybe-class-name">NodePort</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">10.100</span><span class="token number" style="color:#36acaa">.94</span><span class="token number" style="color:#36acaa">.0</span><span class="token plain">      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none        </span><span class="token number" style="color:#36acaa">80</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">31928</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain">   9s     run</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 接下来就可以通过集群外的主机访问 节点</span><span class="token constant" style="color:#36acaa">IP</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">31928</span><span class="token plain">访问服务了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 例如在的电脑主机上通过浏览器访问下面的地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">http</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">192.168.90.100:31928</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="453-删除service">4.5.3 删除Service<a href="#453-删除service" class="hash-link" aria-label="4.5.3 删除Service的直接链接" title="4.5.3 删除Service的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@master </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> svc svc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service </span><span class="token string" style="color:#e3116c">&quot;svc-nginx-1&quot;</span><span class="token plain"> deleted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="454-配置方式">4.5.4 配置方式<a href="#454-配置方式" class="hash-link" aria-label="4.5.4 配置方式的直接链接" title="4.5.4 配置方式的直接链接">​</a></h5><p>创建一个svc-nginx.yaml，内容如下：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> svc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">clusterIP</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.109</span><span class="token number" style="color:#36acaa">.179</span><span class="token number" style="color:#36acaa">.231</span><span class="token plain"> #固定svc的内网ip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">protocol</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">targetPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">run</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">ClusterIP</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后就可以执行对应的创建和删除命令了：</p><p>创建：kubectl create -f svc-nginx.yaml</p><p>删除：kubectl delete -f svc-nginx.yaml</p><p> <strong>小结</strong></p><p> 至此，已经掌握了Namespace、Pod、Deployment、Service资源的基本操作，有了这些操作，就可以在kubernetes集群中实现一个服务的简单部署和访问了，但是如果想要更好的使用kubernetes，就需要深入学习这几种资源的细节和原理。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5-pod详解">5. Pod详解<a href="#5-pod详解" class="hash-link" aria-label="5. Pod详解的直接链接" title="5. Pod详解的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="51-pod介绍">5.1 Pod介绍<a href="#51-pod介绍" class="hash-link" aria-label="5.1 Pod介绍的直接链接" title="5.1 Pod介绍的直接链接">​</a></h4><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="511-pod结构">5.1.1 Pod结构<a href="#511-pod结构" class="hash-link" aria-label="5.1.1 Pod结构的直接链接" title="5.1.1 Pod结构的直接链接">​</a></h5><p><img loading="lazy" alt="image-20200407121501907" src="/blog/assets/images/image-20200407121501907-1626781151898-697ca688e34b7d0d92284682633b5d44.png" width="633" height="464" class="img_ev3q"></p><p>每个Pod中都可以包含一个或者多个容器，这些容器可以分为两类：</p></li><li><p>用户程序所在的容器，数量可多可少</p></li><li><p>Pause容器，这是每个Pod都会有的一个<strong>根容器</strong>，它的作用有两个：</p><ul><li><p>可以以它为依据，评估整个Pod的健康状态</p></li><li><p>可以在根容器上设置Ip地址，其它容器都此Ip（Pod IP），以实现Pod内部的网路通信</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">这里是Pod内部的通讯，Pod的之间的通讯采用虚拟二层网络技术来实现，我们当前环境用的是Flannel</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="512-pod定义">5.1.2 Pod定义<a href="#512-pod定义" class="hash-link" aria-label="5.1.2 Pod定义的直接链接" title="5.1.2 Pod定义的直接链接">​</a></h5><p>下面是Pod的资源清单：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1     #必选，版本号，例如v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain">       　 #必选，资源类型，例如 </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">       　 #必选，元数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string     #必选，Pod名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string  #</span><span class="token maybe-class-name">Pod所属的命名空间</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">默认为</span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">       　　  #自定义标签列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string      　          </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  #必选，Pod中容器的详细定义</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  #必选，Pod中容器列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string   #必选，容器名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string  #必选，容器的镜像名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">imagePullPolicy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token maybe-class-name">Always</span><span class="token operator" style="color:#393A34">|</span><span class="token maybe-class-name">Never</span><span class="token operator" style="color:#393A34">|</span><span class="token maybe-class-name">IfNotPresent</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  #获取镜像的策略 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">command</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   #容器的启动命令列表，如不指定，使用打包时使用的启动命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">args</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">      #容器的启动命令参数列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">workingDir</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string  #容器的工作目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">volumeMounts</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">       #挂载到容器内部的存储卷配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string      #引用pod定义的共享存储卷的名称，需用volumes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">部分定义的的卷名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">mountPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string #存储卷在容器内mount的绝对路径，应少于</span><span class="token number" style="color:#36acaa">512</span><span class="token plain">字符</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">readOnly</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> boolean #是否为只读模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> #需要暴露的端口库号列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string        #端口的名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containerPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> int  #容器需要监听的端口号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">hostPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> int       #容器所在主机需要监听的端口号，默认与Container相同</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">protocol</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string    #端口协议，支持</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain">和</span><span class="token constant" style="color:#36acaa">UDP</span><span class="token plain">，默认</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">env</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">   #容器运行前需设置的环境变量列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string  #环境变量名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">value</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string #环境变量的值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">resources</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> #资源限制和请求的设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">limits</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  #资源限制的设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">cpu</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string     #</span><span class="token maybe-class-name">Cpu的限制，单位为core数，将用于docker</span><span class="token plain"> run </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">cpu</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">shares参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">memory</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string  #内存限制，单位可以为Mib</span><span class="token operator" style="color:#393A34">/</span><span class="token maybe-class-name">Gib，将用于docker</span><span class="token plain"> run </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">memory参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">requests</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> #资源请求的设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">cpu</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string    #</span><span class="token maybe-class-name">Cpu请求，容器启动的初始可用数量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">memory</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string #内存请求</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">容器启动的初始可用数量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">lifecycle</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> #生命周期钩子</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">postStart</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> #容器启动后立即执行此钩子</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">如果执行失败</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">会根据重启策略进行重启</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">preStop</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> #容器终止前执行此钩子</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">无论结果如何</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">容器都会终止</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">livenessProbe</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  #对Pod内各容器健康检查的设置，当探测无响应几次后将自动重启该容器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">exec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">       　 #对Pod容器内检查方式设置为exec方式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">command</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  #exec方式需要制定的命令或脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">httpGet</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">       #对Pod内个容器健康检查方法设置为HttpGet，需要制定Path、port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">host</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">scheme</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">HttpHeaders</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token literal-property property" style="color:#36acaa">value</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">tcpSocket</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">     #对Pod内个容器健康检查方式设置为tcpSocket方式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token literal-property property" style="color:#36acaa">port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token literal-property property" style="color:#36acaa">initialDelaySeconds</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">       #容器启动完成后首次探测的时间，单位为秒</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token literal-property property" style="color:#36acaa">timeoutSeconds</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    　　    #对容器健康检查探测等待响应的超时时间，单位秒，默认</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">秒</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token literal-property property" style="color:#36acaa">periodSeconds</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     　　    #对容器监控检查的定期探测时间设置，单位秒，默认</span><span class="token number" style="color:#36acaa">10</span><span class="token plain">秒一次</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token literal-property property" style="color:#36acaa">successThreshold</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token literal-property property" style="color:#36acaa">failureThreshold</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token literal-property property" style="color:#36acaa">securityContext</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token literal-property property" style="color:#36acaa">privileged</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">restartPolicy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token maybe-class-name">Always</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token maybe-class-name">Never</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token maybe-class-name">OnFailure</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  #</span><span class="token maybe-class-name">Pod的重启策略</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">nodeName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">string #设置NodeName表示将该Pod调度到指定到名称的node节点上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">nodeSelector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> obeject #设置NodeSelector表示将该Pod调度到包含这个label的node上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">imagePullSecrets</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> #</span><span class="token maybe-class-name">Pull镜像时使用的secret名称，以key：secretkey格式指定</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">hostNetwork</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain">   #是否使用主机网络模式，默认为</span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain">，如果设置为</span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain">，表示使用宿主机网络</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">volumes</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">   #在该pod上定义共享存储卷列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string    #共享存储卷名称 （volumes类型有很多种）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">emptyDir</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">       #类型为emtyDir的存储卷，与Pod同生命周期的一个临时目录。为空值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">hostPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string   #类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string      　　        #</span><span class="token maybe-class-name">Pod所在宿主机的目录，将被用于同期中mount的目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">secret</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">       　　　#类型为secret的存储卷，挂载集群与定义的secret对象到容器内部</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">scretname</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">items</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> key</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">configMap</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">         #类型为configMap的存储卷，挂载预定义的configMap对象到容器内部</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">items</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> key</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#小提示：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   在这里，可通过一个命令来查看每种资源的可配置项</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   kubectl explain 资源类型         查看某种资源可以配置的一级属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   kubectl explain 资源类型</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">属性</span><span class="token plain">     查看属性的子属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl explain pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">KIND</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">     </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">VERSION</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">FIELDS</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   apiVersion   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   kind </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   metadata     </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token known-class-name class-name">Object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   spec </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token known-class-name class-name">Object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   status       </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token known-class-name class-name">Object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl explain pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">metadata</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">KIND</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">     </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">VERSION</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">RESOURCE</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> metadata </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token known-class-name class-name">Object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">FIELDS</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   annotations  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   clusterName  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   creationTimestamp    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   deletionGracePeriodSeconds   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">integer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   deletionTimestamp    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   finalizers   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   generateName </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   generation   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">integer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   labels       </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   managedFields        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token known-class-name class-name">Object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   name </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   namespace    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ownerReferences      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token known-class-name class-name">Object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   resourceVersion      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   selfLink     </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   uid  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">string</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在kubernetes中基本所有资源的一级属性都是一样的，主要包含5部分：</p></li><li><p>apiVersion 版本，由kubernetes内部定义，版本号必须可以用 kubectl api-versions 查询到</p></li><li><p>kind 类型，由kubernetes内部定义，版本号必须可以用 kubectl api-resources 查询到</p></li><li><p>metadata 元数据，主要是资源标识和说明，常用的有name、namespace、labels等</p></li><li><p>spec 描述，这是配置中最重要的一部分，里面是对各种资源配置的详细描述</p></li><li><p>status 状态信息，里面的内容不需要定义，由kubernetes自动生成</p><p>在上面的属性中，spec是接下来研究的重点，继续看下它的常见子属性:</p></li><li><p>containers &lt;[]Object 容器列表，用于定义容器的详细信息</p></li><li><p>nodeName 根据nodeName的值将pod调度到指定的Node节点上</p></li><li><p>nodeSelector &lt;map[] 根据NodeSelector中定义的信息选择将该Pod调度到包含这些label的Node 上</p></li><li><p>hostNetwork 是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络</p></li><li><p>volumes &lt;[]Object 存储卷，用于定义Pod上面挂在的存储信息</p></li><li><p>restartPolicy 重启策略，表示Pod在遇到故障的时候的处理策略</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="52-pod配置">5.2 Pod配置<a href="#52-pod配置" class="hash-link" aria-label="5.2 Pod配置的直接链接" title="5.2 Pod配置的直接链接">​</a></h4><p>本小节主要来研究<code>pod.spec.containers</code>属性，这也是pod配置中最为关键的一项配置。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl explain pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">containers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">KIND</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">     </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">VERSION</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">RESOURCE</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> containers </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token known-class-name class-name">Object</span><span class="token plain">   # 数组，代表可以有多个容器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">FIELDS</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   name  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">string     # 容器名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   image </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">string     # 容器需要的镜像地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   imagePullPolicy  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">string # 镜像拉取策略 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   command  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">string # 容器的启动命令列表，如不指定，使用打包时使用的启动命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   args     </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">string # 容器的启动命令需要的参数列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   env      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token known-class-name class-name">Object</span><span class="token plain"> # 容器环境变量的配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ports    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token known-class-name class-name">Object</span><span class="token plain">     # 容器需要暴露的端口号列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   resources </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token known-class-name class-name">Object</span><span class="token plain">      # 资源限制和资源请求的设置</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="521-基本配置">5.2.1 基本配置<a href="#521-基本配置" class="hash-link" aria-label="5.2.1 基本配置的直接链接" title="5.2.1 基本配置的直接链接">​</a></h5><p>创建pod-base.yaml文件，内容如下：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">base</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">user</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> heima</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> busybox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> busybox</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.30</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20210617223823675" src="/blog/assets/images/image-20210617223823675-1626781695411-cdc8a5a378599d784fbc3d83f8427299.png" width="429" height="66" class="img_ev3q"></p><p>上面定义了一个比较简单Pod的配置，里面有两个容器：</p></li><li><p>nginx：用1.17.1版本的nginx镜像创建，（nginx是一个轻量级web容器）</p></li><li><p>busybox：用1.30版本的busybox镜像创建，（busybox是一个小巧的linux命令集合）</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 pod</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl apply </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">base</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">base created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看Pod状况</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> 表示当前Pod中有</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">个容器，其中</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">个准备就绪，</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">个未就绪</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> 重启次数，因为有</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">个容器故障了，Pod一直在重启试图恢复它</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 pod</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">       </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">base   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">          95s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 可以通过describe查看内部的详情</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 此时已经运行起来了一个基本的Pod，虽然它暂时有问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 pod</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl describe pod pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">base </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="522-镜像拉取">5.2.2 镜像拉取<a href="#522-镜像拉取" class="hash-link" aria-label="5.2.2 镜像拉取的直接链接" title="5.2.2 镜像拉取的直接链接">​</a></h5><p>创建pod-imagepullpolicy.yaml文件，内容如下：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">imagepullpolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">imagePullPolicy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Never</span><span class="token plain"> # 用于设置镜像拉取策略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> busybox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> busybox</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.30</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20210617223923659" src="/blog/assets/images/image-20210617223923659-21cc3a44f450f700dd4d189104a41273.png" width="495" height="79" class="img_ev3q"></p><p>imagePullPolicy，用于设置镜像拉取策略，kubernetes支持配置三种拉取策略：</p></li><li><p>Always：总是从远程仓库拉取镜像（一直远程下载）</p></li><li><p>IfNotPresent：本地有则使用本地镜像，本地没有则从远程仓库拉取镜像（本地有就本地 本地没远程下载）</p></li><li><p>Never：只使用本地镜像，从不去远程仓库拉取，本地没有就报错 （一直使用本地）</p><p> 默认值说明：</p><p> 如果镜像tag为具体版本号， 默认策略是：IfNotPresent</p><p> 如果镜像tag为：latest（最终版本） ，默认策略是always</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 pod</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">imagepullpolicy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">imagepullpolicy created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看Pod详情</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 此时明显可以看到nginx镜像有一步Pulling image </span><span class="token string" style="color:#e3116c">&quot;nginx:1.17.1&quot;</span><span class="token plain">的过程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 pod</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl describe pod pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">imagepullpolicy </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Events</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Type</span><span class="token plain">     </span><span class="token maybe-class-name">Reason</span><span class="token plain">     </span><span class="token maybe-class-name">Age</span><span class="token plain">               </span><span class="token maybe-class-name">From</span><span class="token plain">               </span><span class="token maybe-class-name">Message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">              </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">               </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">   </span><span class="token maybe-class-name">Scheduled</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">unknown         </span><span class="token keyword module" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">scheduler  </span><span class="token maybe-class-name">Successfully</span><span class="token plain"> assigned dev</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">imagePullPolicy to node1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">   </span><span class="token maybe-class-name">Pulling</span><span class="token plain">    32s               kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Pulling</span><span class="token plain"> image </span><span class="token string" style="color:#e3116c">&quot;nginx:1.17.1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">   </span><span class="token maybe-class-name">Pulled</span><span class="token plain">     26s               kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Successfully</span><span class="token plain"> pulled image </span><span class="token string" style="color:#e3116c">&quot;nginx:1.17.1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">   </span><span class="token maybe-class-name">Created</span><span class="token plain">    26s               kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Created</span><span class="token plain"> container nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">   </span><span class="token maybe-class-name">Started</span><span class="token plain">    25s               kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Started</span><span class="token plain"> container nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">   </span><span class="token maybe-class-name">Pulled</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">7</span><span class="token function" style="color:#d73a49">s</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x3 over 25s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Container</span><span class="token plain"> image </span><span class="token string" style="color:#e3116c">&quot;busybox:1.30&quot;</span><span class="token plain"> already present on machine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">   </span><span class="token maybe-class-name">Created</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">7</span><span class="token function" style="color:#d73a49">s</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x3 over 25s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Created</span><span class="token plain"> container busybox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">   </span><span class="token maybe-class-name">Started</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">7</span><span class="token function" style="color:#d73a49">s</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x3 over 25s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Started</span><span class="token plain"> container busybox</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="523-启动命令">5.2.3 启动命令<a href="#523-启动命令" class="hash-link" aria-label="5.2.3 启动命令的直接链接" title="5.2.3 启动命令的直接链接">​</a></h5><p>在前面的案例中，一直有一个问题没有解决，就是的busybox容器一直没有成功运行，那么到底是什么原因导致这个容器的故障呢？</p><p>原来busybox并不是一个程序，而是类似于一个工具类的集合，kubernetes集群启动管理后，它会自动关闭。解决方法就是让其一直在运行，这就用到了command配置。</p><p>创建pod-command.yaml文件，内容如下：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">command</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> busybox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> busybox</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">command</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;/bin/sh&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;-c&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;touch /tmp/hello.txt;while true;do /bin/echo $(date +%T)  /tmp/hello.txt; sleep 3; done;&quot;</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20210617224457945" src="/blog/assets/images/image-20210617224457945-d3d7ae9d0cb29cb6d838523eaa67189d.png" width="497" height="97" class="img_ev3q"></p><p>command，用于在pod中的容器初始化完毕之后运行一个命令。</p><p> 稍微解释下上面命令的意思：</p><p> &quot;/bin/sh&quot;,&quot;-c&quot;, 使用sh执行命令</p><p> touch /tmp/hello.txt; 创建一个/tmp/hello.txt 文件</p><p> while true;do /bin/echo $(date +%T)  /tmp/hello.txt; sleep 3; done; 每隔3秒向文件中写入当前时间</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 pod</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">command</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">command created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看Pod状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 此时发现两个pod都正常运行了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 pod</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">command </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">          </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">command   </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">     </span><span class="token maybe-class-name">Runing</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 进入pod中的busybox容器，查看文件内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 补充一个命令</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> kubectl exec  pod名称 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n 命名空间 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">it </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c 容器名称 </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sh  在容器内部执行命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 使用这个命令就可以进入某个容器的内部，然后进行相关操作了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 比如，可以查看txt文件的内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 pod</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl exec pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">command </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">it </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c busybox </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> # tail </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">tmp</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">hello</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">txt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">14</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">44</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">19</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">14</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">44</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">22</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">14</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">44</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">25</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">特别说明：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    通过上面发现command已经可以完成启动命令和传递参数的功能，为什么这里还要提供一个args选项，用于传递参数呢</span><span class="token operator" style="color:#393A34">?</span><span class="token plain">这其实跟docker有点关系，kubernetes中的command、args两项其实是实现覆盖Dockerfile中</span><span class="token constant" style="color:#36acaa">ENTRYPOINT</span><span class="token plain">的功能。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> 如果command和args均没有写，那么用Dockerfile的配置。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> 如果command写了，但args没有写，那么Dockerfile默认的配置会被忽略，执行输入的command</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> 如果command没写，但args写了，那么Dockerfile中配置的</span><span class="token constant" style="color:#36acaa">ENTRYPOINT</span><span class="token plain">的命令会被执行，使用当前args的参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> 如果command和args都写了，那么Dockerfile的配置被忽略，执行command并追加上args参数</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="524-环境变量">5.2.4 环境变量<a href="#524-环境变量" class="hash-link" aria-label="5.2.4 环境变量的直接链接" title="5.2.4 环境变量的直接链接">​</a></h5><p>创建pod-env.yaml文件，内容如下：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> busybox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> busybox</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">command</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;/bin/sh&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;-c&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;while true;do /bin/echo $(date +%T);sleep 60; done;&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">env</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 设置环境变量列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;username&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">value</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;admin&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;password&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">value</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;123456&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>env，环境变量，用于在pod中的容器设置环境变量。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">env created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 进入容器，输出环境变量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl exec pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">env </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c busybox </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">it </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> # echo $username</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> # echo $password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">123456</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这种方式不是很推荐，推荐将这些配置单独存储在配置文件中，这种方式将在后面介绍。</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="525-端口设置">5.2.5 端口设置<a href="#525-端口设置" class="hash-link" aria-label="5.2.5 端口设置的直接链接" title="5.2.5 端口设置的直接链接">​</a></h5><p>本小节来介绍容器的端口设置，也就是containers的ports选项。</p><p>首先看下ports支持的子选项：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl explain pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">containers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">ports</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">KIND</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">     </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">VERSION</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">RESOURCE</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ports </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token known-class-name class-name">Object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">FIELDS</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   name         </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">string  # 端口名称，如果指定，必须保证name在pod中是唯一的      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   containerPort</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">integer # </span><span class="token function" style="color:#d73a49">容器要监听的端口</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">x</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">65536</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   hostPort     </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">integer # </span><span class="token function" style="color:#d73a49">容器要在主机上公开的端口，如果设置，主机上只能运行容器的一个副本</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">一般省略</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   hostIP       </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">string  # 要将外部端口绑定到的主机</span><span class="token constant" style="color:#36acaa">IP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">一般省略</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   protocol     </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">string  # 端口协议。必须是</span><span class="token constant" style="color:#36acaa">UDP</span><span class="token plain">、</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain">或</span><span class="token constant" style="color:#36acaa">SCTP</span><span class="token plain">。默认为“</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain">”。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接下来，编写一个测试案例，创建pod-ports.yaml</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ports</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 设置容器暴露的端口列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containerPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">protocol</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ports</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ports created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 在下面可以明显看到配置信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pod pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ports </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">imagePullPolicy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">IfNotPresent</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> containerPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">protocol</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>访问容器中的程序需要使用的是<code>Podip:containerPort</code></p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="526-资源配额">5.2.6 资源配额<a href="#526-资源配额" class="hash-link" aria-label="5.2.6 资源配额的直接链接" title="5.2.6 资源配额的直接链接">​</a></h5><p>容器中的程序要运行，肯定是要占用一定资源的，比如cpu和内存等，如果不对某个容器的资源做限制，那么它就可能吃掉大量资源，导致其它容器无法运行。针对这种情况，kubernetes提供了对内存和cpu的资源进行配额的机制，这种机制主要通过resources选项实现，他有两个子选项：</p></li><li><p>limits：用于限制运行时容器的最大占用资源，当容器占用资源超过limits时会被终止，并进行重启</p></li><li><p>requests ：用于设置容器需要的最小资源，如果环境资源不够，容器将无法启动</p><p>可以通过上面两个选项设置资源的上下限。</p><p>接下来，编写一个测试案例，创建pod-resources.yaml</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">resources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">resources</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 资源配额</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">limits</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  # 限制资源（上限）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">cpu</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2&quot;</span><span class="token plain"> # </span><span class="token constant" style="color:#36acaa">CPU</span><span class="token plain">限制，单位是core数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">memory</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;10Gi&quot;</span><span class="token plain"> # 内存限制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">requests</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 请求资源（下限）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">cpu</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1&quot;</span><span class="token plain">  # </span><span class="token constant" style="color:#36acaa">CPU</span><span class="token plain">限制，单位是core数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">memory</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;10Mi&quot;</span><span class="token plain">  # 内存限制</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在这对cpu和memory的单位做一个说明：</p></li><li><p>cpu：core数，可以为整数或小数</p></li><li><p>memory： 内存大小，可以使用Gi、Mi、G、M等形式</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 运行Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">resources</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">resources created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看发现pod运行正常</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pod pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">resources </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">            </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">resources   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          39s   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 接下来，停止Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">resources</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod </span><span class="token string" style="color:#e3116c">&quot;pod-resources&quot;</span><span class="token plain"> deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 编辑pod，修改resources</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">requests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">memory的值为10Gi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># vim pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">resources</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 再次启动pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">resources</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">resources created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看Pod状态，发现Pod启动失败</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pod pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">resources </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">            </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">          </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">resources   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Pending</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          20s    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看pod详情会发现，如下提示</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl describe pod pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">resources </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Warning</span><span class="token plain">  </span><span class="token maybe-class-name">FailedScheduling</span><span class="token plain">  35s   </span><span class="token keyword module" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">scheduler  </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> nodes are available</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> had taint </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">node</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">role</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">kubernetes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">master</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> that the pod didn&#x27;t tolerate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token maybe-class-name">Insufficient</span><span class="token plain"> memory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">内存不足</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="53-pod生命周期">5.3 Pod生命周期<a href="#53-pod生命周期" class="hash-link" aria-label="5.3 Pod生命周期的直接链接" title="5.3 Pod生命周期的直接链接">​</a></h4><p>我们一般将pod对象从创建至终的这段时间范围称为pod的生命周期，它主要包含下面的过程：</p></li><li><p>pod创建过程</p></li><li><p>运行初始化容器（init container）过程</p></li><li><p>运行主容器（main container）</p><ul><li>容器启动后钩子（post start）、容器终止前钩子（pre stop）</li><li>容器的存活性探测（liveness probe）、就绪性探测（readiness probe）</li></ul></li><li><p>pod终止过程</p><p><img loading="lazy" alt="image-20200412111402706" src="/blog/assets/images/image-20200412111402706-1626782188724-f743c3986584ed494e278bb42b46b4a3.png" width="1053" height="548" class="img_ev3q"></p><p>在整个生命周期中，Pod会出现5种<strong>状态</strong>（<strong>相位</strong>），分别如下：</p></li><li><p>挂起（Pending）：apiserver已经创建了pod资源对象，但它尚未被调度完成或者仍处于下载镜像的过程中</p></li><li><p>运行中（Running）：pod已经被调度至某节点，并且所有容器都已经被kubelet创建完成</p></li><li><p>成功（Succeeded）：pod中的所有容器都已经成功终止并且不会被重启</p></li><li><p>失败（Failed）：所有容器都已经终止，但至少有一个容器终止失败，即容器返回了非0值的退出状态</p></li><li><p>未知（Unknown）：apiserver无法正常获取到pod对象的状态信息，通常由网络通信失败所导致</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="531-创建和终止">5.3.1 创建和终止<a href="#531-创建和终止" class="hash-link" aria-label="5.3.1 创建和终止的直接链接" title="5.3.1 创建和终止的直接链接">​</a></h5><p><strong>pod的创建过程</strong></p></li></ul><ol><li><p>用户通过kubectl或其他api客户端提交需要创建的pod信息给apiServer</p></li><li><p>apiServer开始生成pod对象的信息，并将信息存入etcd，然后返回确认信息至客户端</p></li><li><p>apiServer开始反映etcd中的pod对象的变化，其它组件使用watch机制来跟踪检查apiServer上的变动</p></li><li><p>scheduler发现有新的pod对象要创建，开始为Pod分配主机并将结果信息更新至apiServer</p></li><li><p>node节点上的kubelet发现有pod调度过来，尝试调用docker启动容器，并将结果回送至apiServer</p></li><li><p>apiServer将接收到的pod状态信息存入etcd中</p><p>   <img loading="lazy" alt="image-20200406184656917" src="/blog/assets/images/image-20200406184656917-1626782168787-ed92f8d2184b2383cf7992a3dcb69b0b.png" width="1436" height="745" class="img_ev3q"></p><p><strong>pod的终止过程</strong></p></li><li><p>用户向apiServer发送删除pod对象的命令</p></li><li><p>apiServcer中的pod对象信息会随着时间的推移而更新，在宽限期内（默认30s），pod被视为dead</p></li><li><p>将pod标记为terminating状态</p></li><li><p>kubelet在监控到pod对象转为terminating状态的同时启动pod关闭过程</p></li><li><p>端点控制器监控到pod对象的关闭行为时将其从所有匹配到此端点的service资源的端点列表中移除</p></li><li><p>如果当前pod对象定义了preStop钩子处理器，则在其标记为terminating后即会以同步的方式启动执行</p></li><li><p>pod对象中的容器进程收到停止信号</p></li><li><p>宽限期结束后，若pod中还存在仍在运行的进程，那么pod对象会收到立即终止的信号</p></li><li><p>kubelet请求apiServer将此pod资源的宽限期设置为0从而完成删除操作，此时pod对于用户已不可见</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="532-初始化容器">5.3.2 初始化容器<a href="#532-初始化容器" class="hash-link" aria-label="5.3.2 初始化容器的直接链接" title="5.3.2 初始化容器的直接链接">​</a></h5><p>初始化容器是在pod的主容器启动之前要运行的容器，主要是做一些主容器的前置工作，它具有两大特征：</p></li><li><p>初始化容器必须运行完成直至结束，若某初始化容器运行失败，那么kubernetes需要重启它直到成功完成</p></li><li><p>初始化容器必须按照定义的顺序执行，当且仅当前一个成功之后，后面的一个才能运行</p><p>初始化容器有很多的应用场景，下面列出的是最常见的几个：</p></li></ol><ul><li><p>提供主容器镜像中不具备的工具程序或自定义代码</p></li><li><p>初始化容器要先于应用容器串行启动并运行完成，因此可用于延后应用容器的启动直至其依赖的条件得到满足</p><p>接下来做一个案例，模拟下面这个需求：</p><p>假设要以主容器来运行nginx，但是要求在运行nginx之前先要能够连接上mysql和redis所在服务器</p><p>为了简化测试，事先规定好mysql<code>(192.168.90.14)</code>和redis<code>(192.168.90.15)</code>服务器的地址</p><p>创建pod-initcontainer.yaml，内容如下：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">initcontainer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> main</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containerPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">initContainers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> test</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> busybox</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">command</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;sh&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;-c&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;until ping 192.168.90.14 -c 1 ; do echo waiting for mysql...; sleep 2; done;&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> test</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">redis</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> busybox</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">command</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;sh&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;-c&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;until ping 192.168.90.15 -c 1 ; do echo waiting for reids...; sleep 2; done;&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">initcontainer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">initcontainer created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看pod状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 发现pod卡在启动第一个初始化容器过程中，后面的容器不会运行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl describe pod  pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">initcontainer </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Events</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Type</span><span class="token plain">    </span><span class="token maybe-class-name">Reason</span><span class="token plain">     </span><span class="token maybe-class-name">Age</span><span class="token plain">   </span><span class="token maybe-class-name">From</span><span class="token plain">               </span><span class="token maybe-class-name">Message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">               </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">  </span><span class="token maybe-class-name">Scheduled</span><span class="token plain">  49s   </span><span class="token keyword module" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">scheduler  </span><span class="token maybe-class-name">Successfully</span><span class="token plain"> assigned dev</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">initcontainer to node1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">  </span><span class="token maybe-class-name">Pulled</span><span class="token plain">     48s   kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Container</span><span class="token plain"> image </span><span class="token string" style="color:#e3116c">&quot;busybox:1.30&quot;</span><span class="token plain"> already present on machine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">  </span><span class="token maybe-class-name">Created</span><span class="token plain">    48s   kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Created</span><span class="token plain"> container test</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">  </span><span class="token maybe-class-name">Started</span><span class="token plain">    48s   kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Started</span><span class="token plain"> container test</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 动态查看pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">initcontainer </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                             </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">     </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">initcontainer                </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token literal-property property" style="color:#36acaa">Init</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          15s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">initcontainer                </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token literal-property property" style="color:#36acaa">Init</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          52s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">initcontainer                </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token literal-property property" style="color:#36acaa">Init</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          53s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">initcontainer                </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">PodInitializing</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          89s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">initcontainer                </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          90s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 接下来新开一个shell，为当前服务器新增两个ip，观察pod的变化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># ifconfig ens33</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token number" style="color:#36acaa">.90</span><span class="token number" style="color:#36acaa">.14</span><span class="token plain"> netmask </span><span class="token number" style="color:#36acaa">255.255</span><span class="token number" style="color:#36acaa">.255</span><span class="token number" style="color:#36acaa">.0</span><span class="token plain"> up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># ifconfig ens33</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token number" style="color:#36acaa">.90</span><span class="token number" style="color:#36acaa">.15</span><span class="token plain"> netmask </span><span class="token number" style="color:#36acaa">255.255</span><span class="token number" style="color:#36acaa">.255</span><span class="token number" style="color:#36acaa">.0</span><span class="token plain"> up</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="533-钩子函数">5.3.3 钩子函数<a href="#533-钩子函数" class="hash-link" aria-label="5.3.3 钩子函数的直接链接" title="5.3.3 钩子函数的直接链接">​</a></h5><p>钩子函数能够感知自身生命周期中的事件，并在相应的时刻到来时运行用户指定的程序代码。</p><p>kubernetes在主容器的启动之后和停止之前提供了两个钩子函数：</p></li><li><p>post start：容器创建之后执行，如果失败了会重启容器</p></li><li><p>pre stop ：容器终止之前执行，执行完成之后容器将成功终止，在其完成之前会阻塞删除容器的操作</p><p>钩子处理器支持使用下面三种方式定义动作：</p></li><li><p>Exec命令：在容器内执行一次命令</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">……</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">lifecycle</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">postStart</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">exec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">command</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> cat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">tmp</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">healthy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">……</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>TCPSocket：在当前容器尝试访问指定的socket</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">……      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">lifecycle</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">postStart</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">tcpSocket</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">……</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>HTTPGet：在当前容器中向某url发起http请求</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">……</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">lifecycle</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">postStart</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">httpGet</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> #</span><span class="token constant" style="color:#36acaa">URI</span><span class="token plain">地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> #端口号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">host</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token number" style="color:#36acaa">.5</span><span class="token number" style="color:#36acaa">.3</span><span class="token plain"> #主机地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">scheme</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">HTTP</span><span class="token plain"> #支持的协议，http或者https</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">……</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接下来，以exec方式为例，演示下钩子函数的使用，创建pod-hook-exec.yaml文件，内容如下：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hook</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">exec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> main</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containerPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">lifecycle</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">postStart</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">exec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 在容器启动的时候执行一个命令，修改掉nginx的默认首页内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token literal-property property" style="color:#36acaa">command</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;/bin/sh&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-c&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;echo postStart...  /usr/share/nginx/html/index.html&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">preStop</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">exec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 在容器停止之前停止nginx服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token literal-property property" style="color:#36acaa">command</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;/usr/sbin/nginx&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;-s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;quit&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hook</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">exec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hook</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">exec created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods  pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hook</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">exec </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">           </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">     </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">            </span><span class="token constant" style="color:#36acaa">NODE</span><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hook</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">exec  </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          29s    </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.48</span><span class="token plain">   node2   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 访问pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># curl </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.48</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postStart</span><span class="token spread operator" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="534-容器探测">5.3.4 容器探测<a href="#534-容器探测" class="hash-link" aria-label="5.3.4 容器探测的直接链接" title="5.3.4 容器探测的直接链接">​</a></h5><p>容器探测用于检测容器中的应用实例是否正常工作，是保障业务可用性的一种传统机制。如果经过探测，实例的状态不符合预期，那么kubernetes就会把该问题实例&quot; 摘除 &quot;，不承担业务流量。kubernetes提供了两种探针来实现容器探测，分别是：</p></li><li><p>liveness probes：存活性探针，用于检测应用实例当前是否处于正常运行状态，如果不是，k8s会重启容器</p></li><li><p>readiness probes：就绪性探针，用于检测应用实例当前是否可以接收请求，如果不能，k8s不会转发流量</p><p> livenessProbe 决定是否重启容器，readinessProbe 决定是否将请求转发给容器。</p><p>上面两种探针目前均支持三种探测方式：</p></li><li><p>Exec命令：在容器内执行一次命令，如果命令执行的退出码为0，则认为程序正常，否则不正常</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">……</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">livenessProbe</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">exec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">command</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> cat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">tmp</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">healthy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">……</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>TCPSocket：将会尝试访问一个用户容器的端口，如果能够建立这条连接，则认为程序正常，否则不正常</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">……      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">livenessProbe</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">tcpSocket</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">……</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>HTTPGet：调用容器内Web应用的URL，如果返回的状态码在200和399之间，则认为程序正常，否则不正常</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">……</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">livenessProbe</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">httpGet</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> #</span><span class="token constant" style="color:#36acaa">URI</span><span class="token plain">地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> #端口号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">host</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.0</span><span class="token number" style="color:#36acaa">.0</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"> #主机地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">scheme</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">HTTP</span><span class="token plain"> #支持的协议，http或者https</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">……</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>下面以liveness probes为例，做几个演示：</p><p><strong>方式一：Exec</strong></p><p>创建pod-liveness-exec.yaml</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">liveness</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">exec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containerPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">livenessProbe</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">exec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">command</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;/bin/cat&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;/tmp/hello.txt&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> # 执行一个查看文件的命令</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>创建pod，观察效果</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">liveness</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">exec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">liveness</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">exec created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看Pod详情</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl describe pods pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">liveness</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">exec </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">   </span><span class="token maybe-class-name">Created</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">20</span><span class="token function" style="color:#d73a49">s</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x2 over 50s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Created</span><span class="token plain"> container nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">   </span><span class="token maybe-class-name">Started</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">20</span><span class="token function" style="color:#d73a49">s</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x2 over 50s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Started</span><span class="token plain"> container nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">   </span><span class="token maybe-class-name">Killing</span><span class="token plain">    20s                kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Container</span><span class="token plain"> nginx failed liveness probe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> will be restarted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Warning</span><span class="token plain">  </span><span class="token maybe-class-name">Unhealthy</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0</span><span class="token function" style="color:#d73a49">s</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x5 over 40s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Liveness</span><span class="token plain"> probe failed</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cat</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> can</span><span class="token string" style="color:#e3116c">&#x27;t open &#x27;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">tmp</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">hello11</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">txt</span><span class="token plain">&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">No</span><span class="token plain"> such file or directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 观察上面的信息就会发现nginx容器启动之后就进行了健康检查</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 检查失败之后，容器被kill掉，然后尝试进行重启（这是重启策略的作用，后面讲解）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 稍等一会之后，再观察pod信息，就可以看到</span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">不再是</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">，而是一直增长</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">liveness</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">exec </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">             </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">liveness</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">exec   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">CrashLoopBackOff</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">          3m19s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 当然接下来，可以修改成一个存在的文件，比如</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">tmp</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">hello</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">txt，再试，结果就正常了</span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>方式二：TCPSocket</strong></p><p>创建pod-liveness-tcpsocket.yaml</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">liveness</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">tcpsocket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containerPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">livenessProbe</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">tcpSocket</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"> # 尝试访问</span><span class="token number" style="color:#36acaa">8080</span><span class="token plain">端口</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>创建pod，观察效果</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">liveness</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">tcpsocket</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">liveness</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">tcpsocket created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看Pod详情</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl describe pods pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">liveness</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">tcpsocket </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">   </span><span class="token maybe-class-name">Scheduled</span><span class="token plain">  31s                            </span><span class="token keyword module" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">scheduler  </span><span class="token maybe-class-name">Successfully</span><span class="token plain"> assigned dev</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">liveness</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">tcpsocket to node2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">   </span><span class="token maybe-class-name">Pulled</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">invalid                      kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node2     </span><span class="token maybe-class-name">Container</span><span class="token plain"> image </span><span class="token string" style="color:#e3116c">&quot;nginx:1.17.1&quot;</span><span class="token plain"> already present on machine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">   </span><span class="token maybe-class-name">Created</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">invalid                      kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node2     </span><span class="token maybe-class-name">Created</span><span class="token plain"> container nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">   </span><span class="token maybe-class-name">Started</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">invalid                      kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node2     </span><span class="token maybe-class-name">Started</span><span class="token plain"> container nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Warning</span><span class="token plain">  </span><span class="token maybe-class-name">Unhealthy</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token function" style="color:#d73a49">invalid</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x2 over </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">invalid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node2     </span><span class="token maybe-class-name">Liveness</span><span class="token plain"> probe failed</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dial tcp </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.44</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8080</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> connect</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> connection refused</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 观察上面的信息，发现尝试访问</span><span class="token number" style="color:#36acaa">8080</span><span class="token plain">端口</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">但是失败了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 稍等一会之后，再观察pod信息，就可以看到</span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">不再是</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">，而是一直增长</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">liveness</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">tcpsocket  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                     </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">             </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">liveness</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">tcpsocket   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">CrashLoopBackOff</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">          3m19s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 当然接下来，可以修改成一个可以访问的端口，比如</span><span class="token number" style="color:#36acaa">80</span><span class="token plain">，再试，结果就正常了</span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>方式三：HTTPGet</strong></p><p>创建pod-liveness-httpget.yaml</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">liveness</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">httpget</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containerPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">livenessProbe</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">httpGet</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  # 其实就是访问http</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">127.0</span><span class="token number" style="color:#36acaa">.0</span><span class="token number" style="color:#36acaa">.1</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">hello  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">scheme</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">HTTP</span><span class="token plain"> #支持的协议，http或者https</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> #端口号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">hello #</span><span class="token constant" style="color:#36acaa">URI</span><span class="token plain">地址</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>创建pod，观察效果</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">liveness</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">httpget</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">liveness</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">httpget created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看Pod详情</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl describe pod pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">liveness</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">httpget </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property-access maybe-class-name">Normal</span><span class="token plain">   </span><span class="token maybe-class-name">Pulled</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">6</span><span class="token function" style="color:#d73a49">s</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x3 over 64s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Container</span><span class="token plain"> image </span><span class="token string" style="color:#e3116c">&quot;nginx:1.17.1&quot;</span><span class="token plain"> already present on machine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">   </span><span class="token maybe-class-name">Created</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">6</span><span class="token function" style="color:#d73a49">s</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x3 over 64s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Created</span><span class="token plain"> container nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">   </span><span class="token maybe-class-name">Started</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">6</span><span class="token function" style="color:#d73a49">s</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x3 over 63s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Started</span><span class="token plain"> container nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Warning</span><span class="token plain">  </span><span class="token maybe-class-name">Unhealthy</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">6</span><span class="token function" style="color:#d73a49">s</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x6 over 56s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Liveness</span><span class="token plain"> probe failed</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">HTTP</span><span class="token plain"> probe failed </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">statuscode</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">404</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">   </span><span class="token maybe-class-name">Killing</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">6</span><span class="token function" style="color:#d73a49">s</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x2 over 36s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Container</span><span class="token plain"> nginx failed liveness probe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> will be restarted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 观察上面信息，尝试访问路径，但是未找到</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">出现</span><span class="token number" style="color:#36acaa">404</span><span class="token plain">错误</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 稍等一会之后，再观察pod信息，就可以看到</span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">不再是</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">，而是一直增长</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pod pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">liveness</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">httpget </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                   </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">liveness</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">httpget   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">          3m17s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 当然接下来，可以修改成一个可以访问的路径path，比如</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">，再试，结果就正常了</span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>至此，已经使用liveness Probe演示了三种探测方式，但是查看livenessProbe的子属性，会发现除了这三种方式，还有一些其他的配置，在这里一并解释下：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl explain pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">containers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">livenessProbe</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">FIELDS</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   exec </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token known-class-name class-name">Object</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   tcpSocket    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token known-class-name class-name">Object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   httpGet      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token known-class-name class-name">Object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   initialDelaySeconds  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">integer  # 容器启动后等待多少秒执行第一次探测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   timeoutSeconds       </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">integer  # 探测超时时间。默认</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">秒，最小</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">秒</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   periodSeconds        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">integer  # 执行探测的频率。默认是</span><span class="token number" style="color:#36acaa">10</span><span class="token plain">秒，最小</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">秒</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   failureThreshold     </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">integer  # 连续探测失败多少次才被认定为失败。默认是</span><span class="token number" style="color:#36acaa">3</span><span class="token plain">。最小值是</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   successThreshold     </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">integer  # 连续探测成功多少次才被认定为成功。默认是</span><span class="token number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>下面稍微配置两个，演示下效果即可：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># more pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">liveness</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">httpget</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">liveness</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">httpget</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containerPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">livenessProbe</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">httpGet</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">scheme</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">HTTP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">initialDelaySeconds</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> # 容器启动后30s开始探测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">timeoutSeconds</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> # 探测超时时间为5s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="535-重启策略">5.3.5 重启策略<a href="#535-重启策略" class="hash-link" aria-label="5.3.5 重启策略的直接链接" title="5.3.5 重启策略的直接链接">​</a></h5><p>在上一节中，一旦容器探测出现了问题，kubernetes就会对容器所在的Pod进行重启，其实这是由pod的重启策略决定的，pod的重启策略有 3 种，分别如下：</p></li><li><p>Always ：容器失效时，自动重启该容器，这也是默认值。</p></li><li><p>OnFailure ： 容器终止运行且退出码不为0时重启</p></li><li><p>Never ： 不论状态为何，都不重启该容器</p><p>重启策略适用于pod对象中的所有容器，首次需要重启的容器，将在其需要时立即进行重启，随后再次需要重启的操作将由kubelet延迟一段时间后进行，且反复的重启操作的延迟时长以此为10s、20s、40s、80s、160s和300s，300s是最大延迟时长。</p><p>创建pod-restartpolicy.yaml：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">restartpolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containerPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">livenessProbe</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">httpGet</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">scheme</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">HTTP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">restartPolicy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Never</span><span class="token plain"> # 设置重启策略为Never</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>运行Pod测试</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">restartpolicy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">restartpolicy created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看Pod详情，发现nginx容器失败</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl  describe pods pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">restartpolicy  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Warning</span><span class="token plain">  </span><span class="token maybe-class-name">Unhealthy</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">15</span><span class="token function" style="color:#d73a49">s</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x3 over 35s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Liveness</span><span class="token plain"> probe failed</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">HTTP</span><span class="token plain"> probe failed </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">statuscode</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">404</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Normal</span><span class="token plain">   </span><span class="token maybe-class-name">Killing</span><span class="token plain">    15s                kubelet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node1     </span><span class="token maybe-class-name">Container</span><span class="token plain"> nginx failed liveness probe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 多等一会，再观察pod的重启次数，发现一直是</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">，并未重启   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl  </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">restartpolicy </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                   </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">restartpolicy      </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          5min42s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="54-pod调度">5.4 Pod调度<a href="#54-pod调度" class="hash-link" aria-label="5.4 Pod调度的直接链接" title="5.4 Pod调度的直接链接">​</a></h4><p>在默认情况下，一个Pod在哪个Node节点上运行，是由Scheduler组件采用相应的算法计算出来的，这个过程是不受人工控制的。但是在实际使用中，这并不满足的需求，因为很多情况下，我们想控制某些Pod到达某些节点上，那么应该怎么做呢？这就要求了解kubernetes对Pod的调度规则，kubernetes提供了四大类调度方式：</p></li><li><p>自动调度：运行在哪个节点上完全由Scheduler经过一系列的算法计算得出</p></li><li><p>定向调度：NodeName、NodeSelector</p></li><li><p>亲和性调度：NodeAffinity、PodAffinity、PodAntiAffinity</p></li><li><p>污点（容忍）调度：Taints、Toleration</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="541-定向调度">5.4.1 定向调度<a href="#541-定向调度" class="hash-link" aria-label="5.4.1 定向调度的直接链接" title="5.4.1 定向调度的直接链接">​</a></h5><p>定向调度，指的是利用在pod上声明nodeName或者nodeSelector，以此将Pod调度到期望的node节点上。注意，这里的调度是强制的，这就意味着即使要调度的目标Node不存在，也会向上面进行调度，只不过pod运行失败而已。</p><p><strong>NodeName</strong></p><p>NodeName用于强制约束将Pod调度到指定的Name的Node节点上。这种方式，其实是直接跳过Scheduler的调度逻辑，直接将Pod调度到指定名称的节点。</p><p>接下来，实验一下：创建一个pod-nodename.yaml文件</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodename</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">nodeName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> node1 # 指定调度到node1节点上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#创建Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodename</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodename created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#查看Pod调度到</span><span class="token constant" style="color:#36acaa">NODE</span><span class="token plain">属性，确实是调度到了node1节点上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodename </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">           </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">            </span><span class="token constant" style="color:#36acaa">NODE</span><span class="token plain">      </span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodename   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          56s   </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.87</span><span class="token plain">   node1     </span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 接下来，删除pod，修改nodeName的值为node3（并没有node3节点）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodename</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod </span><span class="token string" style="color:#e3116c">&quot;pod-nodename&quot;</span><span class="token plain"> deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># vim pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodename</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodename</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodename created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#再次查看，发现已经向Node3节点调度，但是由于不存在node3节点，所以pod无法正常运行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodename </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">           </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">       </span><span class="token constant" style="color:#36acaa">NODE</span><span class="token plain">    </span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodename   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Pending</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          6s    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none   node3   </span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain">           </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>NodeSelector</strong></p><p>NodeSelector用于将pod调度到添加了指定标签的node节点上。它是通过kubernetes的label-selector机制实现的，也就是说，在pod创建之前，会由scheduler使用MatchNodeSelector调度策略进行label匹配，找出目标node，然后将pod调度到目标节点，该匹配规则是强制约束。</p><p>接下来，实验一下：</p><p>1 首先分别为node节点添加标签</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl label nodes node1 nodeenv</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">node2 labeled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl label nodes node2 nodeenv</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">node2 labeled</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2 创建一个pod-nodeselector.yaml文件，并使用它创建Pod</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodeselector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">nodeSelector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">nodeenv</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pro # 指定调度到具有nodeenv</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pro标签的节点上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#创建Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodeselector</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodeselector created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#查看Pod调度到</span><span class="token constant" style="color:#36acaa">NODE</span><span class="token plain">属性，确实是调度到了node1节点上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodeselector </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">               </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">     </span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">          </span><span class="token constant" style="color:#36acaa">NODE</span><span class="token plain">    </span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodeselector   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          47s   </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.87</span><span class="token plain">   node1   </span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 接下来，删除pod，修改nodeSelector的值为nodeenv</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> xxxx（不存在打有此标签的节点）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodeselector</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod </span><span class="token string" style="color:#e3116c">&quot;pod-nodeselector&quot;</span><span class="token plain"> deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># vim pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodeselector</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodeselector</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodeselector created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#再次查看，发现pod无法正常运行</span><span class="token punctuation" style="color:#393A34">,</span><span class="token maybe-class-name">Node的值为none</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">               </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">     </span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">       </span><span class="token constant" style="color:#36acaa">NODE</span><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodeselector   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Pending</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2m20s   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看详情</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">发现node selector匹配失败的提示</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl describe pods pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodeselector </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Events</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Type</span><span class="token plain">     </span><span class="token maybe-class-name">Reason</span><span class="token plain">            </span><span class="token maybe-class-name">Age</span><span class="token plain">        </span><span class="token maybe-class-name">From</span><span class="token plain">               </span><span class="token maybe-class-name">Message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">            </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">       </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">               </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">Warning</span><span class="token plain">  </span><span class="token maybe-class-name">FailedScheduling</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">unknown  </span><span class="token keyword module" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">scheduler  </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> nodes are available</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> didn&#x27;t match node selector</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="542-亲和性调度">5.4.2 亲和性调度<a href="#542-亲和性调度" class="hash-link" aria-label="5.4.2 亲和性调度的直接链接" title="5.4.2 亲和性调度的直接链接">​</a></h5><p>上一节，介绍了两种定向调度的方式，使用起来非常方便，但是也有一定的问题，那就是如果没有满足条件的Node，那么Pod将不会被运行，即使在集群中还有可用Node列表也不行，这就限制了它的使用场景。</p><p>基于上面的问题，kubernetes还提供了一种亲和性调度（Affinity）。它在NodeSelector的基础之上的进行了扩展，可以通过配置的形式，实现优先选择满足条件的Node进行调度，如果没有，也可以调度到不满足条件的节点上，使调度更加灵活。</p><p>Affinity主要分为三类：</p></li><li><p>nodeAffinity(node亲和性）: 以node为目标，解决pod可以调度到哪些node的问题</p></li><li><p>podAffinity(pod亲和性) : 以pod为目标，解决pod可以和哪些已存在的pod部署在同一个拓扑域中的问题</p></li><li><p>podAntiAffinity(pod反亲和性) : 以pod为目标，解决pod不能和哪些已存在pod部署在同一个拓扑域中的问题</p><p> 关于亲和性(反亲和性)使用场景的说明：</p><p> <strong>亲和性</strong>：如果两个应用频繁交互，那就有必要利用亲和性让两个应用的尽可能的靠近，这样可以减少因网络通信而带来的性能损耗。</p><p> <strong>反亲和性</strong>：当应用的采用多副本部署时，有必要采用反亲和性让各个应用实例打散分布在各个node上，这样可以提高服务的高可用性。</p><p><strong>NodeAffinity</strong></p><p>首先来看一下<code>NodeAffinity</code>的可配置项：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">affinity</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">nodeAffinity</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  requiredDuringSchedulingIgnoredDuringExecution  </span><span class="token maybe-class-name">Node节点必须满足指定的所有规则才可以，相当于硬限制</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nodeSelectorTerms  节点选择列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      matchFields   按节点字段列出的节点选择器要求列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      matchExpressions   </span><span class="token function" style="color:#d73a49">按节点标签列出的节点选择器要求列表</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">推荐</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        key    键</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        values 值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        operat or 关系符 支持Exists</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">DoesNotExist</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">In</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">NotIn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">Gt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">Lt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  preferredDuringSchedulingIgnoredDuringExecution </span><span class="token function" style="color:#d73a49">优先调度到满足指定的规则的Node，相当于软限制</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">倾向</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    preference   一个节点选择器项，与相应的权重相关联</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      matchFields   按节点字段列出的节点选择器要求列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      matchExpressions   </span><span class="token function" style="color:#d73a49">按节点标签列出的节点选择器要求列表</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">推荐</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        key    键</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        values 值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        operator 关系符 支持In</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">NotIn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">Exists</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">DoesNotExist</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">Gt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">Lt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    weight 倾向权重，在范围</span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">100</span><span class="token plain">。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">关系符的使用说明</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>matchExpressions:</p><ul><li>key: nodeenv              # 匹配存在标签的key为nodeenv的节点
operator: Exists</li><li>key: nodeenv              # 匹配标签的key为nodeenv,且value是&quot;xxx&quot;或&quot;yyy&quot;的节点
operator: In
values: <!-- -->[&quot;xxx&quot;,&quot;yyy&quot;]</li><li>key: nodeenv              # 匹配标签的key为nodeenv,且value大于&quot;xxx&quot;的节点
operator: Gt
values: &quot;xxx&quot;</li></ul><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">接下来首先演示一下</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">创建pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodeaffinity</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">required</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>apiVersion: v1
kind: Pod
metadata:
name: pod-nodeaffinity-required
namespace: dev
spec:
containers:</p><ul><li>name: nginx
image: nginx:1.17.1
affinity:  #亲和性设置
nodeAffinity: #设置node亲和性
requiredDuringSchedulingIgnoredDuringExecution: # 硬限制
nodeSelectorTerms:<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> matchExpressions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 匹配env的值在</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;xxx&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;yyy&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">中的标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> key</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nodeenv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">operator</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">In</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">values</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;xxx&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;yyy&quot;</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h1>创建pod</h1><p>[root@k8s-master01 ~]<!-- --># kubectl create -f pod-nodeaffinity-required.yaml
pod/pod-nodeaffinity-required created</p><h1>查看pod状态 （运行失败）</h1><p>[root@k8s-master01 ~]<!-- --># kubectl get pods pod-nodeaffinity-required -n dev -o wide
NAME                        READY   STATUS    RESTARTS   AGE   IP       NODE    ......
pod-nodeaffinity-required   0/1     Pending   0          16s   &lt;none   &lt;none  ......</p><h1>查看Pod的详情</h1><h1>发现调度失败，提示node选择失败</h1><p>[root@k8s-master01 ~]<!-- --># kubectl describe pod pod-nodeaffinity-required -n dev
......
Warning  FailedScheduling  &lt;unknown  default-scheduler  0/3 nodes are available: 3 node(s) didn&#x27;t match node selector.
Warning  FailedScheduling  &lt;unknown  default-scheduler  0/3 nodes are available: 3 node(s) didn&#x27;t match node selector.</p><p>#接下来，停止pod
<!-- -->[root@k8s-master01 ~]<!-- --># kubectl delete -f pod-nodeaffinity-required.yaml
pod &quot;pod-nodeaffinity-required&quot; deleted</p><h1>修改文件，将values: <!-- -->[&quot;xxx&quot;,&quot;yyy&quot;]<!-- -->------ <!-- -->[&quot;pro&quot;,&quot;yyy&quot;]</h1><p>[root@k8s-master01 ~]<!-- --># vim pod-nodeaffinity-required.yaml</p><h1>再次启动</h1><p>[root@k8s-master01 ~]<!-- --># kubectl create -f pod-nodeaffinity-required.yaml
pod/pod-nodeaffinity-required created</p><h1>此时查看，发现调度成功，已经将pod调度到了node1上</h1><p>[root@k8s-master01 ~]<!-- --># kubectl get pods pod-nodeaffinity-required -n dev -o wide
NAME                        READY   STATUS    RESTARTS   AGE   IP            NODE  ......
pod-nodeaffinity-required   1/1     Running   0          11s   10.244.1.89   node1 ......</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">接下来再演示一下</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">创建pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodeaffinity</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">preferred</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>apiVersion: v1
kind: Pod
metadata:
name: pod-nodeaffinity-preferred
namespace: dev
spec:
containers:</p><ul><li>name: nginx
image: nginx:1.17.1
affinity:  #亲和性设置
nodeAffinity: #设置node亲和性
preferredDuringSchedulingIgnoredDuringExecution: # 软限制<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">-</span><span class="token plain"> weight</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">preference</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">matchExpressions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 匹配env的值在</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;xxx&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;yyy&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token function" style="color:#d73a49">中的标签</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">当前环境没有</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> key</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nodeenv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">operator</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">In</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">values</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;xxx&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;yyy&quot;</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h1>创建pod</h1><p>[root@k8s-master01 ~]<!-- --># kubectl create -f pod-nodeaffinity-preferred.yaml
pod/pod-nodeaffinity-preferred created</p><h1>查看pod状态 （运行成功）</h1><p>[root@k8s-master01 ~]<!-- --># kubectl get pod pod-nodeaffinity-preferred -n dev
NAME                         READY   STATUS    RESTARTS   AGE
pod-nodeaffinity-preferred   1/1     Running   0          40s
NodeAffinity规则设置的注意事项：
1 如果同时定义了nodeSelector和nodeAffinity，那么必须两个条件都得到满足，Pod才能运行在指定的Node上
2 如果nodeAffinity指定了多个nodeSelectorTerms，那么只需要其中一个能够匹配成功即可
3 如果一个nodeSelectorTerms中有多个matchExpressions ，则一个节点必须满足所有的才能匹配成功
4 如果一个pod所在的Node在Pod运行期间其标签发生了改变，不再符合该Pod的节点亲和性需求，则系统将忽略此变化</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">**</span><span class="token maybe-class-name">PodAffinity</span><span class="token operator" style="color:#393A34">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">PodAffinity主要实现以运行的Pod为参照，实现让新创建的Pod跟参照pod在一个区域的功能。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">首先来看一下</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">PodAffinity</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">的可配置项：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>pod.spec.affinity.podAffinity
requiredDuringSchedulingIgnoredDuringExecution  硬限制
namespaces       指定参照pod的namespace
topologyKey      指定调度作用域
labelSelector    标签选择器
matchExpressions  按节点标签列出的节点选择器要求列表(推荐)
key    键
values 值
operator 关系符 支持In, NotIn, Exists, DoesNotExist.
matchLabels    指多个matchExpressions映射的内容
preferredDuringSchedulingIgnoredDuringExecution 软限制
podAffinityTerm  选项
namespaces<br>
<!-- -->topologyKey
labelSelector
matchExpressions<br>
<!-- -->key    键
values 值
operator
matchLabels
weight 倾向权重，在范围1-100
topologyKey用于指定调度时作用域,例如:
如果指定为kubernetes.io/hostname，那就是以Node节点为区分范围
如果指定为beta.kubernetes.io/os,则以Node节点的操作系统类型来区分</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">接下来，演示下</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">1</span><span class="token plain">）首先创建一个参照Pod，pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">podaffinity</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>apiVersion: v1
kind: Pod
metadata:
name: pod-podaffinity-target
namespace: dev
labels:
podenv: pro #设置标签
spec:
containers:</p><ul><li>name: nginx
image: nginx:1.17.1
nodeName: node1 # 将目标pod名确指定到node1上</li></ul><h1>启动目标pod</h1><p>[root@k8s-master01 ~]<!-- --># kubectl create -f pod-podaffinity-target.yaml
pod/pod-podaffinity-target created</p><h1>查看pod状况</h1><p>[root@k8s-master01 ~]<!-- --># kubectl get pods  pod-podaffinity-target -n dev
NAME                     READY   STATUS    RESTARTS   AGE
pod-podaffinity-target   1/1     Running   0          4s</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">）创建pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">podaffinity</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">required</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml，内容如下：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>apiVersion: v1
kind: Pod
metadata:
name: pod-podaffinity-required
namespace: dev
spec:
containers:</p><ul><li>name: nginx
image: nginx:1.17.1
affinity:  #亲和性设置
podAffinity: #设置pod亲和性
requiredDuringSchedulingIgnoredDuringExecution: # 硬限制<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">-</span><span class="token plain"> labelSelector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">matchExpressions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 匹配env的值在</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;xxx&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;yyy&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">中的标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> key</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> podenv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">operator</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">In</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">values</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;xxx&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;yyy&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">topologyKey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> kubernetes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">hostname</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">上面配置表达的意思是：新Pod必须要与拥有标签nodeenv</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">xxx或者nodeenv</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">yyy的pod在同一Node上，显然现在没有这样pod，接下来，运行测试一下。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>启动pod</h1><p>[root@k8s-master01 ~]<!-- --># kubectl create -f pod-podaffinity-required.yaml
pod/pod-podaffinity-required created</p><h1>查看pod状态，发现未运行</h1><p>[root@k8s-master01 ~]<!-- --># kubectl get pods pod-podaffinity-required -n dev
NAME                       READY   STATUS    RESTARTS   AGE
pod-podaffinity-required   0/1     Pending   0          9s</p><h1>查看详细信息</h1><p>[root@k8s-master01 ~]<!-- --># kubectl describe pods pod-podaffinity-required  -n dev
......
Events:
Type     Reason            Age        From               Message</p><hr><p>  Warning  FailedScheduling  &lt;unknown  default-scheduler  0/3 nodes are available: 2 node(s) didn&#x27;t match pod affinity rules, 1 node(s) had taints that the pod didn&#x27;t tolerate.</p><h1>接下来修改  values: <!-- -->[&quot;xxx&quot;,&quot;yyy&quot;]<!-- -->-----values:<!-- -->[&quot;pro&quot;,&quot;yyy&quot;]</h1><h1>意思是：新Pod必须要与拥有标签nodeenv=xxx或者nodeenv=yyy的pod在同一Node上</h1><p>[root@k8s-master01 ~]<!-- --># vim pod-podaffinity-required.yaml</p><h1>然后重新创建pod，查看效果</h1><p>[root@k8s-master01 ~]<!-- --># kubectl delete -f  pod-podaffinity-required.yaml
pod &quot;pod-podaffinity-required&quot; de leted
<!-- -->[root@k8s-master01 ~]<!-- --># kubectl create -f pod-podaffinity-required.yaml
pod/pod-podaffinity-required created</p><h1>发现此时Pod运行正常</h1><p>[root@k8s-master01 ~]<!-- --># kubectl get pods pod-podaffinity-required -n dev
NAME                       READY   STATUS    RESTARTS   AGE   LABELS
pod-podaffinity-required   1/1     Running   0          6s    &lt;none</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">关于</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">PodAffinity</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">的 </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">，这里不再演示。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">**</span><span class="token maybe-class-name">PodAntiAffinity</span><span class="token operator" style="color:#393A34">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">PodAntiAffinity主要实现以运行的Pod为参照，让新创建的Pod跟参照pod不在一个区域中的功能。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">它的配置方式和选项跟PodAffinty是一样的，这里不再做详细解释，直接做一个测试案例。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">1</span><span class="token plain">）继续使用上个案例中目标pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>[root@k8s-master01 ~]<!-- --># kubectl get pods -n dev -o wide --show-labels
NAME                     READY   STATUS    RESTARTS   AGE     IP            NODE    LABELS
pod-podaffinity-required 1/1     Running   0          3m29s   10.244.1.38   node1   &lt;none<br>
<!-- -->pod-podaffinity-target   1/1     Running   0          9m25s   10.244.1.37   node1   podenv=pro</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">）创建pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">podantiaffinity</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">required</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml，内容如下：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>apiVersion: v1
kind: Pod
metadata:
name: pod-podantiaffinity-required
namespace: dev
spec:
containers:</p><ul><li>name: nginx
image: nginx:1.17.1
affinity:  #亲和性设置
podAntiAffinity: #设置pod亲和性
requiredDuringSchedulingIgnoredDuringExecution: # 硬限制<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">-</span><span class="token plain"> labelSelector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">matchExpressions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 匹配podenv的值在</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;pro&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">中的标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> key</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> podenv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">operator</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">In</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">values</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;pro&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">topologyKey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> kubernetes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">hostname</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">上面配置表达的意思是：新Pod必须要与拥有标签nodeenv</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pro的pod不在同一Node上，运行测试一下。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>创建pod</h1><p>[root@k8s-master01 ~]<!-- --># kubectl create -f pod-podantiaffinity-required.yaml
pod/pod-podantiaffinity-required created</p><h1>查看pod</h1><h1>发现调度到了node2上</h1><p>[root@k8s-master01 ~]<!-- --># kubectl get pods pod-podantiaffinity-required -n dev -o wide
NAME                           READY   STATUS    RESTARTS   AGE   IP            NODE   ..
pod-podantiaffinity-required   1/1     Running   0          30s   10.244.1.96   node2  ..</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##### </span><span class="token number" style="color:#36acaa">5.4</span><span class="token number" style="color:#36acaa">.3</span><span class="token plain"> 污点和容忍</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">**</span><span class="token plain">污点（Taints）</span><span class="token operator" style="color:#393A34">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">前面的调度方式都是站在Pod的角度上，通过在Pod上添加属性，来确定Pod是否要调度到指定的Node上，其实我们也可以站在Node的角度上，通过在Node上添加</span><span class="token operator" style="color:#393A34">**</span><span class="token plain">污点</span><span class="token operator" style="color:#393A34">**</span><span class="token plain">属性，来决定是否允许Pod调度过来。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Node被设置上污点之后就和Pod之间存在了一种相斥的关系，进而拒绝Pod调度进来，甚至可以将已经存在的Pod驱逐出去。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">污点的格式为：</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">key=value:effect</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> key和value是污点的标签，effect描述污点的作用，支持如下三个选项：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>PreferNoSchedule：kubernetes将尽量避免把Pod调度到具有该污点的Node上，除非没有其他节点可调度</p></li><li><p>NoSchedule：kubernetes将不会把Pod调度到具有该污点的Node上，但不会影响当前Node上已存在的Pod</p></li><li><p>NoExecute：kubernetes将不会把Pod调度到具有该污点的Node上，同时也会将Node上已存在的Pod驱离</p><p><img loading="lazy" alt="image-20200605021606508" src="/blog/assets/images/image-20200605021831545-d54a4ff058d0939d6ab6edf78cd6ad47.png" width="692" height="147" class="img_ev3q"></p><p>使用kubectl设置和去除污点的命令示例如下：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 设置污点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl taint nodes node1 key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">value</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">effect</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 去除污点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl taint nodes node1 key</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">effect</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 去除所有污点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl taint nodes node1 key</span><span class="token operator" style="color:#393A34">-</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接下来，演示下污点的效果：</p></li></ul><ol><li><p>准备节点node1（为了演示效果更加明显，暂时停止node2节点）</p></li><li><p>为node1节点设置一个污点: <code>tag=heima:PreferNoSchedule</code>；然后创建pod1( pod1 可以 )</p></li><li><p>修改为node1节点设置一个污点: <code>tag=heima:NoSchedule</code>；然后创建pod2( pod1 正常 pod2 失败 )</p></li><li><p>修改为node1节点设置一个污点: <code>tag=heima:NoExecute</code>；然后创建pod3 ( 3个pod都失败 )</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token function" style="color:#d73a49">为node1设置污点</span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">PreferNoSchedule</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl taint nodes node1 tag</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">heima</span><span class="token operator" style="color:#393A34">:</span><span class="token maybe-class-name">PreferNoSchedule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建pod1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl run taint1 </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">image</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                      </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">     </span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">           </span><span class="token constant" style="color:#36acaa">NODE</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">taint1</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">7665f7fd85</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">574h4   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2m24s   </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.59</span><span class="token plain">   node1    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token function" style="color:#d73a49">为node1设置污点</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">取消PreferNoSchedule，设置NoSchedule</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl taint nodes node1 tag</span><span class="token operator" style="color:#393A34">:</span><span class="token maybe-class-name">PreferNoSchedule</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl taint nodes node1 tag</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">heima</span><span class="token operator" style="color:#393A34">:</span><span class="token maybe-class-name">NoSchedule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建pod2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl run taint2 </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">image</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods taint2 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                      </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">     </span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">            </span><span class="token constant" style="color:#36acaa">NODE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">taint1</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">7665f7fd85</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">574h4   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2m24s   </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.59</span><span class="token plain">   node1 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">taint2</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">544694789</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6zmlf    </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Pending</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          21s     </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token function" style="color:#d73a49">为node1设置污点</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">取消NoSchedule，设置NoExecute</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl taint nodes node1 tag</span><span class="token operator" style="color:#393A34">:</span><span class="token maybe-class-name">NoSchedule</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl taint nodes node1 tag</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">heima</span><span class="token operator" style="color:#393A34">:</span><span class="token maybe-class-name">NoExecute</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建pod3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl run taint3 </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">image</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                      </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">       </span><span class="token constant" style="color:#36acaa">NODE</span><span class="token plain">     </span><span class="token constant" style="color:#36acaa">NOMINATED</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">taint1</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">7665f7fd85</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">htkmp   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Pending</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          35s   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">taint2</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">544694789</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">bn7wb    </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Pending</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          35s   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">taint3</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6d78dbd749</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">tktkq   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Pending</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          6s    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">小提示：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    使用kubeadm搭建的集群，默认就会给master节点添加一个污点标记</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">所以pod就不会调度到master节点上</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>容忍（Toleration）</strong></p><p>上面介绍了污点的作用，我们可以在node上添加污点用于拒绝pod调度上来，但是如果就是想将一个pod调度到一个有污点的node上去，这时候应该怎么做呢？这就要使用到<strong>容忍</strong>。</p><p><img loading="lazy" alt="image-20200514095913741" src="/blog/assets/images/image-20200514095913741-bd01d64b1c447f37aad7627af0a15c49.png" width="1019" height="336" class="img_ev3q"></p><p> 污点就是拒绝，容忍就是忽略，Node通过污点拒绝pod调度上去，Pod通过容忍忽略拒绝</p><p>下面先通过一个案例看下效果：</p></li><li><p>上一小节，已经在node1节点上打上了<code>NoExecute</code>的污点，此时pod是调度不上去的</p></li><li><p>本小节，可以通过给pod添加容忍，然后将其调度上去</p><p>创建pod-toleration.yaml,内容如下</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">toleration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><ul><li><p>name: nginx
image: nginx:1.17.1
tolerations:      # 添加容忍</p></li><li><p>key: &quot;tag&quot;        # 要容忍的污点的key
operator: &quot;Equal&quot; # 操作符
value: &quot;heima&quot;    # 容忍的污点的value
effect: &quot;NoExecute&quot;   # 添加容忍的规则，这里必须和标记的污点规则相同</p><h1>添加容忍之前的pod</h1><p>[root@k8s-master01 ~]<!-- --># kubectl get pods -n dev -o wide
NAME             READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED
pod-toleration   0/1     Pending   0          3s    &lt;none   &lt;none   &lt;none           </p><h1>添加容忍之后的pod</h1><p>[root@k8s-master01 ~]<!-- --># kubectl get pods -n dev -o wide
NAME             READY   STATUS    RESTARTS   AGE   IP            NODE    NOMINATED
pod-toleration   1/1     Running   0          3s    10.244.1.62   node1   &lt;none        </p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">下面看一下容忍的详细配置</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>[root@k8s-master01 ~]<!-- --># kubectl explain pod.spec.tolerations
......
FIELDS:
key       # 对应着要容忍的污点的键，空意味着匹配所有的键
value     # 对应着要容忍的污点的值
operator  # key-value的运算符，支持Equal和Exists（默认）
effect    # 对应污点的effect，空意味着匹配所有影响
tolerationSeconds   # 容忍时间, 当effect为NoExecute时生效，表示pod在Node上的停留时间</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### </span><span class="token number" style="color:#36acaa">6.</span><span class="token plain"> </span><span class="token maybe-class-name">Pod控制器详解</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### </span><span class="token number" style="color:#36acaa">6.1</span><span class="token plain"> </span><span class="token maybe-class-name">Pod控制器介绍</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Pod是kubernetes的最小管理单元，在kubernetes中，按照pod的创建方式可以将其分为两类：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>自主式pod：kubernetes直接创建出来的Pod，这种pod删除后就没有了，也不会重建</p></li><li><p>控制器创建的pod：kubernetes通过控制器创建的pod，这种pod删除了之后还会自动重建</p><p> <strong><code>什么是Pod控制器</code></strong></p><p> Pod控制器是管理pod的中间层，使用Pod控制器之后，只需要告诉Pod控制器，想要多少个什么样的Pod就可以了，它会创建出满足条件的Pod并确保每一个Pod资源处于用户期望的目标状态。如果Pod资源在运行中出现故障，它会基于指定策略重新编排Pod。</p><p>在kubernetes中，有很多类型的pod控制器，每种都有自己的适合的场景，常见的有下面这些：</p></li><li><p>ReplicationController：比较原始的pod控制器，已经被废弃，由ReplicaSet替代</p></li><li><p>ReplicaSet：保证副本数量一直维持在期望值，并支持pod数量扩缩容，镜像版本升级</p></li><li><p>Deployment：通过控制ReplicaSet来控制Pod，并支持滚动升级、回退版本</p></li><li><p>Horizontal Pod Autoscaler：可以根据集群负载自动水平调整Pod的数量，实现削峰填谷</p></li><li><p>DaemonSet：在集群中的指定Node上运行且仅运行一个副本，一般用于守护进程类的任务</p></li><li><p>Job：它创建出来的pod只要完成任务就立即退出，不需要重启或重建，用于执行一次性任务</p></li><li><p>Cronjob：它创建的Pod负责周期性任务控制，不需要持续后台运行</p></li><li><p>StatefulSet：管理有状态应用</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="62-replicasetrs">6.2 ReplicaSet(RS)<a href="#62-replicasetrs" class="hash-link" aria-label="6.2 ReplicaSet(RS)的直接链接" title="6.2 ReplicaSet(RS)的直接链接">​</a></h4><p>ReplicaSet的主要作用是<strong>保证一定数量的pod正常运行</strong>，它会持续监听这些Pod的运行状态，一旦Pod发生故障，就会重启或重建。同时它还支持对pod数量的扩缩容和镜像版本的升降级。</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200612005334159-08331e8a22669bed9152c4e1e5bb38a3.png" width="600" height="185" class="img_ev3q"></p><p>ReplicaSet的资源清单文件：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1 # 版本号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">ReplicaSet</span><span class="token plain"> # 类型       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 元数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # rs名称 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 所属命名空间 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> #标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">controller</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 详情描述</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">replicas</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> # 副本数量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 选择器，通过它指定该控制器管理哪些pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">matchLabels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">      # </span><span class="token maybe-class-name">Labels匹配规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">matchExpressions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # </span><span class="token maybe-class-name">Expressions匹配规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token literal-property property" style="color:#36acaa">key</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> app</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">operator</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">In</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">values</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">template</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 模板，当副本数量不足时，会根据下面的模板创建pod副本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> containerPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在这里面，需要新了解的配置项就是<code>spec</code>下面几个选项：</p></li><li><p>replicas：指定副本数量，其实就是当前rs创建出来的pod的数量，默认为1</p></li><li><p>selector：选择器，它的作用是建立pod控制器和pod之间的关联关系，采用的Label Selector机制</p><p>在pod模板上定义label，在控制器上定义选择器，就可以表明当前控制器能管理哪些pod了</p></li><li><p>template：模板，就是当前控制器创建pod所使用的模板板，里面其实就是前一章学过的pod的定义</p><p><strong>创建ReplicaSet</strong></p><p>创建pc-replicaset.yaml文件，内容如下：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">ReplicaSet</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">replicas</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">matchLabels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">template</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token constant" style="color:#36acaa">DESIRED</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">期望副本数量  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token constant" style="color:#36acaa">CURRENT</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">当前副本数量  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token constant" style="color:#36acaa">READY</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">已经准备好提供服务的副本数量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> rs pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">          </span><span class="token constant" style="color:#36acaa">DESIRED</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">CURRENT</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">CONTAINERS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">IMAGES</span><span class="token plain">             </span><span class="token constant" style="color:#36acaa">SELECTOR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">     22s   nginx        nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain">       app</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看当前控制器创建出来的pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 这里发现控制器创建出来的pod的名称是在控制器名称后面拼接了</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">xxxxx随机码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                          </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6vmvt   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          54s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">fmb8f   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          54s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">snrk2   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          54s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>扩缩容</strong></p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 编辑rs的副本数量，修改spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">replicas</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">即可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl edit rs pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset edited</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                          </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6vmvt   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          114m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cftnp   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          10s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">fjlm6   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          10s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">fmb8f   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          114m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">s2whj   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          10s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">snrk2   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          114m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 当然也可以直接使用命令实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 使用scale命令实现扩缩容， 后面</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">replicas</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">n直接指定目标数量即可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl scale rs pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">replicas</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset scaled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 命令运行完毕，立即查看，发现已经有</span><span class="token number" style="color:#36acaa">4</span><span class="token plain">个开始准备退出了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                       </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">        </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6vmvt   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Terminating</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          118m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cftnp   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Terminating</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          4m17s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">fjlm6   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Terminating</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          4m17s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">fmb8f   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          118m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">s2whj   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Terminating</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          4m17s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">snrk2   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          118m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#稍等片刻，就只剩下</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">个了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                       </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">fmb8f   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          119m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">snrk2   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          119m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>镜像升级</strong></p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 编辑rs的容器镜像 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl edit rs pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset edited</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 再次查看，发现镜像版本已经变更了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> rs </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                </span><span class="token constant" style="color:#36acaa">DESIRED</span><span class="token plain">  </span><span class="token constant" style="color:#36acaa">CURRENT</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">CONTAINERS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">IMAGES</span><span class="token plain">        </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset       </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">       140m   nginx         nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.2</span><span class="token plain">  </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 同样的道理，也可以使用命令完成这个工作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> image rs rs名称 容器</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">镜像版本 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> image rs pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset nginx</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset image updated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 再次查看，发现镜像版本已经变更了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> rs </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                 </span><span class="token constant" style="color:#36acaa">DESIRED</span><span class="token plain">  </span><span class="token constant" style="color:#36acaa">CURRENT</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">CONTAINERS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">IMAGES</span><span class="token plain">            </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset        </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">       145m   nginx        nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>删除ReplicaSet</strong></p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 使用kubectl </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain">命令会删除此</span><span class="token constant" style="color:#36acaa">RS</span><span class="token plain">以及它管理的Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 在kubernetes删除</span><span class="token constant" style="color:#36acaa">RS</span><span class="token plain">前，会将</span><span class="token constant" style="color:#36acaa">RS</span><span class="token plain">的replicasclear调整为</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">，等待所有的Pod被删除后，在执行</span><span class="token constant" style="color:#36acaa">RS</span><span class="token plain">对象的删除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> rs pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pc-replicaset&quot;</span><span class="token plain"> deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">No</span><span class="token plain"> resources found </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> dev namespace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 如果希望仅仅删除</span><span class="token constant" style="color:#36acaa">RS</span><span class="token plain">对象（保留Pod），可以使用kubectl </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain">命令时添加</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">cascade</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain">选项（不推荐）。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> rs pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">cascade</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pc-replicaset&quot;</span><span class="token plain"> deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                  </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cl82j   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          75s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dslhb   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          75s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token function" style="color:#d73a49">也可以使用yaml直接删除</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">推荐</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">replicaset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pc-replicaset&quot;</span><span class="token plain"> deleted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="63-deploymentdeploy">6.3 Deployment(Deploy)<a href="#63-deploymentdeploy" class="hash-link" aria-label="6.3 Deployment(Deploy)的直接链接" title="6.3 Deployment(Deploy)的直接链接">​</a></h4><p>为了更好的解决服务编排的问题，kubernetes在V1.2版本开始，引入了Deployment控制器。值得一提的是，这种控制器并不直接管理pod，而是通过管理ReplicaSet来简介管理Pod，即：Deployment管理ReplicaSet，ReplicaSet管理Pod。所以Deployment比ReplicaSet功能更加强大。</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200612005524778-5d1dc838352b3e5bdfb4be22731b1a74.png" width="608" height="206" class="img_ev3q"></p><p>Deployment主要功能有下面几个：</p></li><li><p>支持ReplicaSet的所有功能</p></li><li><p>支持发布的停止、继续</p></li><li><p>支持滚动升级和回滚版本</p><p>Deployment的资源清单文件：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1 # 版本号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Deployment</span><span class="token plain"> # 类型       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 元数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # rs名称 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 所属命名空间 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> #标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">controller</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> deploy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 详情描述</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">replicas</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> # 副本数量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">revisionHistoryLimit</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> # 保留历史版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">paused</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> # 暂停部署，默认是</span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">progressDeadlineSeconds</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">600</span><span class="token plain"> # 部署超时时间（s），默认是</span><span class="token number" style="color:#36acaa">600</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">strategy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 策略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">RollingUpdate</span><span class="token plain"> # 滚动更新策略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">rollingUpdate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 滚动更新</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">maxSurge</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> # 最大额外可以存在的副本数，可以为百分比，也可以为整数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">maxUnavailable</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> # 最大不可用状态的 </span><span class="token maybe-class-name">Pod</span><span class="token plain"> 的最大值，可以为百分比，也可以为整数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 选择器，通过它指定该控制器管理哪些pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">matchLabels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">      # </span><span class="token maybe-class-name">Labels匹配规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">matchExpressions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # </span><span class="token maybe-class-name">Expressions匹配规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token literal-property property" style="color:#36acaa">key</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> app</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">operator</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">In</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">values</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">template</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 模板，当副本数量不足时，会根据下面的模板创建pod副本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> containerPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="631-创建deployment">6.3.1 创建deployment<a href="#631-创建deployment" class="hash-link" aria-label="6.3.1 创建deployment的直接链接" title="6.3.1 创建deployment的直接链接">​</a></h5><p>创建pc-deployment.yaml，内容如下：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Deployment</span><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">replicas</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">matchLabels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">template</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">record</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token constant" style="color:#36acaa">UP</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">TO</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">DATE</span><span class="token plain"> 最新版本的pod的数量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token constant" style="color:#36acaa">AVAILABLE</span><span class="token plain">  当前可用的pod的数量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> deploy pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">            </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">UP</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">TO</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">DATE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AVAILABLE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment   </span><span class="token number" style="color:#36acaa">3</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">3</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">           15s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 发现rs的名称是在原来deployment的名字后面添加了一个</span><span class="token number" style="color:#36acaa">10</span><span class="token plain">位数的随机串</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> rs </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                       </span><span class="token constant" style="color:#36acaa">DESIRED</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">CURRENT</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6696798b78   </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">       23s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                             </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6696798b78</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">d2c8n   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          107s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6696798b78</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">smpvp   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          107s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6696798b78</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">wvjd8   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          107s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="632-扩缩容">6.3.2 扩缩容<a href="#632-扩缩容" class="hash-link" aria-label="6.3.2 扩缩容的直接链接" title="6.3.2 扩缩容的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 变更副本数量为</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">个</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl scale deploy pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">replicas</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment scaled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> deploy pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">            </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">UP</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">TO</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">DATE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AVAILABLE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment   </span><span class="token number" style="color:#36acaa">5</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">           2m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">#  kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                             </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6696798b78</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">d2c8n   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          4m19s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6696798b78</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">jxmdq   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          94s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6696798b78</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mktqv   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          93s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6696798b78</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">smpvp   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          4m19s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6696798b78</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">wvjd8   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          4m19s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 编辑deployment的副本数量，修改spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">replicas</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">即可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl edit deploy pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment edited</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                             </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6696798b78</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">d2c8n   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          5m23s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6696798b78</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">jxmdq   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2m38s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6696798b78</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">smpvp   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          5m23s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6696798b78</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">wvjd8   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          5m23s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>镜像更新</strong></p><p>deployment支持两种更新策略:<code>重建更新</code>和<code>滚动更新</code>,可以通过<code>strategy</code>指定策略类型,支持两个属性:</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">strategy：指定新的Pod替换旧的Pod的策略， 支持两个属性：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type：指定策略类型，支持两种策略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token maybe-class-name">Recreate：在创建出新的Pod之前会先杀掉所有已存在的Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token maybe-class-name">RollingUpdate：滚动更新，就是杀死一部分，就启动一部分，在更新过程中，存在两个版本Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rollingUpdate：当type为RollingUpdate时生效，用于为RollingUpdate设置参数，支持两个属性：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    maxUnavailable：用来指定在升级过程中不可用Pod的最大数量，默认为</span><span class="token number" style="color:#36acaa">25</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    maxSurge： 用来指定在升级过程中可以超过期望的Pod的最大数量，默认为</span><span class="token number" style="color:#36acaa">25</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>重建更新</p></li></ul><ol><li><p>编辑pc-deployment.yaml,在spec节点下添加更新策略</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">strategy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 策略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Recreate</span><span class="token plain"> # 重建更新</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>创建deploy进行验证</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 变更镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> image deployment pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment nginx</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment image updated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 观察升级过程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">#  kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                             </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">5d89bdfbf9</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">65qcw   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          31s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">5d89bdfbf9</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">w5nzv   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          31s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">5d89bdfbf9</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">xpt7w   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          31s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">5d89bdfbf9</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">xpt7w   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Terminating</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          41s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">5d89bdfbf9</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">65qcw   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Terminating</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          41s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">5d89bdfbf9</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">w5nzv   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Terminating</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          41s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">675d469f8b</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">grn8z   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Pending</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">675d469f8b</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hbl4v   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Pending</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">675d469f8b</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">67nz2   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Pending</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">675d469f8b</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">grn8z   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">ContainerCreating</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">675d469f8b</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hbl4v   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">ContainerCreating</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">675d469f8b</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">67nz2   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">ContainerCreating</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">675d469f8b</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">grn8z   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">             </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          1s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">675d469f8b</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">67nz2   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">             </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          1s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">675d469f8b</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hbl4v   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">             </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>滚动更新</p></li><li><p>编辑pc-deployment.yaml,在spec节点下添加更新策略</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">strategy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 策略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">RollingUpdate</span><span class="token plain"> # 滚动更新策略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">rollingUpdate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">maxSurge</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">25</span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">maxUnavailable</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">25</span><span class="token operator" style="color:#393A34">%</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>创建deploy进行验证</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 变更镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> image deployment pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment nginx</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment image updated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 观察升级过程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                           </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c848d767</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">8rbzt   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          31m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c848d767</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">h4p68   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          31m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c848d767</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hlmz4   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          31m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c848d767</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">rrqcn   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          31m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">966bf7f44</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">226rx   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Pending</span><span class="token plain">             </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">966bf7f44</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">226rx   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">ContainerCreating</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">966bf7f44</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">226rx   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">             </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          1s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c848d767</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">h4p68    </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Terminating</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          34m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">966bf7f44</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cnd44   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Pending</span><span class="token plain">             </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">966bf7f44</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cnd44   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">ContainerCreating</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">966bf7f44</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cnd44   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">             </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c848d767</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hlmz4    </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Terminating</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          34m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">966bf7f44</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">px48p   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Pending</span><span class="token plain">             </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">966bf7f44</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">px48p   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">ContainerCreating</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">966bf7f44</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">px48p   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">             </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c848d767</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">8rbzt    </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Terminating</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          34m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">966bf7f44</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dkmqp   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Pending</span><span class="token plain">             </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">966bf7f44</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dkmqp   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">ContainerCreating</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">966bf7f44</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dkmqp   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">             </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c848d767</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">rrqcn    </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Terminating</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          34m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 至此，新版本的pod创建完毕，就版本的pod销毁完毕</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 中间过程是滚动进行的，也就是边销毁边创建</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>滚动更新的过程：</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200416140251491-444651ae9c8f6a37d1f649af8935ae65.png" width="1118" height="527" class="img_ev3q"></p><p>镜像更新中rs的变化</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 查看rs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">发现原来的rs的依旧存在，只是pod数量变为了</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">，而后又新产生了一个rs，pod数量为</span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 其实这就是deployment能够进行版本回退的奥妙所在，后面会详细解释</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> rs </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                       </span><span class="token constant" style="color:#36acaa">DESIRED</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">CURRENT</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6696798b78   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">       7m37s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6696798b11   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">       5m37s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c848d76789   </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">       72s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="633-版本回退">6.3.3 版本回退<a href="#633-版本回退" class="hash-link" aria-label="6.3.3 版本回退的直接链接" title="6.3.3 版本回退的直接链接">​</a></h5><p>deployment支持版本升级过程中的暂停、继续功能以及版本回退等诸多功能，下面具体来看.</p><p>kubectl rollout： 版本升级相关功能，支持下面的选项：</p></li></ol><ul><li><p>status 显示当前升级状态</p></li><li><p>history 显示 升级历史记录</p></li><li><p>pause 暂停版本升级过程</p></li><li><p>resume 继续已经暂停的版本升级过程</p></li><li><p>restart 重启版本升级过程</p></li><li><p>undo 回滚到上一级版本（可以使用--to-revision回滚到指定版本）</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 查看当前升级版本的状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl rollout status deploy pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment </span><span class="token string" style="color:#e3116c">&quot;pc-deployment&quot;</span><span class="token plain"> successfully rolled out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看升级历史记录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl rollout history deploy pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">REVISION</span><span class="token plain">  </span><span class="token constant" style="color:#36acaa">CHANGE</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">CAUSE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">1</span><span class="token plain">         kubectl create </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">filename</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">record</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">         kubectl create </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">filename</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">record</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">         kubectl create </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">filename</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">record</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 可以发现有三次版本记录，说明完成过两次升级</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 版本回滚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 这里直接使用</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">to</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">revision</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">回滚到了</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">版本， 如果省略这个选项，就是回退到上个版本，就是</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl rollout undo deployment pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">to</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">revision</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment rolled back</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看发现，通过nginx镜像版本可以发现到了第一版</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> deploy </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">            </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">UP</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">TO</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">DATE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AVAILABLE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">CONTAINERS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">IMAGES</span><span class="token plain">         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment   </span><span class="token number" style="color:#36acaa">4</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">4</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">           74m   nginx        nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看rs，发现第一个rs中有</span><span class="token number" style="color:#36acaa">4</span><span class="token plain">个pod运行，后面两个版本的rs中pod为运行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 其实deployment之所以可是实现版本的回滚，就是通过记录下历史rs来实现的，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 一旦想回滚到哪个版本，只需要将当前版本pod数量降为</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">，然后将回滚版本的pod提升为目标数量就可以了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> rs </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                       </span><span class="token constant" style="color:#36acaa">DESIRED</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">CURRENT</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6696798b78   </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">       78m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">966bf7f44    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">       37m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c848d767     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">       71m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="634-金丝雀发布">6.3.4 金丝雀发布<a href="#634-金丝雀发布" class="hash-link" aria-label="6.3.4 金丝雀发布的直接链接" title="6.3.4 金丝雀发布的直接链接">​</a></h5><p>Deployment控制器支持控制更新过程中的控制，如“暂停(pause)”或“继续(resume)”更新操作。</p><p>比如有一批新的Pod资源创建完成后立即暂停更新过程，此时，仅存在一部分新版本的应用，主体部分还是旧的版本。然后，再筛选一小部分的用户请求路由到新版本的Pod应用，继续观察能否稳定地按期望的方式运行。确定没问题之后再继续完成余下的Pod资源滚动更新，否则立即回滚更新操作。这就是所谓的金丝雀发布。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 更新deployment的版本，并配置暂停deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">#  kubectl </span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> image deploy pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment nginx</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> kubectl rollout pause deployment pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment image updated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment paused</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#观察更新状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl rollout status deploy pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev　</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Waiting</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> deployment </span><span class="token string" style="color:#e3116c">&quot;pc-deployment&quot;</span><span class="token plain"> rollout to finish</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> out </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">replicas</span><span class="token plain"> have been updated</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 监控更新的过程，可以看到已经新增了一个资源，但是并未按照预期的状态去删除一个旧的资源，就是因为使用了pause暂停命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> rs </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                       </span><span class="token constant" style="color:#36acaa">DESIRED</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">CURRENT</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">     </span><span class="token constant" style="color:#36acaa">CONTAINERS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">IMAGES</span><span class="token plain">         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">5d89bdfbf9   </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">       19m     nginx        nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">675d469f8b   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">       14m     nginx        nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.2</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6c9f56fcfb   </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">       3m16s   nginx        nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.4</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                             </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">5d89bdfbf9</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">rj8sq   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          7m33s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">5d89bdfbf9</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ttwgg   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          7m35s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">5d89bdfbf9</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v4wvc   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          7m34s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6c9f56fcfb</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">996rt   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          3m31s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6c9f56fcfb</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">j2gtj   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          3m31s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 确保更新的pod没问题了，继续更新</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl rollout resume deploy pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment resumed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看最后的更新情况</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> rs </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                       </span><span class="token constant" style="color:#36acaa">DESIRED</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">CURRENT</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">     </span><span class="token constant" style="color:#36acaa">CONTAINERS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">IMAGES</span><span class="token plain">         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">5d89bdfbf9   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">       21m     nginx        nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">675d469f8b   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">       16m     nginx        nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.2</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6c9f56fcfb   </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">       5m11s   nginx        nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.4</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                             </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6c9f56fcfb</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">7bfwh   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          37s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6c9f56fcfb</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">996rt   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          5m27s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6c9f56fcfb</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">j2gtj   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          5m27s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">6c9f56fcfb</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">rf84v   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          37s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>删除Deployment</strong></p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 删除deployment，其下的rs和pod也将被删除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pc-deployment&quot;</span><span class="token plain"> deleted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="64-horizontal-pod-autoscalerhpa">6.4 Horizontal Pod Autoscaler(HPA)<a href="#64-horizontal-pod-autoscalerhpa" class="hash-link" aria-label="6.4 Horizontal Pod Autoscaler(HPA)的直接链接" title="6.4 Horizontal Pod Autoscaler(HPA)的直接链接">​</a></h4><p>在前面的课程中，我们已经可以实现通过手工执行<code>kubectl scale</code>命令实现Pod扩容或缩容，但是这显然不符合Kubernetes的定位目标--自动化、智能化。 Kubernetes期望可以实现通过监测Pod的使用情况，实现pod数量的自动调整，于是就产生了Horizontal Pod Autoscaler（HPA）这种控制器。</p><p>HPA可以获取每个Pod利用率，然后和HPA中定义的指标进行对比，同时计算出需要伸缩的具体值，最后实现Pod的数量的调整。其实HPA与之前的Deployment一样，也属于一种Kubernetes资源对象，它通过追踪分析RC控制的所有目标Pod的负载变化情况，来确定是否需要针对性地调整目标Pod的副本数，这是HPA的实现原理。</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200608155858271-25cd78ed97493fa06124618899d39bc3.png" width="622" height="374" class="img_ev3q"></p><p>接下来，我们来做一个实验</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="641-安装metrics-server">6.4.1 安装metrics-server<a href="#641-安装metrics-server" class="hash-link" aria-label="6.4.1 安装metrics-server的直接链接" title="6.4.1 安装metrics-server的直接链接">​</a></h5><p>metrics-server可以用来收集集群中的资源使用情况</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 安装git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># yum install git </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 获取metrics</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 注意使用的版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># git clone </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">b v0</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">3.6</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">https</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">github</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">incubator</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">metrics</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 修改deployment</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 注意修改的是镜像和初始化参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># cd </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">root</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">metrics</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">server</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">deploy</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1.8</span><span class="token operator" style="color:#393A34">+</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token number" style="color:#36acaa">1.8</span><span class="token operator" style="color:#393A34">+</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># vim metrics</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">server</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">按图中添加下面选项</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">hostNetwork</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> registry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">cn</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hangzhou</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">aliyuncs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">google_containers</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">metrics</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">server</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">amd64</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">v0</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">3.6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">args</span><span class="token operator" style="color:#393A34">:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>--kubelet-insecure-tls</p></li><li><p>--kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">image</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">20200608163326496</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">Kubernetes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">assets</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">image</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">20200608163326496</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">png</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>安装metrics-server</h1><p>[root@k8s-master01 1.8+]<!-- --># kubectl apply -f ./</p><h1>查看pod运行情况</h1><p>[root@k8s-master01 1.8+]<!-- --># kubectl get pod -n kube-system
metrics-server-6b976979db-2xwbj   1/1     Running   0          90s</p><h1>使用kubectl top node 查看资源使用情况</h1><p>[root@k8s-master01 1.8+]<!-- --># kubectl top node
NAME           CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%
k8s-master01   289m         14%    1582Mi          54%<br>
<!-- -->k8s-node01     81m          4%     1195Mi          40%<br>
<!-- -->k8s-node02     72m          3%     1211Mi          41%<br>
<!-- -->[root@k8s-master01 1.8+]<!-- --># kubectl top pod -n kube-system
NAME                              CPU(cores)   MEMORY(bytes)
coredns-6955765f44-7ptsb          3m           9Mi
coredns-6955765f44-vcwr5          3m           8Mi
etcd-master                       14m          145Mi
...</p><h1>至此,metrics-server安装完成</h1><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##### </span><span class="token number" style="color:#36acaa">6.4</span><span class="token number" style="color:#36acaa">.2</span><span class="token plain"> 准备deployment和servie</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">创建pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hpa</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml文件，内容如下：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>apiVersion: apps/v1
kind: Deployment
metadata:
name: nginx
namespace: dev
spec:
strategy: # 策略
type: RollingUpdate # 滚动更新策略
replicas: 1
selector:
matchLabels:
app: nginx-pod
template:
metadata:
labels:
app: nginx-pod
spec:
containers:</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">resources</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 资源配额</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">limits</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  # 限制资源（上限）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">cpu</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1&quot;</span><span class="token plain"> # </span><span class="token constant" style="color:#36acaa">CPU</span><span class="token plain">限制，单位是core数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">requests</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 请求资源（下限）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">cpu</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;100m&quot;</span><span class="token plain">  # </span><span class="token constant" style="color:#36acaa">CPU</span><span class="token plain">限制，单位是core数</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>创建deployment</h1><p>[root@k8s-master01 1.8+]<!-- --># kubectl run nginx --image=nginx:1.17.1 --requests=cpu=100m -n dev</p><h1>创建service</h1><p>[root@k8s-master01 1.8+]<!-- --># kubectl expose deployment nginx --type=NodePort --port=80 -n dev</p><h1>查看</h1><p>[root@k8s-master01 1.8+]<!-- --># kubectl get deployment,pod,svc -n dev
NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/nginx   1/1     1            1           47s</p><p>NAME                         READY   STATUS    RESTARTS   AGE
pod/nginx-7df9756ccc-bh8dr   1/1     Running   0          47s</p><p>NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
service/nginx   NodePort   10.101.18.29   &lt;none        80:31830/TCP   35s</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##### </span><span class="token number" style="color:#36acaa">6.4</span><span class="token number" style="color:#36acaa">.3</span><span class="token plain"> 部署</span><span class="token constant" style="color:#36acaa">HPA</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">创建pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hpa</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml文件，内容如下：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
name: pc-hpa
namespace: dev
spec:
minReplicas: 1  #最小pod数量
maxReplicas: 10 #最大pod数量
targetCPUUtilizationPercentage: 3 # CPU使用率指标
scaleTargetRef:   # 指定要控制的nginx信息
apiVersion:  /v1
kind: Deployment
name: nginx</p><h1>创建hpa</h1><p>[root@k8s-master01 1.8+]<!-- --># kubectl create -f pc-hpa.yaml
horizontalpodautoscaler.autoscaling/pc-hpa created</p><h1>查看hpa</h1><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token number" style="color:#36acaa">1.8</span><span class="token operator" style="color:#393A34">+</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> hpa </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>NAME     REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
pc-hpa   Deployment/nginx   0%/3%     1         10        1          62s</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##### </span><span class="token number" style="color:#36acaa">6.4</span><span class="token number" style="color:#36acaa">.4</span><span class="token plain"> 测试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">使用压测工具对service地址</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">192.168.5.4:31830</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">进行压测，然后通过控制台查看hpa和pod的变化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hpa变化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>[root@k8s-master01 ~]<!-- --># kubectl get hpa -n dev -w
NAME   REFERENCE      TARGETS  MINPODS  MAXPODS  REPLICAS  AGE
pc-hpa  Deployment/nginx  0%/3%   1     10     1      4m11s
pc-hpa  Deployment/nginx  0%/3%   1     10     1      5m19s
pc-hpa  Deployment/nginx  22%/3%   1     10     1      6m50s
pc-hpa  Deployment/nginx  22%/3%   1     10     4      7m5s
pc-hpa  Deployment/nginx  22%/3%   1     10     8      7m21s
pc-hpa  Deployment/nginx  6%/3%   1     10     8      7m51s
pc-hpa  Deployment/nginx  0%/3%   1     10     8      9m6s
pc-hpa  Deployment/nginx  0%/3%   1     10     8      13m
pc-hpa  Deployment/nginx  0%/3%   1     10     1      14m</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment变化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>[root@k8s-master01 ~]<!-- --># kubectl get deployment -n dev -w
NAME    READY   UP-TO-DATE   AVAILABLE   AGE
nginx   1/1     1            1           11m
nginx   1/4     1            1           13m
nginx   1/4     1            1           13m
nginx   1/4     1            1           13m
nginx   1/4     4            1           13m
nginx   1/8     4            1           14m
nginx   1/8     4            1           14m
nginx   1/8     4            1           14m
nginx   1/8     8            1           14m
nginx   2/8     8            2           14m
nginx   3/8     8            3           14m
nginx   4/8     8            4           14m
nginx   5/8     8            5           14m
nginx   6/8     8            6           14m
nginx   7/8     8            7           14m
nginx   8/8     8            8           15m
nginx   8/1     8            8           20m
nginx   8/1     8            8           20m
nginx   1/1     1            1           20m</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod变化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>[root@k8s-master01 ~]<!-- --># kubectl get pods -n dev -w
NAME                     READY   STATUS    RESTARTS   AGE
nginx-7df9756ccc-bh8dr   1/1     Running   0          11m
nginx-7df9756ccc-cpgrv   0/1     Pending   0          0s
nginx-7df9756ccc-8zhwk   0/1     Pending   0          0s
nginx-7df9756ccc-rr9bn   0/1     Pending   0          0s
nginx-7df9756ccc-cpgrv   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-8zhwk   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-rr9bn   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-m9gsj   0/1     Pending             0          0s
nginx-7df9756ccc-g56qb   0/1     Pending             0          0s
nginx-7df9756ccc-sl9c6   0/1     Pending             0          0s
nginx-7df9756ccc-fgst7   0/1     Pending             0          0s
nginx-7df9756ccc-g56qb   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-m9gsj   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-sl9c6   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-fgst7   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-8zhwk   1/1     Running             0          19s
nginx-7df9756ccc-rr9bn   1/1     Running             0          30s
nginx-7df9756ccc-m9gsj   1/1     Running             0          21s
nginx-7df9756ccc-cpgrv   1/1     Running             0          47s
nginx-7df9756ccc-sl9c6   1/1     Running             0          33s
nginx-7df9756ccc-g56qb   1/1     Running             0          48s
nginx-7df9756ccc-fgst7   1/1     Running             0          66s
nginx-7df9756ccc-fgst7   1/1     Terminating         0          6m50s
nginx-7df9756ccc-8zhwk   1/1     Terminating         0          7m5s
nginx-7df9756ccc-cpgrv   1/1     Terminating         0          7m5s
nginx-7df9756ccc-g56qb   1/1     Terminating         0          6m50s
nginx-7df9756ccc-rr9bn   1/1     Terminating         0          7m5s
nginx-7df9756ccc-m9gsj   1/1     Terminating         0          6m50s
nginx-7df9756ccc-sl9c6   1/1     Terminating         0          6m50s</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### </span><span class="token number" style="color:#36acaa">6.5</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">DaemonSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">DS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">DaemonSet类型的控制器可以保证在集群中的每一台（或指定）节点上都运行一个副本。一般适用于日志收集、节点监控等场景。也就是说，如果一个Pod提供的功能是节点级别的（每个节点都需要且只需要一个），那么这类Pod就适合使用DaemonSet类型的控制器创建。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">img</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">Kubernetes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">assets</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">image</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">20200612010223537</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">png</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">DaemonSet控制器的特点：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>每当向集群中添加一个节点时，指定的 Pod 副本也将添加到该节点上</p></li><li><p>当节点从集群中移除时，Pod 也就被垃圾回收了</p><p>下面先来看下DaemonSet的资源清单文件</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1 # 版本号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">DaemonSet</span><span class="token plain"> # 类型       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 元数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # rs名称 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 所属命名空间 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> #标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">controller</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> daemonset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 详情描述</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">revisionHistoryLimit</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> # 保留历史版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">updateStrategy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 更新策略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">RollingUpdate</span><span class="token plain"> # 滚动更新策略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">rollingUpdate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 滚动更新</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">maxUnavailable</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> # 最大不可用状态的 </span><span class="token maybe-class-name">Pod</span><span class="token plain"> 的最大值，可以为百分比，也可以为整数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 选择器，通过它指定该控制器管理哪些pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">matchLabels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">      # </span><span class="token maybe-class-name">Labels匹配规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">matchExpressions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # </span><span class="token maybe-class-name">Expressions匹配规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token literal-property property" style="color:#36acaa">key</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> app</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">operator</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">In</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">values</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">template</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 模板，当副本数量不足时，会根据下面的模板创建pod副本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> containerPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>创建pc-daemonset.yaml，内容如下：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">DaemonSet</span><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">daemonset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">matchLabels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">template</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建daemonset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f  pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">daemonset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">daemonset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">daemonset created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看daemonset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">#  kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> ds </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">        </span><span class="token constant" style="color:#36acaa">DESIRED</span><span class="token plain">  </span><span class="token constant" style="color:#36acaa">CURRENT</span><span class="token plain">  </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">  </span><span class="token constant" style="color:#36acaa">UP</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">TO</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">DATE</span><span class="token plain">  </span><span class="token constant" style="color:#36acaa">AVAILABLE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">CONTAINERS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">IMAGES</span><span class="token plain">         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">daemonset   </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">        24s   nginx        nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">发现在每个Node上都运行一个pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">#  kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                 </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">            </span><span class="token constant" style="color:#36acaa">NODE</span><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">daemonset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">9bck8   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          37s   </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.43</span><span class="token plain">   node1     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">daemonset</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">k224w   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          37s   </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.74</span><span class="token plain">   node2      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 删除daemonset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">daemonset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">daemonset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pc-daemonset&quot;</span><span class="token plain"> deleted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="66-job">6.6 Job<a href="#66-job" class="hash-link" aria-label="6.6 Job的直接链接" title="6.6 Job的直接链接">​</a></h4><p>Job，主要用于负责<strong>批量处理(一次要处理指定数量任务)</strong>短暂的<strong>一次性(每个任务仅运行一次就结束)</strong>任务。Job特点如下：</p></li><li><p>当Job创建的pod执行成功结束时，Job将记录成功结束的pod数量</p></li><li><p>当成功结束的pod达到指定的数量时，Job将完成执行</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200618213054113-6974b0a67cf6cb79814dbf98d1a3f43b.png" width="801" height="254" class="img_ev3q"></p><p>Job的资源清单文件：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> batch</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1 # 版本号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Job</span><span class="token plain"> # 类型       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 元数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # rs名称 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 所属命名空间 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> #标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">controller</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 详情描述</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">completions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> # 指定job需要成功运行Pods的次数。默认值</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">parallelism</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> # 指定job在任一时刻应该并发运行Pods的数量。默认值</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">activeDeadlineSeconds</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> # 指定job可运行的时间期限，超过时间还未结束，系统将会尝试进行终止。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">backoffLimit</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> # 指定job失败后进行重试的次数。默认是</span><span class="token number" style="color:#36acaa">6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">manualSelector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> # 是否可以使用selector选择器选择pod，默认是</span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 选择器，通过它指定该控制器管理哪些pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">matchLabels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">      # </span><span class="token maybe-class-name">Labels匹配规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> counter</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">matchExpressions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # </span><span class="token maybe-class-name">Expressions匹配规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token literal-property property" style="color:#36acaa">key</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> app</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">operator</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">In</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">values</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">counter</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">template</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 模板，当副本数量不足时，会根据下面的模板创建pod副本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> counter</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">restartPolicy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Never</span><span class="token plain"> # 重启策略只能设置为Never或者OnFailure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> busybox</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">command</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;bin/sh&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;-c&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 2;done&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">关于重启策略设置的说明：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    如果指定为OnFailure，则job会在pod出现故障时重启容器，而不是创建pod，failed次数不变</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    如果指定为Never，则job会在pod出现故障时创建新的pod，并且故障pod不会消失，也不会重启，failed次数加</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    如果指定为Always的话，就意味着一直重启，意味着job任务会重复去执行了，当然不对，所以不能设置为Always</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>创建pc-job.yaml，内容如下：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> batch</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Job</span><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">manualSelector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">matchLabels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> counter</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">template</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> counter</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">restartPolicy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Never</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> busybox</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">command</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;bin/sh&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;-c&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">job</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">batch</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> job </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">     </span><span class="token constant" style="color:#36acaa">COMPLETIONS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">DURATION</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">CONTAINERS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">IMAGES</span><span class="token plain">         </span><span class="token constant" style="color:#36acaa">SELECTOR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           21s        21s   counter      busybox</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.30</span><span class="token plain">   app</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">counter</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           31s        79s   counter      busybox</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.30</span><span class="token plain">   app</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">counter</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 通过观察pod状态可以看到，pod在运行完毕任务后，就会变成Completed状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">           </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">     </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">      </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">rxg96   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">            29s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">rxg96   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Completed</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">            33s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 接下来，调整下pod运行的总数量和并行数量 即：在spec下设置下面两个选项</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#  completions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> # 指定job需要成功运行Pods的次数为</span><span class="token number" style="color:#36acaa">6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#  parallelism</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> # 指定job并发运行Pods的数量为</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#  然后重新运行job，观察效果，此时会发现，job会每次运行</span><span class="token number" style="color:#36acaa">3</span><span class="token plain">个pod，总共执行了</span><span class="token number" style="color:#36acaa">6</span><span class="token plain">个pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">           </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">684ft   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">jhj49   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pfcvh   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">684ft   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Completed</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          11s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v7rhr   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Pending</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v7rhr   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Pending</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v7rhr   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">ContainerCreating</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">jhj49   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Completed</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          11s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">fhwf7   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Pending</span><span class="token plain">             </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">fhwf7   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Pending</span><span class="token plain">             </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pfcvh   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Completed</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          11s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">5vg2j   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Pending</span><span class="token plain">             </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">fhwf7   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">ContainerCreating</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">5vg2j   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Pending</span><span class="token plain">             </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">5vg2j   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">ContainerCreating</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">fhwf7   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">             </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v7rhr   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">             </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">5vg2j   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">             </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          3s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">fhwf7   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Completed</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          12s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v7rhr   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Completed</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          12s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">5vg2j   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Completed</span><span class="token plain">           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          12s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 删除job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">job</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">job</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">batch</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pc-job&quot;</span><span class="token plain"> deleted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="67-cronjobcj">6.7 CronJob(CJ)<a href="#67-cronjobcj" class="hash-link" aria-label="6.7 CronJob(CJ)的直接链接" title="6.7 CronJob(CJ)的直接链接">​</a></h4><p>CronJob控制器以 Job控制器资源为其管控对象，并借助它管理pod资源对象，Job控制器定义的作业任务在其控制器资源创建之后便会立即执行，但CronJob可以以类似于Linux操作系统的周期性任务作业计划的方式控制其运行<strong>时间点</strong>及<strong>重复运行</strong>的方式。也就是说，<strong>CronJob可以在特定的时间点(反复的)去运行job任务</strong>。</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200618213149531-d35973774be6c30841f6c2ad8ac6b52e.png" width="830" height="301" class="img_ev3q"></p><p>CronJob的资源清单文件：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> batch</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1beta1 # 版本号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">CronJob</span><span class="token plain"> # 类型       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 元数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # rs名称 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 所属命名空间 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> #标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">controller</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cronjob</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 详情描述</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">schedule</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # cron格式的作业调度运行时间点</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">用于控制任务在什么时间执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">concurrencyPolicy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 并发执行策略，用于定义前一次作业运行尚未完成时是否以及如何运行后一次的作业</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">failedJobHistoryLimit</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 为失败的任务执行保留的历史记录数，默认为</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">successfulJobHistoryLimit</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 为成功的任务执行保留的历史记录数，默认为</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">startingDeadlineSeconds</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 启动作业错误的超时时长</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">jobTemplate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # job控制器模板，用于为cronjob控制器生成job对象</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">下面其实就是job的定义</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">completions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">parallelism</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">activeDeadlineSeconds</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">backoffLimit</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">manualSelector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">matchLabels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> counter</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">matchExpressions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> 规则</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token literal-property property" style="color:#36acaa">key</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> app</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">operator</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">In</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">values</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">counter</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">template</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> counter</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token literal-property property" style="color:#36acaa">restartPolicy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Never</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> busybox</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token literal-property property" style="color:#36acaa">command</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;bin/sh&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;-c&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 20;done&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">需要重点解释的几个选项：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">schedule</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cron表达式，用于指定任务的执行时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">      </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">分钟 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">小时 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">日 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">月份 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">星期</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    分钟 值从 </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> 到 </span><span class="token number" style="color:#36acaa">59.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    小时 值从 </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> 到 </span><span class="token number" style="color:#36acaa">23.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    日 值从 </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> 到 </span><span class="token number" style="color:#36acaa">31.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    月 值从 </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> 到 </span><span class="token number" style="color:#36acaa">12.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    星期 值从 </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> 到 </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> 代表星期日</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    多个时间可以用逗号隔开； 范围可以用连字符给出；</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">可以作为通配符； </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">表示每</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">concurrencyPolicy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">Allow</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">   </span><span class="token function" style="color:#d73a49">允许Jobs并发运行</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">默认</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">Forbid</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  禁止并发运行，如果上一次运行尚未完成，则跳过下一次运行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">Replace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> 替换，取消当前正在运行的作业并用新作业替换它</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>创建pc-cronjob.yaml，内容如下：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> batch</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">CronJob</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cronjob</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">controller</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cronjob</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">schedule</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;*/1 * * * *&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">jobTemplate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">template</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token literal-property property" style="color:#36acaa">restartPolicy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Never</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> busybox</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token literal-property property" style="color:#36acaa">command</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;bin/sh&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;-c&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建cronjob</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cronjob</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cronjob</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">batch</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cronjob created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看cronjob</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> cronjobs </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">         </span><span class="token constant" style="color:#36acaa">SCHEDULE</span><span class="token plain">      </span><span class="token constant" style="color:#36acaa">SUSPEND</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">ACTIVE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">LAST</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">SCHEDULE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cronjob   </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">   </span><span class="token maybe-class-name">False</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none          6s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> jobs </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                    </span><span class="token constant" style="color:#36acaa">COMPLETIONS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">DURATION</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cronjob</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1592587800</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           28s        3m26s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cronjob</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1592587860</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           28s        2m26s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cronjob</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1592587920</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           28s        86s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cronjob</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1592587800</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">x4tsm   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Completed</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2m24s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cronjob</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1592587860</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">r5gv4   </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Completed</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          84s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cronjob</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1592587920</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">9dxxq   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          24s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 删除cronjob</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl  </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cronjob</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cronjob</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">batch</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pc-cronjob&quot;</span><span class="token plain"> deleted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7-service详解">7. Service详解<a href="#7-service详解" class="hash-link" aria-label="7. Service详解的直接链接" title="7. Service详解的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="71-service介绍">7.1 Service介绍<a href="#71-service介绍" class="hash-link" aria-label="7.1 Service介绍的直接链接" title="7.1 Service介绍的直接链接">​</a></h4><p>在kubernetes中，pod是应用程序的载体，我们可以通过pod的ip来访问应用程序，但是pod的ip地址不是固定的，这也就意味着不方便直接采用pod的ip对服务进行访问。</p><p>为了解决这个问题，kubernetes提供了Service资源，Service会对提供同一个服务的多个pod进行聚合，并且提供一个统一的入口地址。通过访问Service的入口地址就能访问到后面的pod服务。</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200408194716912-1626783758946-080686a9bbb35623cfd4236b8a3140ec.png" width="1073" height="497" class="img_ev3q"></p><p>Service在很多情况下只是一个概念，真正起作用的其实是kube-proxy服务进程，每个Node节点上都运行着一个kube-proxy服务进程。当创建Service的时候会通过api-server向etcd写入创建的service的信息，而kube-proxy会基于监听的机制发现这种Service的变动，然后<strong>它会将最新的Service信息转换成对应的访问规则</strong>。</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200509121254425-6b2bb1a563088fcbbdf2d5bc6e035f4e.png" width="1048" height="350" class="img_ev3q"></p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">10.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> 是service提供的访问入口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 当访问这个入口的时候，可以发现后面有三个pod的服务在等待调用，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">proxy会基于rr（轮询）的策略，将请求分发到其中一个pod上去</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 这个规则会同时在集群内的所有节点上都生成，所以在任何一个节点上访问都可以。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@node1 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># ipvsadm </span><span class="token operator" style="color:#393A34">-</span><span class="token maybe-class-name">Ln</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain"> </span><span class="token maybe-class-name">Virtual</span><span class="token plain"> </span><span class="token maybe-class-name">Server</span><span class="token plain"> version </span><span class="token number" style="color:#36acaa">1.2</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4096</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Prot</span><span class="token plain"> </span><span class="token maybe-class-name">LocalAddress</span><span class="token operator" style="color:#393A34">:</span><span class="token maybe-class-name">Port</span><span class="token plain"> </span><span class="token maybe-class-name">Scheduler</span><span class="token plain"> </span><span class="token maybe-class-name">Flags</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token maybe-class-name">RemoteAddress</span><span class="token operator" style="color:#393A34">:</span><span class="token maybe-class-name">Port</span><span class="token plain">           </span><span class="token maybe-class-name">Forward</span><span class="token plain"> </span><span class="token maybe-class-name">Weight</span><span class="token plain"> </span><span class="token maybe-class-name">ActiveConn</span><span class="token plain"> </span><span class="token maybe-class-name">InActConn</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">10.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> rr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.39</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain">               </span><span class="token maybe-class-name">Masq</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.40</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain">               </span><span class="token maybe-class-name">Masq</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.33</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain">               </span><span class="token maybe-class-name">Masq</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>kube-proxy目前支持三种工作模式:</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="711-userspace-模式">7.1.1 userspace 模式<a href="#711-userspace-模式" class="hash-link" aria-label="7.1.1 userspace 模式的直接链接" title="7.1.1 userspace 模式的直接链接">​</a></h5><p>userspace模式下，kube-proxy会为每一个Service创建一个监听端口，发向Cluster IP的请求被Iptables规则重定向到kube-proxy监听的端口上，kube-proxy根据LB算法选择一个提供服务的Pod并和其建立链接，以将请求转发到Pod上。 该模式下，kube-proxy充当了一个四层负责均衡器的角色。由于kube-proxy运行在userspace中，在进行转发处理时会增加内核和用户空间之间的数据拷贝，虽然比较稳定，但是效率比较低。</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200509151424280-8e312f5e45ca2114aca8d26e47813f34.png" width="851" height="524" class="img_ev3q"></p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="712-iptables-模式">7.1.2 iptables 模式<a href="#712-iptables-模式" class="hash-link" aria-label="7.1.2 iptables 模式的直接链接" title="7.1.2 iptables 模式的直接链接">​</a></h5><p>iptables模式下，kube-proxy为service后端的每个Pod创建对应的iptables规则，直接将发向Cluster IP的请求重定向到一个Pod IP。 该模式下kube-proxy不承担四层负责均衡器的角色，只负责创建iptables规则。该模式的优点是较userspace模式效率更高，但不能提供灵活的LB策略，当后端Pod不可用时也无法进行重试。</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200509152947714-ffd7807e9bd86ba41fb28bf54f71d764.png" width="837" height="642" class="img_ev3q"></p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="713-ipvs-模式">7.1.3 ipvs 模式<a href="#713-ipvs-模式" class="hash-link" aria-label="7.1.3 ipvs 模式的直接链接" title="7.1.3 ipvs 模式的直接链接">​</a></h5><p>ipvs模式和iptables类似，kube-proxy监控Pod的变化并创建相应的ipvs规则。ipvs相对iptables转发效率更高。除此以外，ipvs支持更多的LB算法。</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200509153731363-1c392748be2a10f48e97b07b88985d89.png" width="820" height="633" class="img_ev3q"></p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 此模式必须安装ipvs内核模块，否则会降级为iptables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 开启ipvs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl edit cm kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">proxy </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 修改mode</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ipvs&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">l k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">app</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">proxy </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n kube</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@node1 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># ipvsadm </span><span class="token operator" style="color:#393A34">-</span><span class="token maybe-class-name">Ln</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain"> </span><span class="token maybe-class-name">Virtual</span><span class="token plain"> </span><span class="token maybe-class-name">Server</span><span class="token plain"> version </span><span class="token number" style="color:#36acaa">1.2</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4096</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Prot</span><span class="token plain"> </span><span class="token maybe-class-name">LocalAddress</span><span class="token operator" style="color:#393A34">:</span><span class="token maybe-class-name">Port</span><span class="token plain"> </span><span class="token maybe-class-name">Scheduler</span><span class="token plain"> </span><span class="token maybe-class-name">Flags</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token maybe-class-name">RemoteAddress</span><span class="token operator" style="color:#393A34">:</span><span class="token maybe-class-name">Port</span><span class="token plain">           </span><span class="token maybe-class-name">Forward</span><span class="token plain"> </span><span class="token maybe-class-name">Weight</span><span class="token plain"> </span><span class="token maybe-class-name">ActiveConn</span><span class="token plain"> </span><span class="token maybe-class-name">InActConn</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">10.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> rr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.39</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain">               </span><span class="token maybe-class-name">Masq</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.40</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain">               </span><span class="token maybe-class-name">Masq</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.33</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain">               </span><span class="token maybe-class-name">Masq</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="72-service类型">7.2 Service类型<a href="#72-service类型" class="hash-link" aria-label="7.2 Service类型的直接链接" title="7.2 Service类型的直接链接">​</a></h4><p>Service的资源清单文件：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Service</span><span class="token plain">  # 资源类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1  # 资源版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 元数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> service # 资源名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev # 命名空间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 描述</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 标签选择器，用于确定当前service代理哪些pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # </span><span class="token maybe-class-name">Service类型，指定service的访问方式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">clusterIP</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  # 虚拟服务的ip地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">sessionAffinity</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # session亲和性，支持ClientIP、None两个选项</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 端口信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> protocol</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3017</span><span class="token plain">  # service端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">targetPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5003</span><span class="token plain"> # pod端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">nodePort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">31122</span><span class="token plain"> # 主机端口</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>ClusterIP：默认值，它是Kubernetes系统自动分配的虚拟IP，只能在集群内部访问</p></li><li><p>NodePort：将Service通过指定的Node上的端口暴露给外部，通过此方法，就可以在集群外部访问服务</p></li><li><p>LoadBalancer：使用外接负载均衡器完成到服务的负载分发，注意此模式需要外部云环境支持</p></li><li><p>ExternalName： 把集群外部的服务引入集群内部，直接使用</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="73-service使用">7.3 Service使用<a href="#73-service使用" class="hash-link" aria-label="7.3 Service使用的直接链接" title="7.3 Service使用的直接链接">​</a></h4><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="731-实验环境准备">7.3.1 实验环境准备<a href="#731-实验环境准备" class="hash-link" aria-label="7.3.1 实验环境准备的直接链接" title="7.3.1 实验环境准备的直接链接">​</a></h5><p>在使用service之前，首先利用Deployment创建出3个pod，注意要为pod设置<code>app=nginx-pod</code>的标签</p><p>创建deployment.yaml，内容如下：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Deployment</span><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">replicas</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">matchLabels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">template</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> containerPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看pod详情</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">show</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                             </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">     </span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">            </span><span class="token constant" style="color:#36acaa">NODE</span><span class="token plain">     </span><span class="token constant" style="color:#36acaa">LABELS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">66cb59b984</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">8p84h   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.39</span><span class="token plain">   node1    app</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">66cb59b984</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">vx8vx   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.33</span><span class="token plain">   node2    app</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">66cb59b984</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">wnncx   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.40</span><span class="token plain">   node1    app</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 为了方便后面的测试，修改下三台nginx的index</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">html页面（三台修改的</span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">地址不一致）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># kubectl exec </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">it pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">66cb59b984</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">8p84h </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># echo </span><span class="token string" style="color:#e3116c">&quot;10.244.1.39&quot;</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">usr</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">share</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">html</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">html</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#修改完毕之后，访问测试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># curl </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.39</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.39</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># curl </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.33</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.33</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># curl </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.40</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.40</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="732-clusterip类型的service">7.3.2 ClusterIP类型的Service<a href="#732-clusterip类型的service" class="hash-link" aria-label="7.3.2 ClusterIP类型的Service的直接链接" title="7.3.2 ClusterIP类型的Service的直接链接">​</a></h5><p>创建service-clusterip.yaml文件</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">clusterip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">clusterIP</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token plain"> # service的ip地址，如果不写，默认会生成一个</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">ClusterIP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">  # </span><span class="token maybe-class-name">Service端口</span><span class="token plain">       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">targetPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> # pod端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">clusterip</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">clusterip created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> svc </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                </span><span class="token constant" style="color:#36acaa">TYPE</span><span class="token plain">        </span><span class="token constant" style="color:#36acaa">CLUSTER</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">EXTERNAL</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">PORT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">SELECTOR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">clusterip   </span><span class="token maybe-class-name">ClusterIP</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">10.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none        </span><span class="token number" style="color:#36acaa">80</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain">    13s   app</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看service的详细信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 在这里有一个Endpoints列表，里面就是当前service可以负载到的服务入口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl describe svc service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">clusterip </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">              service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">clusterip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">         dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">            </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Annotations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">       </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">          app</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">              </span><span class="token maybe-class-name">ClusterIP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">IP</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">                </span><span class="token number" style="color:#36acaa">10.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">              </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">unset  </span><span class="token number" style="color:#36acaa">80</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">TargetPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">80</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Endpoints</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.39</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.40</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.33</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Session</span><span class="token plain"> </span><span class="token maybe-class-name">Affinity</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  </span><span class="token maybe-class-name">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Events</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">            </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看ipvs的映射规则</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># ipvsadm </span><span class="token operator" style="color:#393A34">-</span><span class="token maybe-class-name">Ln</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">10.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> rr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.39</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain">               </span><span class="token maybe-class-name">Masq</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.40</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain">               </span><span class="token maybe-class-name">Masq</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.33</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain">               </span><span class="token maybe-class-name">Masq</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 访问</span><span class="token number" style="color:#36acaa">10.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain">观察效果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># curl </span><span class="token number" style="color:#36acaa">10.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.33</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="733-endpoint">7.3.3 Endpoint<a href="#733-endpoint" class="hash-link" aria-label="7.3.3 Endpoint的直接链接" title="7.3.3 Endpoint的直接链接">​</a></h5><p>Endpoint是kubernetes中的一个资源对象，存储在etcd中，用来记录一个service对应的所有pod的访问地址，它是根据service配置文件中selector描述产生的。</p><p>一个Service由一组Pod组成，这些Pod通过Endpoints暴露出来，<strong>Endpoints是实现实际服务的端点集合</strong>。换句话说，service和pod之间的联系是通过endpoints实现的。</p><p><img loading="lazy" alt="image-20200509191917069" src="/blog/assets/images/image-20200509191917069-05a026e67ce46302c64d2e4312fe1e69.png" width="1087" height="432" class="img_ev3q"></p><p><strong>负载分发策略</strong></p><p>对Service的访问被分发到了后端的Pod上去，目前kubernetes提供了两种负载分发策略：</p></li><li><p>如果不定义，默认使用kube-proxy的策略，比如随机、轮询</p></li><li><p>基于客户端地址的会话保持模式，即来自同一个客户端发起的所有请求都会转发到固定的一个Pod上</p><p>  此模式可以使在spec中添加<code>sessionAffinity:ClientIP</code>选项</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 查看ipvs的映射规则【rr 轮询】</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># ipvsadm </span><span class="token operator" style="color:#393A34">-</span><span class="token maybe-class-name">Ln</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">10.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> rr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.39</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain">               </span><span class="token maybe-class-name">Masq</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.40</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain">               </span><span class="token maybe-class-name">Masq</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.33</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain">               </span><span class="token maybe-class-name">Masq</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 循环访问测试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token keyword control-flow" style="color:#00009f">do</span><span class="token plain"> curl </span><span class="token number" style="color:#36acaa">10.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> sleep </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> done</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.40</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.39</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.33</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.40</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.39</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.33</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 修改分发策略</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">sessionAffinity</span><span class="token operator" style="color:#393A34">:</span><span class="token maybe-class-name">ClientIP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看ipvs规则【persistent 代表持久】</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># ipvsadm </span><span class="token operator" style="color:#393A34">-</span><span class="token maybe-class-name">Ln</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">10.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> rr persistent </span><span class="token number" style="color:#36acaa">10800</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.39</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain">               </span><span class="token maybe-class-name">Masq</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.40</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain">               </span><span class="token maybe-class-name">Masq</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.33</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain">               </span><span class="token maybe-class-name">Masq</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 循环访问测试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token keyword control-flow" style="color:#00009f">do</span><span class="token plain"> curl </span><span class="token number" style="color:#36acaa">10.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token number" style="color:#36acaa">.97</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> sleep </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> done</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.33</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.33</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.33</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 删除service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">clusterip</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service </span><span class="token string" style="color:#e3116c">&quot;service-clusterip&quot;</span><span class="token plain"> deleted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="734-headliness类型的service">7.3.4 HeadLiness类型的Service<a href="#734-headliness类型的service" class="hash-link" aria-label="7.3.4 HeadLiness类型的Service的直接链接" title="7.3.4 HeadLiness类型的Service的直接链接">​</a></h5><p>在某些场景中，开发人员可能不想使用Service提供的负载均衡功能，而希望自己来控制负载均衡策略，针对这种情况，kubernetes提供了HeadLiness Service，这类Service不会分配Cluster IP，如果想要访问service，只能通过service的域名进行查询。</p><p>创建service-headliness.yaml</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">headliness</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">clusterIP</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">None</span><span class="token plain"> # 将clusterIP设置为None，即可创建headliness </span><span class="token maybe-class-name">Service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">ClusterIP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">targetPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">headliness</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">headliness created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 获取service， 发现</span><span class="token constant" style="color:#36acaa">CLUSTER</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">未分配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> svc service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">headliness </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                 </span><span class="token constant" style="color:#36acaa">TYPE</span><span class="token plain">        </span><span class="token constant" style="color:#36acaa">CLUSTER</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">EXTERNAL</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">PORT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">SELECTOR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">headliness   </span><span class="token maybe-class-name">ClusterIP</span><span class="token plain">   </span><span class="token maybe-class-name">None</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none        </span><span class="token number" style="color:#36acaa">80</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain">    11s   app</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看service详情</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl describe svc service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">headliness  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">              service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">headliness</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">         dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">            </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Annotations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">       </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">          app</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">              </span><span class="token maybe-class-name">ClusterIP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">IP</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">                </span><span class="token maybe-class-name">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">              </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">unset  </span><span class="token number" style="color:#36acaa">80</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">TargetPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">80</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Endpoints</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.39</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.40</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.33</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Session</span><span class="token plain"> </span><span class="token maybe-class-name">Affinity</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  </span><span class="token maybe-class-name">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Events</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">            </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看域名的解析情况</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl exec </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">it pc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">66cb59b984</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">8p84h </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> # cat </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">resolv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">conf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nameserver </span><span class="token number" style="color:#36acaa">10.96</span><span class="token number" style="color:#36acaa">.0</span><span class="token number" style="color:#36acaa">.10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">search dev</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">svc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">local</span><span class="token plain"> svc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">local</span><span class="token plain"> cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">local</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># dig @</span><span class="token number" style="color:#36acaa">10.96</span><span class="token number" style="color:#36acaa">.0</span><span class="token number" style="color:#36acaa">.10</span><span class="token plain"> service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">headliness</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dev</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">svc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">local</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">headliness</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dev</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">svc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">local</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">IN</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">A</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.40</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">headliness</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dev</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">svc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">local</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">IN</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">A</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.39</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">headliness</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dev</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">svc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">local</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">IN</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">A</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.244</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.33</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="735-nodeport类型的service">7.3.5 NodePort类型的Service<a href="#735-nodeport类型的service" class="hash-link" aria-label="7.3.5 NodePort类型的Service的直接链接" title="7.3.5 NodePort类型的Service的直接链接">​</a></h5><p>在之前的样例中，创建的Service的ip地址只有集群内部才可以访问，如果希望将Service暴露给集群外部使用，那么就要使用到另外一种类型的Service，称为NodePort类型。NodePort的工作原理其实就是<strong>将service的端口映射到Node的一个端口上</strong>，然后就可以通过<code>NodeIp:NodePort</code>来访问service了。</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200620175731338-9b8317045fadcbe5e6fd407901daa8d8.png" width="543" height="262" class="img_ev3q"></p><p>创建service-nodeport.yaml</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodeport</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">NodePort</span><span class="token plain"> # service类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">nodePort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30002</span><span class="token plain"> # </span><span class="token function" style="color:#d73a49">指定绑定的node的端口</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">默认的取值范围是：</span><span class="token number" style="color:#36acaa">30000</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">32767</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 如果不指定，会默认分配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">targetPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodeport</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodeport created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> svc </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">               </span><span class="token constant" style="color:#36acaa">TYPE</span><span class="token plain">       </span><span class="token constant" style="color:#36acaa">CLUSTER</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">      </span><span class="token constant" style="color:#36acaa">EXTERNAL</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">PORT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">       </span><span class="token constant" style="color:#36acaa">SELECTOR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodeport   </span><span class="token maybe-class-name">NodePort</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">10.105</span><span class="token number" style="color:#36acaa">.64</span><span class="token number" style="color:#36acaa">.191</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none        </span><span class="token number" style="color:#36acaa">80</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">30002</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain">  app</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 接下来可以通过电脑主机的浏览器去访问集群中任意一个nodeip的</span><span class="token number" style="color:#36acaa">30002</span><span class="token plain">端口，即可访问到pod</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="736-loadbalancer类型的service">7.3.6 LoadBalancer类型的Service<a href="#736-loadbalancer类型的service" class="hash-link" aria-label="7.3.6 LoadBalancer类型的Service的直接链接" title="7.3.6 LoadBalancer类型的Service的直接链接">​</a></h5><p>LoadBalancer和NodePort很相似，目的都是向外部暴露一个端口，区别在于LoadBalancer会在集群的外部再来做一个负载均衡设备，而这个设备需要外部环境支持的，外部服务发送到这个设备上的请求，会被设备负载之后转发到集群中。</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200510103945494-facca1540d1fc8b9940b34ae6cde7f56.png" width="1101" height="419" class="img_ev3q"></p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="737-externalname类型的service">7.3.7 ExternalName类型的Service<a href="#737-externalname类型的service" class="hash-link" aria-label="7.3.7 ExternalName类型的Service的直接链接" title="7.3.7 ExternalName类型的Service的直接链接">​</a></h5><p>ExternalName类型的Service用于引入集群外部的服务，它通过<code>externalName</code>属性指定外部一个服务的地址，然后在集群内部访问此service就可以访问到外部的服务了。</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200510113311209-3363a56d5d1959da78cf1875d3fc87bf.png" width="779" height="304" class="img_ev3q"></p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">externalname</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">ExternalName</span><span class="token plain"> # service类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">externalName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> www</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">baidu</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token plain">  #改成ip地址也可以</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl  create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">externalname</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">externalname created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 域名解析</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># dig @</span><span class="token number" style="color:#36acaa">10.96</span><span class="token number" style="color:#36acaa">.0</span><span class="token number" style="color:#36acaa">.10</span><span class="token plain"> service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">externalname</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dev</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">svc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">local</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">externalname</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dev</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">svc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">local</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">IN</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">CNAME</span><span class="token plain"> www</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">baidu</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property-access">www</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">baidu</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">30</span><span class="token plain">      </span><span class="token constant" style="color:#36acaa">IN</span><span class="token plain">      </span><span class="token constant" style="color:#36acaa">CNAME</span><span class="token plain">   www</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">shifen</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property-access">www</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">shifen</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">30</span><span class="token plain">      </span><span class="token constant" style="color:#36acaa">IN</span><span class="token plain">      </span><span class="token constant" style="color:#36acaa">A</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">39.156</span><span class="token number" style="color:#36acaa">.66</span><span class="token number" style="color:#36acaa">.18</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">shifen</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">30</span><span class="token plain">      </span><span class="token constant" style="color:#36acaa">IN</span><span class="token plain">      </span><span class="token constant" style="color:#36acaa">A</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">39.156</span><span class="token number" style="color:#36acaa">.66</span><span class="token number" style="color:#36acaa">.14</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="74-ingress介绍">7.4 Ingress介绍<a href="#74-ingress介绍" class="hash-link" aria-label="7.4 Ingress介绍的直接链接" title="7.4 Ingress介绍的直接链接">​</a></h4><p>在前面课程中已经提到，Service对集群之外暴露服务的主要方式有两种：NotePort和LoadBalancer，但是这两种方式，都有一定的缺点：</p></li><li><p>NodePort方式的缺点是会占用很多集群机器的端口，那么当集群服务变多的时候，这个缺点就愈发明显</p></li><li><p>LB方式的缺点是每个service需要一个LB，浪费、麻烦，并且需要kubernetes之外设备的支持</p><p>基于这种现状，kubernetes提供了Ingress资源对象，Ingress只需要一个NodePort或者一个LB就可以满足暴露多个Service的需求。工作机制大致如下图表示：</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200623092808049-18aa9ff68af6bf0ae49ed688cb282d5b.png" width="992" height="422" class="img_ev3q"></p><p>实际上，Ingress相当于一个7层的负载均衡器，是kubernetes对反向代理的一个抽象，它的工作原理类似于Nginx，可以理解成在<strong>Ingress里建立诸多映射规则，Ingress Controller通过监听这些配置规则并转化成Nginx的反向代理配置 , 然后对外部提供服务</strong>。在这里有两个核心概念：</p></li><li><p>ingress：kubernetes中的一个对象，作用是定义请求如何转发到service的规则</p></li><li><p>ingress controller：具体实现反向代理及负载均衡的程序，对ingress定义的规则进行解析，根据配置的规则来实现请求转发，实现方式有很多，比如Nginx, Contour, Haproxy等等</p><p>Ingress（以Nginx为例）的工作原理如下：</p></li></ul><ol><li><p>用户编写Ingress规则，说明哪个域名对应kubernetes集群中的哪个Service</p></li><li><p>Ingress控制器动态感知Ingress服务规则的变化，然后生成一段对应的Nginx反向代理配置</p></li><li><p>Ingress控制器会将生成的Nginx配置写入到一个运行着的Nginx服务中，并动态更新</p></li><li><p>到此为止，其实真正在工作的就是一个Nginx了，内部配置了用户定义的请求转发规则</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200516112704764-aa410357bb23e4460cff5397ab73324b.png" width="906" height="433" class="img_ev3q"></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="75-ingress使用">7.5 Ingress使用<a href="#75-ingress使用" class="hash-link" aria-label="7.5 Ingress使用的直接链接" title="7.5 Ingress使用的直接链接">​</a></h4><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="751-环境准备-搭建ingress环境">7.5.1 环境准备 搭建ingress环境<a href="#751-环境准备-搭建ingress环境" class="hash-link" aria-label="7.5.1 环境准备 搭建ingress环境的直接链接" title="7.5.1 环境准备 搭建ingress环境的直接链接">​</a></h5><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建文件夹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># mkdir ingress</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">controller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># cd ingress</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">controller</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 获取ingress</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nginx，本次案例使用的是</span><span class="token number" style="color:#36acaa">0.30</span><span class="token plain">版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 ingress</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">controller</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># wget https</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">raw</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">githubusercontent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">ingress</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0.30</span><span class="token number" style="color:#36acaa">.0</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">deploy</span><span class="token operator" style="color:#393A34">/</span><span class="token keyword" style="color:#00009f">static</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mandatory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 ingress</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">controller</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># wget https</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">raw</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">githubusercontent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">ingress</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0.30</span><span class="token number" style="color:#36acaa">.0</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">deploy</span><span class="token operator" style="color:#393A34">/</span><span class="token keyword" style="color:#00009f">static</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">provider</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">baremetal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nodeport</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 修改mandatory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml文件中的仓库</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 修改quay</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ingress</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">controller</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ingress</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">controller</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">0.30</span><span class="token number" style="color:#36acaa">.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 为quay</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">mirror</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">qiniu</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ingress</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">controller</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ingress</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">controller</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">0.30</span><span class="token number" style="color:#36acaa">.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建ingress</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 ingress</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">controller</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl apply </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看ingress</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 ingress</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">controller</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n ingress</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                                           </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ingress</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">controller</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">fbf967dd5</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">4qpbp   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          12h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 ingress</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">controller</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> svc </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n ingress</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">            </span><span class="token constant" style="color:#36acaa">TYPE</span><span class="token plain">       </span><span class="token constant" style="color:#36acaa">CLUSTER</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">     </span><span class="token constant" style="color:#36acaa">EXTERNAL</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">PORT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                      </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ingress</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nginx   </span><span class="token maybe-class-name">NodePort</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">10.98</span><span class="token number" style="color:#36acaa">.75</span><span class="token number" style="color:#36acaa">.163</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none        </span><span class="token number" style="color:#36acaa">80</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">32240</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">443</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">31335</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain">   11h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="752-准备service和pod">7.5.2 准备service和pod<a href="#752-准备service和pod" class="hash-link" aria-label="7.5.2 准备service和pod的直接链接" title="7.5.2 准备service和pod的直接链接">​</a></h5><p>为了后面的实验比较方便，创建如下图所示的模型</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200516102419998-305edb51b33efcdefe7466b87514d839.png" width="910" height="358" class="img_ev3q"></p><p>创建tomcat-nginx.yaml</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Deployment</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">replicas</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">matchLabels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">template</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> containerPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Deployment</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> tomcat</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">replicas</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">matchLabels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> tomcat</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">template</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> tomcat</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> tomcat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> tomcat</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8.5</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">jre10</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">slim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> containerPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">clusterIP</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">ClusterIP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><ul><li><p>port: 80
targetPort: 80</p><hr><p>apiVersion: v1
kind: Service
metadata:
name: tomcat-service
namespace: dev
spec:
selector:
app: tomcat-pod
clusterIP: None
type: ClusterIP
ports:</p></li><li><p>port: 8080
targetPort: 8080</p><h1>创建</h1><p>[root@k8s-master01 ~]<!-- --># kubectl create -f tomcat-nginx.yaml</p><h1>查看</h1><p>[root@k8s-master01 ~]<!-- --># kubectl get svc -n dev
NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE
nginx-service    ClusterIP   None         &lt;none        80/TCP     48s
tomcat-service   ClusterIP   None         &lt;none        8080/TCP   48s</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##### </span><span class="token number" style="color:#36acaa">7.5</span><span class="token number" style="color:#36acaa">.3</span><span class="token plain"> </span><span class="token maybe-class-name">Http代理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">创建ingress</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: ingress-http
namespace: dev
spec:
rules:</p></li><li><p>host: nginx.itheima.com
http:
paths:</p><ul><li>path: /
backend:
serviceName: nginx-service
servicePort: 80</li></ul></li><li><p>host: tomcat.itheima.com
http:
paths:</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">backend</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">serviceName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> tomcat</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">servicePort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>创建</h1><p>[root@k8s-master01 ~]<!-- --># kubectl create -f ingress-http.yaml
ingress.extensions/ingress-http created</p><h1>查看</h1><p>[root@k8s-master01 ~]<!-- --># kubectl get ing ingress-http -n dev
NAME           HOSTS                                  ADDRESS   PORTS   AGE
ingress-http   nginx.itheima.com,tomcat.itheima.com             80      22s</p><h1>查看详情</h1><p>[root@k8s-master01 ~]<!-- --># kubectl describe ing ingress-http  -n dev
...
Rules:
Host                Path  Backends</p><hr><p>nginx.itheima.com   / nginx-service:80 (10.244.1.96:80,10.244.1.97:80,10.244.2.112:80)
tomcat.itheima.com  / tomcat-service:8080(10.244.1.94:8080,10.244.1.95:8080,10.244.2.111:8080)
...</p><h1>接下来,在本地电脑上配置host文件,解析上面的两个域名到192.168.109.100(master)上</h1><h1>然后,就可以分别访问tomcat.itheima.com:32240  和  nginx.itheima.com:32240 查看效果了</h1><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##### </span><span class="token number" style="color:#36acaa">7.5</span><span class="token number" style="color:#36acaa">.4</span><span class="token plain"> </span><span class="token maybe-class-name">Https代理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">创建证书</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>生成证书</h1><p>openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj &quot;/C=CN/ST=BJ/L=BJ/O=nginx/CN=itheima.com&quot;</p><h1>创建密钥</h1><p>kubectl create secret tls tls-secret --key tls.key --cert tls.crt</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">创建ingress</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">https</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: ingress-https
namespace: dev
spec:
tls:</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">-</span><span class="token plain"> hosts</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">itheima</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> tomcat</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">itheima</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">secretName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> tls</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">secret # 指定秘钥</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>  rules:</p></li><li><p>host: nginx.itheima.com
http:
paths:</p><ul><li>path: /
backend:
serviceName: nginx-service
servicePort: 80</li></ul></li><li><p>host: tomcat.itheima.com
http:
paths:</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">backend</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">serviceName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> tomcat</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">servicePort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>创建</h1><p>[root@k8s-master01 ~]<!-- --># kubectl create -f ingress-https.yaml
ingress.extensions/ingress-https created</p><h1>查看</h1><p>[root@k8s-master01 ~]<!-- --># kubectl get ing ingress-https -n dev
NAME            HOSTS                                  ADDRESS         PORTS     AGE
ingress-https   nginx.itheima.com,tomcat.itheima.com   10.104.184.38   80, 443   2m42s</p><h1>查看详情</h1><p>[root@k8s-master01 ~]<!-- --># kubectl describe ing ingress-https -n dev
...
TLS:
tls-secret terminates nginx.itheima.com,tomcat.itheima.com
Rules:
Host              Path Backends</p><hr><p>nginx.itheima.com  /  nginx-service:80 (10.244.1.97:80,10.244.1.98:80,10.244.2.119:80)
tomcat.itheima.com /  tomcat-service:8080(10.244.1.99:8080,10.244.2.117:8080,10.244.2.120:8080)
...</p><h1>下面可以通过浏览器访问<a href="https://nginx.itheima.com:31335" target="_blank" rel="noopener noreferrer">https://nginx.itheima.com:31335</a> 和 <a href="https://tomcat.itheima.com:31335%E6%9D%A5%E6%9F%A5%E7%9C%8B%E4%BA%86" target="_blank" rel="noopener noreferrer">https://tomcat.itheima.com:31335来查看了</a></h1><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### </span><span class="token number" style="color:#36acaa">8.</span><span class="token plain"> 数据存储</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在前面已经提到，容器的生命周期可能很短，会被频繁地创建和销毁。那么容器在销毁时，保存在容器中的数据也会被清除。这种结果对用户来说，在某些情况下是不乐意看到的。为了持久化保存容器的数据，kubernetes引入了Volume的概念。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Volume是Pod中能够被多个容器访问的共享目录，它被定义在Pod上，然后被一个Pod里的多个容器挂载到具体的文件目录下，kubernetes通过Volume实现同一个Pod中不同容器之间的数据共享以及数据的持久化存储。Volume的生命容器不与Pod中单个容器的生命周期相关，当容器终止或者重启时，Volume中的数据也不会丢失。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubernetes的Volume支持多种类型，比较常见的有下面几个：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>简单存储：EmptyDir、HostPath、NFS</p></li><li><p>高级存储：PV、PVC</p></li><li><p>配置存储：ConfigMap、Secret</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="81-基本存储">8.1 基本存储<a href="#81-基本存储" class="hash-link" aria-label="8.1 基本存储的直接链接" title="8.1 基本存储的直接链接">​</a></h4><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="811-emptydir">8.1.1 EmptyDir<a href="#811-emptydir" class="hash-link" aria-label="8.1.1 EmptyDir的直接链接" title="8.1.1 EmptyDir的直接链接">​</a></h5><p>EmptyDir是最基础的Volume类型，一个EmptyDir就是Host上的一个空目录。</p><p>EmptyDir是在Pod被分配到Node时创建的，它的初始内容为空，并且无须指定宿主机上对应的目录文件，因为kubernetes会自动分配一个目录，当Pod销毁时， EmptyDir中的数据也会被永久删除。 EmptyDir用途如下：</p></li><li><p>临时空间，例如用于某些应用程序运行时所需的临时目录，且无须永久保留</p></li><li><p>一个容器需要从另一个容器中获取数据的目录（多容器共享目录）</p><p>接下来，通过一个容器之间文件共享的案例来使用一下EmptyDir。</p><p>在一个Pod中准备两个容器nginx和busybox，然后声明一个Volume分别挂在到两个容器的目录中，然后nginx容器负责向Volume中写日志，busybox中通过命令将日志内容读到控制台。</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200413174713773-1538744259c450b8265921f686d8d5ad.png" width="971" height="418" class="img_ev3q"></p><p>创建一个volume-emptydir.yaml</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> volume</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">emptydir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> containerPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">volumeMounts</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  # 将logs</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">volume挂在到nginx容器中，对应的目录为 </span><span class="token operator" style="color:#393A34">/</span><span class="token keyword" style="color:#00009f">var</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">log</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> logs</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">mountPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token keyword" style="color:#00009f">var</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">log</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> busybox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> busybox</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">command</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;/bin/sh&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;-c&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;tail -f /logs/access.log&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> # 初始命令，动态读取指定文件中内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">volumeMounts</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  # 将logs</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">volume 挂在到busybox容器中，对应的目录为 </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> logs</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">mountPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">volumes</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 声明volume， name为logs</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">volume，类型为emptyDir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> logs</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">emptyDir</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f volume</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">emptydir</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">volume</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">emptydir created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods volume</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">emptydir </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                  </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">      </span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">       </span><span class="token constant" style="color:#36acaa">NODE</span><span class="token plain">   </span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">volume</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">emptydir       </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          97s   </span><span class="token number" style="color:#36acaa">10.42</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.9</span><span class="token plain">   node1  </span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 通过podIp访问nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># curl </span><span class="token number" style="color:#36acaa">10.42</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.9</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 通过kubectl logs命令查看指定容器的标准输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl logs </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f volume</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">emptydir </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c busybox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10.42</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">27</span><span class="token operator" style="color:#393A34">/</span><span class="token maybe-class-name">Jun</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">2021</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">15</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">08</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">54</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0000</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;GET / HTTP/1.1&quot;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">612</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;curl/7.29.0&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="812-hostpath">8.1.2 HostPath<a href="#812-hostpath" class="hash-link" aria-label="8.1.2 HostPath的直接链接" title="8.1.2 HostPath的直接链接">​</a></h5><p>上节课提到，EmptyDir中数据不会被持久化，它会随着Pod的结束而销毁，如果想简单的将数据持久化到主机中，可以选择HostPath。</p><p>HostPath就是将Node主机中一个实际目录挂在到Pod中，以供容器使用，这样的设计就可以保证Pod销毁了，但是数据依据可以存在于Node主机上。</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200413214031331-d63cde68362127c2c9b8e7e40b92e5e5.png" width="1130" height="523" class="img_ev3q"></p><p>创建一个volume-hostpath.yaml：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> volume</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hostpath</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> containerPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">volumeMounts</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> logs</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">mountPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token keyword" style="color:#00009f">var</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">log</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> busybox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> busybox</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">command</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;/bin/sh&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;-c&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;tail -f /logs/access.log&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">volumeMounts</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> logs</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">mountPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">volumes</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> logs</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">hostPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">root</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">DirectoryOrCreate</span><span class="token plain">  # 目录存在就使用，不存在就先创建后使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">关于type的值的一点说明：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token maybe-class-name">DirectoryOrCreate</span><span class="token plain"> 目录存在就使用，不存在就先创建后使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token maybe-class-name">Directory</span><span class="token plain">   目录必须存在</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token maybe-class-name">FileOrCreate</span><span class="token plain">  文件存在就使用，不存在就先创建后使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token maybe-class-name">File</span><span class="token plain"> 文件必须存在 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token maybe-class-name">Socket</span><span class="token plain">  unix套接字必须存在</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token maybe-class-name">CharDevice</span><span class="token plain">  字符设备必须存在</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token maybe-class-name">BlockDevice</span><span class="token plain"> 块设备必须存在</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f volume</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hostpath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">volume</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hostpath created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods volume</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hostpath </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                  </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">             </span><span class="token constant" style="color:#36acaa">NODE</span><span class="token plain">   </span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">volume</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hostpath   </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          16s   </span><span class="token number" style="color:#36acaa">10.42</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.10</span><span class="token plain">     node1  </span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#访问nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># curl </span><span class="token number" style="color:#36acaa">10.42</span><span class="token number" style="color:#36acaa">.2</span><span class="token number" style="color:#36acaa">.10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl logs </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f volume</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">emptydir </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c busybox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 接下来就可以去host的</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">root</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">logs目录下查看存储的文件了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">###  注意</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> 下面的操作需要到Pod所在的节点运行（案例中是node1）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@node1 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># ls </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">root</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">logs</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">access</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">log</span><span class="token plain">  error</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">log</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 同样的道理，如果在此目录下创建一个文件，到容器中也是可以看到的</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="813-nfs">8.1.3 NFS<a href="#813-nfs" class="hash-link" aria-label="8.1.3 NFS的直接链接" title="8.1.3 NFS的直接链接">​</a></h5><p>HostPath可以解决数据持久化的问题，但是一旦Node节点故障了，Pod如果转移到了别的节点，又会出现问题了，此时需要准备单独的网络存储系统，比较常用的用NFS、CIFS。</p><p>NFS是一个网络文件存储系统，可以搭建一台NFS服务器，然后将Pod中的存储直接连接到NFS系统上，这样的话，无论Pod在节点上怎么转移，只要Node跟NFS的对接没问题，数据就可以成功访问。</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200413215133559-b818ff59a2a5b498f4c22fb73c6a716e.png" width="1296" height="389" class="img_ev3q"></p><p>1）首先要准备nfs的服务器，这里为了简单，直接是master节点做nfs服务器</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 在nfs上安装nfs服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@nfs </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># yum install nfs</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">utils </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 准备一个共享目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@nfs </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># mkdir </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">root</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nfs </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 将共享目录以读写权限暴露给</span><span class="token number" style="color:#36acaa">192.168</span><span class="token number" style="color:#36acaa">.5</span><span class="token number" style="color:#36acaa">.0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">24</span><span class="token plain">网段中的所有主机</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@nfs </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># vim </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">exports</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@nfs </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># more </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">exports</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">/</span><span class="token plain">root</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nfs     </span><span class="token number" style="color:#36acaa">192.168</span><span class="token number" style="color:#36acaa">.5</span><span class="token number" style="color:#36acaa">.0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">24</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">no_root_squash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 启动nfs服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@nfs </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># systemctl restart nfs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2）接下来，要在的每个node节点上都安装下nfs，这样的目的是为了node节点可以驱动nfs设备</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 在node上安装nfs服务，注意不需要启动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># yum install nfs</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">utils </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">y</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>3）接下来，就可以编写pod的配置文件了，创建volume-nfs.yaml</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> volume</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nfs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> containerPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">volumeMounts</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> logs</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">mountPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token keyword" style="color:#00009f">var</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">log</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> busybox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> busybox</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">command</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;/bin/sh&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;-c&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;tail -f /logs/access.log&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">volumeMounts</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> logs</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">mountPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">volumes</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> logs</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">nfs</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">server</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token number" style="color:#36acaa">.5</span><span class="token number" style="color:#36acaa">.6</span><span class="token plain">  #nfs服务器地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">root</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">nfs #共享文件路径</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>4）最后，运行下pod，观察结果</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f volume</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nfs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">volume</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nfs created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods volume</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nfs </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                  </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">volume</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">nfs        </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2m9s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看nfs服务器上的共享目录，发现已经有文件了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># ls </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">root</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">access</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">log</span><span class="token plain">  error</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">log</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="82-高级存储">8.2 高级存储<a href="#82-高级存储" class="hash-link" aria-label="8.2 高级存储的直接链接" title="8.2 高级存储的直接链接">​</a></h4><p>前面已经学习了使用NFS提供存储，此时就要求用户会搭建NFS系统，并且会在yaml配置nfs。由于kubernetes支持的存储系统有很多，要求客户全都掌握，显然不现实。为了能够屏蔽底层存储实现的细节，方便用户使用， kubernetes引入PV和PVC两种资源对象。</p></li><li><p>PV（Persistent Volume）是持久化卷的意思，是对底层的共享存储的一种抽象。一般情况下PV由kubernetes管理员进行创建和配置，它与底层具体的共享存储技术有关，并通过插件完成与共享存储的对接。</p></li><li><p>PVC（Persistent Volume Claim）是持久卷声明的意思，是用户对于存储需求的一种声明。换句话说，PVC其实就是用户向kubernetes系统发出的一种资源需求申请。</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200514194111567-515c770c703a74cdfcb3eb823444e30c.png" width="1099" height="642" class="img_ev3q"></p><p>使用了PV和PVC之后，工作可以得到进一步的细分：</p></li><li><p>存储：存储工程师维护</p></li><li><p>PV： kubernetes管理员维护</p></li><li><p>PVC：kubernetes用户维护</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="821-pv">8.2.1 PV<a href="#821-pv" class="hash-link" aria-label="8.2.1 PV的直接链接" title="8.2.1 PV的直接链接">​</a></h5><p>PV是存储资源的抽象，下面是资源清单文件:</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">PersistentVolume</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pv2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">nfs</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 存储类型，与底层真正存储对应</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">capacity</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  # 存储能力，目前只支持存储空间的设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">storage</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> 2Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">accessModes</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  # 访问模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">storageClassName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 存储类别</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">persistentVolumeReclaimPolicy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 回收策略</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>PV 的关键配置参数说明：</p></li><li><p><strong>存储类型</strong></p><p>底层实际存储的类型，kubernetes支持多种存储类型，每种存储类型的配置都有所差异</p></li><li><p><strong>存储能力（capacity）</strong></p><p>目前只支持存储空间的设置( storage=1Gi )，不过未来可能会加入IOPS、吞吐量等指标的配置</p></li><li><p><strong>访问模式（accessModes）</strong></p><p>用于描述用户应用对存储资源的访问权限，访问权限包括下面几种方式：</p><ul><li>ReadWriteOnce（RWO）：读写权限，但是只能被单个节点挂载</li><li>ReadOnlyMany（ROX）： 只读权限，可以被多个节点挂载</li><li>ReadWriteMany（RWX）：读写权限，可以被多个节点挂载</li></ul><p><code>需要注意的是，底层不同的存储类型可能支持的访问模式不同</code></p></li><li><p><strong>回收策略（persistentVolumeReclaimPolicy）</strong></p><p>当PV不再被使用了之后，对其的处理方式。目前支持三种策略：</p><ul><li>Retain （保留） 保留数据，需要管理员手工清理数据</li><li>Recycle（回收） 清除 PV 中的数据，效果相当于执行 rm -rf /thevolume/*</li><li>Delete （删除） 与 PV 相连的后端存储完成 volume 的删除操作，当然这常见于云服务商的存储服务</li></ul><p><code>需要注意的是，底层不同的存储类型可能支持的回收策略不同</code></p></li><li><p><strong>存储类别</strong></p><p>PV可以通过storageClassName参数指定一个存储类别</p><ul><li>具有特定类别的PV只能与请求了该类别的PVC进行绑定</li><li>未设定类别的PV则只能与不请求任何类别的PVC进行绑定</li></ul></li><li><p><strong>状态（status）</strong></p><p>  一个 PV 的生命周期中，可能会处于4中不同的阶段：</p><ul><li>Available（可用）： 表示可用状态，还未被任何 PVC 绑定</li><li>Bound（已绑定）： 表示 PV 已经被 PVC 绑定</li><li>Released（已释放）： 表示 PVC 被删除，但是资源还未被集群重新声明</li><li>Failed（失败）： 表示该 PV 的自动回收失败</li></ul><p><strong>实验</strong></p><p>使用NFS作为存储，来演示PV的使用，创建3个PV，对应NFS中的3个暴露的路径。</p></li></ul><ol><li><p>准备NFS环境</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@nfs </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># mkdir </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">root</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">/</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">pv1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">pv2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">pv3</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 暴露服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@nfs </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># more </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">exports</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">/</span><span class="token plain">root</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pv1     </span><span class="token number" style="color:#36acaa">192.168</span><span class="token number" style="color:#36acaa">.5</span><span class="token number" style="color:#36acaa">.0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">24</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">no_root_squash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">/</span><span class="token plain">root</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pv2     </span><span class="token number" style="color:#36acaa">192.168</span><span class="token number" style="color:#36acaa">.5</span><span class="token number" style="color:#36acaa">.0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">24</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">no_root_squash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">/</span><span class="token plain">root</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pv3     </span><span class="token number" style="color:#36acaa">192.168</span><span class="token number" style="color:#36acaa">.5</span><span class="token number" style="color:#36acaa">.0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">24</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">no_root_squash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 重启服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@nfs </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">#  systemctl restart nfs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>创建pv.yaml</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">PersistentVolume</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  pv1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">capacity</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">storage</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> 1Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">accessModes</span><span class="token operator" style="color:#393A34">:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><ul><li><p>ReadWriteMany
persistentVolumeReclaimPolicy: Retain
nfs:
path: /root/data/pv1
server: 192.168.5.6</p><hr><p>apiVersion: v1
kind: PersistentVolume
metadata:
name:  pv2
spec:
capacity:
storage: 2Gi
accessModes:</p></li><li><p>ReadWriteMany
persistentVolumeReclaimPolicy: Retain
nfs:
path: /root/data/pv2
server: 192.168.5.6</p><hr><p>apiVersion: v1
kind: PersistentVolume
metadata:
name:  pv3
spec:
capacity:
storage: 3Gi
accessModes:</p></li><li><p>ReadWriteMany
persistentVolumeReclaimPolicy: Retain
nfs:
path: /root/data/pv3
server: 192.168.5.6</p><h1>创建 pv</h1><p>[root@k8s-master01 ~]<!-- --># kubectl create -f pv.yaml
persistentvolume/pv1 created
persistentvolume/pv2 created
persistentvolume/pv3 created</p><h1>查看pv</h1><p>[root@k8s-master01 ~]<!-- --># kubectl get pv -o wide
NAME   CAPACITY   ACCESS MODES  RECLAIM POLICY  STATUS      AGE   VOLUMEMODE
pv1    1Gi        RWX            Retain        Available    10s   Filesystem
pv2    2Gi        RWX            Retain        Available    10s   Filesystem
pv3    3Gi        RWX            Retain        Available    9s    Filesystem</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##### </span><span class="token number" style="color:#36acaa">8.2</span><span class="token number" style="color:#36acaa">.2</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">PVC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">PVC</span><span class="token literal-property property" style="color:#36acaa">是资源的申请，用来声明对存储空间、访问模式、存储类别需求信息。下面是资源清单文件</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
name: pvc
namespace: dev
spec:
accessModes: # 访问模式
selector: # 采用标签对PV选择
storageClassName: # 存储类别
resources: # 请求空间
requests:
storage: 5Gi</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">PVC</span><span class="token plain"> 的关键配置参数说明：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>访问模式（accessModes）</strong></p><p>用于描述用户应用对存储资源的访问权限</p></li><li><p><strong>选择条件（selector）</strong></p><p>通过Label Selector的设置，可使PVC对于系统中己存在的PV进行筛选</p></li><li><p><strong>存储类别（storageClassName）</strong></p><p>PVC在定义时可以设定需要的后端存储的类别，只有设置了该class的pv才能被系统选出</p></li><li><p><strong>资源请求（Resources ）</strong></p><p>  描述对存储资源的请求</p><p><strong>实验</strong></p></li></ul><ol><li><p>创建pvc.yaml，申请pv</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">PersistentVolumeClaim</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pvc1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">accessModes</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><ul><li><p>ReadWriteMany
resources:
requests:</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">storage</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> 1Gi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><hr><p>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
name: pvc2
namespace: dev
spec:
accessModes: </p></li><li><p>ReadWriteMany
resources:
requests:</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">storage</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> 1Gi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><hr><p>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
name: pvc3
namespace: dev
spec:
accessModes: </p></li><li><p>ReadWriteMany
resources:
requests:
storage: 1Gi</p><h1>创建pvc</h1><p>[root@k8s-master01 ~]<!-- --># kubectl create -f pvc.yaml
persistentvolumeclaim/pvc1 created
persistentvolumeclaim/pvc2 created
persistentvolumeclaim/pvc3 created</p><h1>查看pvc</h1><p>[root@k8s-master01 ~]<!-- --># kubectl get pvc  -n dev -o wide
NAME   STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE   VOLUMEMODE
pvc1   Bound    pv1      1Gi        RWX                           15s   Filesystem
pvc2   Bound    pv2      2Gi        RWX                           15s   Filesystem
pvc3   Bound    pv3      3Gi        RWX                           15s   Filesystem</p><h1>查看pv</h1><p>[root@k8s-master01 ~]<!-- --># kubectl get pv -o wide
NAME  CAPACITY ACCESS MODES  RECLAIM POLICY  STATUS    CLAIM       AGE     VOLUMEMODE
pv1    1Gi        RWx        Retain          Bound    dev/pvc1    3h37m    Filesystem
pv2    2Gi        RWX        Retain          Bound    dev/pvc2    3h37m    Filesystem
pv3    3Gi        RWX        Retain          Bound    dev/pvc3    3h37m    Filesystem   </p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><ol><li><p>创建pods.yaml, 使用pv</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pod1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><ul><li><p>name: busybox
image: busybox:1.30
command: <!-- -->[&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;while true;do echo pod1  /root/out.txt; sleep 10; done;&quot;]<!-- -->
volumeMounts:</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">mountPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">root</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>  volumes:</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">persistentVolumeClaim</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">claimName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pvc1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">readOnly</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><hr><p>apiVersion: v1
kind: Pod
metadata:
name: pod2
namespace: dev
spec:
containers:</p></li><li><p>name: busybox
image: busybox:1.30
command: <!-- -->[&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;while true;do echo pod2  /root/out.txt; sleep 10; done;&quot;]<!-- -->
volumeMounts:</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">mountPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">root</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>  volumes:</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">persistentVolumeClaim</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">claimName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pvc2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">readOnly</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>创建pod</h1><p>[root@k8s-master01 ~]<!-- --># kubectl create -f pods.yaml
pod/pod1 created
pod/pod2 created</p><h1>查看pod</h1><p>[root@k8s-master01 ~]<!-- --># kubectl get pods -n dev -o wide
NAME   READY   STATUS    RESTARTS   AGE   IP            NODE<br>
<!-- -->pod1   1/1     Running   0          14s   10.244.1.69   node1<br>
<!-- -->pod2   1/1     Running   0          14s   10.244.1.70   node1  </p><h1>查看pvc</h1><p>[root@k8s-master01 ~]<!-- --># kubectl get pvc -n dev -o wide
NAME   STATUS   VOLUME   CAPACITY   ACCESS MODES      AGE   VOLUMEMODE
pvc1   Bound    pv1      1Gi        RWX               94m   Filesystem
pvc2   Bound    pv2      2Gi        RWX               94m   Filesystem
pvc3   Bound    pv3      3Gi        RWX               94m   Filesystem</p><h1>查看pv</h1><p>[root@k8s-master01 ~]<!-- --># kubectl get pv -n dev -o wide
NAME   CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM       AGE     VOLUMEMODE
pv1    1Gi        RWX            Retain           Bound    dev/pvc1    5h11m   Filesystem
pv2    2Gi        RWX            Retain           Bound    dev/pvc2    5h11m   Filesystem
pv3    3Gi        RWX            Retain           Bound    dev/pvc3    5h11m   Filesystem</p><h1>查看nfs中的文件存储</h1><p>[root@nfs ~]<!-- --># more /root/data/pv1/out.txt
node1
node1
<!-- -->[root@nfs ~]<!-- --># more /root/data/pv2/out.txt
node2
node2</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##### </span><span class="token number" style="color:#36acaa">8.2</span><span class="token number" style="color:#36acaa">.3</span><span class="token plain"> 生命周期</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">PVC</span><span class="token plain">和</span><span class="token constant" style="color:#36acaa">PV</span><span class="token plain">是一一对应的，</span><span class="token constant" style="color:#36acaa">PV</span><span class="token plain">和</span><span class="token constant" style="color:#36acaa">PVC</span><span class="token plain">之间的相互作用遵循以下生命周期：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>资源供应</strong>：管理员手动创建底层存储和PV</p></li><li><p><strong>资源绑定</strong>：用户创建PVC，kubernetes负责根据PVC的声明去寻找PV，并绑定</p><p>在用户定义好PVC之后，系统将根据PVC对存储资源的请求在已存在的PV中选择一个满足条件的</p><ul><li>一旦找到，就将该PV与用户定义的PVC进行绑定，用户的应用就可以使用这个PVC了</li><li>如果找不到，PVC则会无限期处于Pending状态，直到等到系统管理员创建了一个符合其要求的PV</li></ul><p>PV一旦绑定到某个PVC上，就会被这个PVC独占，不能再与其他PVC进行绑定了</p></li><li><p><strong>资源使用</strong>：用户可在pod中像volume一样使用pvc</p><p>Pod使用Volume的定义，将PVC挂载到容器内的某个路径进行使用。</p></li><li><p><strong>资源释放</strong>：用户删除pvc来释放pv</p><p>当存储资源使用完毕后，用户可以删除PVC，与该PVC绑定的PV将会被标记为“已释放”，但还不能立刻与其他PVC进行绑定。通过之前PVC写入的数据可能还被留在存储设备上，只有在清除之后该PV才能再次使用。</p></li><li><p><strong>资源回收</strong>：kubernetes根据pv设置的回收策略进行资源的回收</p><p>  对于PV，管理员可以设定回收策略，用于设置与之绑定的PVC释放资源之后如何处理遗留数据的问题。只有PV的存储空间完成回收，才能供新的PVC绑定和使用</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200515002806726-93b50e350b54c1f1d3daba0d0b262122.png" width="1219" height="542" class="img_ev3q"></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="83-配置存储">8.3 配置存储<a href="#83-配置存储" class="hash-link" aria-label="8.3 配置存储的直接链接" title="8.3 配置存储的直接链接">​</a></h4><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="831-configmap">8.3.1 ConfigMap<a href="#831-configmap" class="hash-link" aria-label="8.3.1 ConfigMap的直接链接" title="8.3.1 ConfigMap的直接链接">​</a></h5><p>ConfigMap是一种比较特殊的存储卷，它的主要作用是用来存储配置信息的。</p><p>创建configmap.yaml，内容如下：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">ConfigMap</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> configmap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">data</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">info</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">username</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">password</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">123456</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接下来，使用此配置文件创建configmap</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建configmap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f configmap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configmap</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">configmap created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看configmap详情</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl describe cm configmap </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">         configmap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">    dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">       </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Annotations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">===</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">info</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">username</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">password</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">123456</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Events</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接下来创建一个pod-configmap.yaml，将上面创建的configmap挂载进去</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">configmap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">image</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.17</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">volumeMounts</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 将configmap挂载到目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">mountPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">configmap</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">volumes</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> # 引用configmap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">configMap</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> configmap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">configmap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">configmap created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pod pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">configmap </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">            </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">configmap   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          6s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#进入容器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl exec </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">it pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">configmap </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># cd </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">configmap</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">config</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># more info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">username</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">password</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">123456</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 可以看到映射已经成功，每个configmap都映射成了一个目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># key</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">文件     value</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">文件中的内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 此时如果更新configmap的内容</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 容器中的值也会动态更新</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="832-secret">8.3.2 Secret<a href="#832-secret" class="hash-link" aria-label="8.3.2 Secret的直接链接" title="8.3.2 Secret的直接链接">​</a></h5><p>在kubernetes中，还存在一种和ConfigMap非常类似的对象，称为Secret对象。它主要用于存储敏感信息，例如密码、秘钥、证书等等。</p></li></ul><ol><li><p>首先使用base64对数据进行编码</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># echo </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n </span><span class="token string" style="color:#e3116c">&#x27;admin&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> base64 #准备username</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">YWRtaW4</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># echo </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n </span><span class="token string" style="color:#e3116c">&#x27;123456&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> base64 #准备password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">MTIzNDU2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>接下来编写secret.yaml，并创建Secret</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Secret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Opaque</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">data</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">username</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">YWRtaW4</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">password</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">MTIzNDU2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f secret</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">secret</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">secret created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看secret详情</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl describe secret secret </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">         secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">    dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">       </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Annotations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  </span><span class="token maybe-class-name">Opaque</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">===</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">password</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">username</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> bytes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>创建pod-secret.yaml，将上面创建的secret挂载进去：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pod</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">containers</span><span class="token operator" style="color:#393A34">:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><ul><li><p>name: nginx
image: nginx:1.17.1
volumeMounts: # 将secret挂载到目录</p><ul><li>name: config
mountPath: /secret/config
volumes:</li></ul></li><li><p>name: config
secret:
secretName: secret</p><h1>创建pod</h1><p>[root@k8s-master01 ~]<!-- --># kubectl create -f pod-secret.yaml
pod/pod-secret created</p><h1>查看pod</h1><p>[root@k8s-master01 ~]<!-- --># kubectl get pod pod-secret -n dev
NAME            READY   STATUS    RESTARTS   AGE
pod-secret      1/1     Running   0          2m28s</p><h1>进入容器，查看secret信息，发现已经自动解码了</h1><p>[root@k8s-master01 ~]<!-- --># kubectl exec -it pod-secret /bin/sh -n dev
/ # ls /secret/config/
password  username
/ # more /secret/config/username
admin
/ # more /secret/config/password
123456</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">至此，已经实现了利用secret实现了信息的编码。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### </span><span class="token number" style="color:#36acaa">9.</span><span class="token plain"> 安全认证</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### </span><span class="token number" style="color:#36acaa">9.1</span><span class="token plain"> 访问控制概述</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Kubernetes作为一个分布式集群的管理工具，保证集群的安全性是其一个重要的任务。所谓的安全性其实就是保证对Kubernetes的各种</span><span class="token operator" style="color:#393A34">**</span><span class="token plain">客户端</span><span class="token operator" style="color:#393A34">**</span><span class="token plain">进行</span><span class="token operator" style="color:#393A34">**</span><span class="token plain">认证和鉴权</span><span class="token operator" style="color:#393A34">**</span><span class="token plain">操作。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">**</span><span class="token plain">客户端</span><span class="token operator" style="color:#393A34">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在Kubernetes集群中，客户端通常有两类：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>User Account</strong>：一般是独立于kubernetes之外的其他服务管理的用户账号。</p></li><li><p><strong>Service Account</strong>：kubernetes管理的账号，用于为Pod中的服务进程在访问Kubernetes时提供身份标识。</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200520102949189-fd25c1b6e48823fff5af473a4497aac8.png" width="857" height="287" class="img_ev3q"></p><p><strong>认证、授权与准入控制</strong></p><p>ApiServer是访问及管理资源对象的唯一入口。任何一个请求访问ApiServer，都要经过下面三个流程：</p></li><li><p>Authentication（认证）：身份鉴别，只有正确的账号才能够通过认证</p></li><li><p>Authorization（授权）： 判断用户是否有权限对访问的资源执行特定的动作</p></li><li><p>Admission Control（准入控制）：用于补充授权机制以实现更加精细的访问控制功能。</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200520103942580-c7a23955976e4434004d256778f7593b.png" width="1017" height="214" class="img_ev3q"></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="92-认证管理">9.2 认证管理<a href="#92-认证管理" class="hash-link" aria-label="9.2 认证管理的直接链接" title="9.2 认证管理的直接链接">​</a></h4><p>Kubernetes集群安全的最关键点在于如何识别并认证客户端身份，它提供了3种客户端身份认证方式：</p></li><li><p>HTTP Base认证：通过用户名+密码的方式认证</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">这种认证方式是把“用户名</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">密码”用</span><span class="token constant" style="color:#36acaa">BASE64</span><span class="token plain">算法进行编码后的字符串放在</span><span class="token constant" style="color:#36acaa">HTTP</span><span class="token plain">请求中的Header </span><span class="token maybe-class-name">Authorization域里发送给服务端。服务端收到后进行解码，获取用户名及密码，然后进行用户身份认证的过程。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>HTTP Token认证：通过一个Token来识别合法用户</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    这种认证方式是用一个很长的难以被模仿的字符串</span><span class="token operator" style="color:#393A34">--</span><span class="token maybe-class-name">Token来表明客户身份的一种方式。每个Token对应一个用户名，当客户端发起</span><span class="token constant" style="color:#36acaa">API</span><span class="token plain">调用请求时，需要在</span><span class="token constant" style="color:#36acaa">HTTP</span><span class="token plain"> </span><span class="token maybe-class-name">Header里放入Token，</span><span class="token constant" style="color:#36acaa">API</span><span class="token plain"> </span><span class="token maybe-class-name">Server接到Token后会跟服务器中保存的token进行比对，然后进行用户身份认证的过程。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>HTTPS证书认证：基于CA根证书签名的双向数字证书认证方式</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    这种认证方式是安全性最高的一种方式，但是同时也是操作起来最麻烦的一种方式。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200518211037434-77ebb7bb30f7a101461596d3449f287a.png" width="980" height="487" class="img_ev3q"></p><p><strong>HTTPS认证大体分为3个过程：</strong></p></li></ul><ol><li><p>证书申请和下发</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">HTTPS</span><span class="token plain">通信双方的服务器向</span><span class="token constant" style="color:#36acaa">CA</span><span class="token plain">机构申请证书，</span><span class="token constant" style="color:#36acaa">CA</span><span class="token plain">机构下发根证书、服务端证书及私钥给申请者</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>客户端和服务端的双向认证</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> 客户端向服务器端发起请求，服务端下发自己的证书给客户端，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     客户端接收到证书后，通过私钥解密证书，在证书中获得服务端的公钥，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     客户端利用服务器端的公钥认证证书中的信息，如果一致，则认可这个服务器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> 客户端发送自己的证书给服务器端，服务端接收到证书后，通过私钥解密证书，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     在证书中获得客户端的公钥，并用该公钥认证证书信息，确认客户端是否合法</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>服务器端和客户端进行通信</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  服务器端和客户端协商好加密方案后，客户端会产生一个随机的秘钥并加密，然后发送到服务器端。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  服务器端接收这个秘钥后，双方接下来通信的所有内容都通过该随机秘钥加密</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> 注意: Kubernetes允许同时配置多种认证方式，只要其中任意一个方式认证通过即可</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="93-授权管理">9.3 授权管理<a href="#93-授权管理" class="hash-link" aria-label="9.3 授权管理的直接链接" title="9.3 授权管理的直接链接">​</a></h4><p>授权发生在认证成功之后，通过认证就可以知道请求用户是谁， 然后Kubernetes会根据事先定义的授权策略来决定用户是否有权限访问，这个过程就称为授权。</p><p>每个发送到ApiServer的请求都带上了用户和资源的信息：比如发送请求的用户、请求的路径、请求的动作等，授权就是根据这些信息和授权策略进行比较，如果符合策略，则认为授权通过，否则会返回错误。</p><p>API Server目前支持以下几种授权策略：</p></li></ol><ul><li><p>AlwaysDeny：表示拒绝所有请求，一般用于测试</p></li><li><p>AlwaysAllow：允许接收所有请求，相当于集群不需要授权流程（Kubernetes默认的策略）</p></li><li><p>ABAC：基于属性的访问控制，表示使用用户配置的授权规则对用户请求进行匹配和控制</p></li><li><p>Webhook：通过调用外部REST服务对用户进行授权</p></li><li><p>Node：是一种专用模式，用于对kubelet发出的请求进行访问控制</p></li><li><p>RBAC：基于角色的访问控制（kubeadm安装方式下的默认选项）</p><p>RBAC(Role-Based Access Control) 基于角色的访问控制，主要是在描述一件事情：<strong>给哪些对象授予了哪些权限</strong></p><p>其中涉及到了下面几个概念：</p></li><li><p>对象：User、Groups、ServiceAccount</p></li><li><p>角色：代表着一组定义在资源上的可操作动作(权限)的集合</p></li><li><p>绑定：将定义好的角色跟用户绑定在一起</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200519181209566-aeb4ebc38cc2a38ae18ccaa76b46eecc.png" width="911" height="464" class="img_ev3q"></p><p>RBAC引入了4个顶级资源对象：</p></li><li><p>Role、ClusterRole：角色，用于指定一组权限</p></li><li><p>RoleBinding、ClusterRoleBinding：角色绑定，用于将角色（权限）赋予给对象</p><p><strong>Role、ClusterRole</strong></p><p>一个角色就是一组权限的集合，这里的权限都是许可形式的（白名单）。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token maybe-class-name">Role只能对命名空间内的资源进行授权，需要指定nameapce</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Role</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> rbac</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">authorization</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">k8s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> authorization</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">rules</span><span class="token operator" style="color:#393A34">:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>apiGroups: <!-- -->[&quot;&quot;]<!-- -->  # 支持的API组列表,&quot;&quot; 空字符串，表示核心API群
resources: <!-- -->[&quot;pods&quot;]<!-- --> # 支持的资源对象列表
verbs: <!-- -->[&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]<!-- --> # 允许的对资源对象的操作方法列表</p><h1>ClusterRole可以对集群范围内资源、跨namespaces的范围资源、非资源类型进行授权</h1><p>kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
name: authorization-clusterrole
rules:</p></li><li><p>apiGroups: <!-- -->[&quot;&quot;]<!-- -->
resources: <!-- -->[&quot;pods&quot;]<!-- -->
verbs: <!-- -->[&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">需要详细说明的是，rules中的参数：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>apiGroups: 支持的API组列表</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;apps&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;autoscaling&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;batch&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>resources：支持的资源对象列表</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&quot;services&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;endpoints&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pods&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;secrets&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;configmaps&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;crontabs&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;deployments&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;jobs&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;nodes&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;rolebindings&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;clusterroles&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;daemonsets&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;replicasets&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;statefulsets&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;horizontalpodautoscalers&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;replicationcontrollers&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;cronjobs&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>verbs：对资源对象的操作方法列表</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&quot;get&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;list&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;watch&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;create&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;update&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;patch&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;delete&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;exec&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>RoleBinding、ClusterRoleBinding</strong></p><p>角色绑定用来把一个角色绑定到一个目标对象上，绑定目标可以是User、Group或者ServiceAccount。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token maybe-class-name">RoleBinding可以将同一namespace中的subject绑定到某个Role下，则此subject即具有该Role定义的权限</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">RoleBinding</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> rbac</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">authorization</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">k8s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> authorization</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">role</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">binding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">subjects</span><span class="token operator" style="color:#393A34">:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>kind: User
name: heima
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: Role
name: authorization-role
apiGroup: rbac.authorization.k8s.io</p><h1>ClusterRoleBinding在整个集群级别和所有namespaces将特定的subject与ClusterRole绑定，授予权限</h1><p>kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
name: authorization-clusterrole-binding
subjects:</p></li><li><p>kind: User
name: heima
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: authorization-clusterrole
apiGroup: rbac.authorization.k8s.io</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">**</span><span class="token maybe-class-name">RoleBinding引用ClusterRole进行授权</span><span class="token operator" style="color:#393A34">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">RoleBinding可以引用ClusterRole，对属于同一命名空间内ClusterRole定义的资源主体进行授权。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">一种很常用的做法就是，集群管理员为集群范围预定义好一组角色（ClusterRole），然后在多个命名空间中重复使用这些ClusterRole。这样可以大幅提高授权管理工作效率，也使得各个命名空间下的基础性授权规则与使用体验保持一致。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>虽然authorization-clusterrole是一个集群角色，但是因为使用了RoleBinding</h1><h1>所以heima只能读取dev命名空间中的资源</h1><p>kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
name: authorization-role-binding-ns
namespace: dev
subjects:</p></li><li><p>kind: User
name: heima
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: authorization-clusterrole
apiGroup: rbac.authorization.k8s.io</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">**</span><span class="token plain">实战：创建一个只能管理dev空间下Pods资源的账号</span><span class="token operator" style="color:#393A34">**</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><ol><li><p>创建账号</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> 创建证书</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 pki</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># cd </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pki</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 pki</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">umask </span><span class="token number" style="color:#36acaa">077</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">openssl genrsa </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">out devman</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">key</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> 用apiserver的证书去签署</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> 签名申请，申请的用户是devman</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">组是devgroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 pki</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># openssl req </span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">key devman</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">key</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">out devman</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">csr</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">subj </span><span class="token string" style="color:#e3116c">&quot;/CN=devman/O=devgroup&quot;</span><span class="token plain">     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> 签署证书</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 pki</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># openssl x509 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">req </span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> devman</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">csr</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">CA</span><span class="token plain"> ca</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">crt</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token maybe-class-name">CAkey</span><span class="token plain"> ca</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">key</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token maybe-class-name">CAcreateserial</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">out devman</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">crt</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">days </span><span class="token number" style="color:#36acaa">3650</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> 设置集群、用户、上下文信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 pki</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl config set</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cluster kubernetes </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">embed</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">certs</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">certificate</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">authority</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pki</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">ca</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">crt</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">server</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">192.168</span><span class="token number" style="color:#36acaa">.109</span><span class="token number" style="color:#36acaa">.100</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">6443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 pki</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl config set</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">credentials devman </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">embed</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">certs</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">client</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">certificate</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pki</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">devman</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">crt</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">client</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">key</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">etc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pki</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">devman</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 pki</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl config set</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">context devman@kubernetes </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">cluster</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kubernetes </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">user</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">devman</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 切换账户到devman</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 pki</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl config use</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">context devman@kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Switched</span><span class="token plain"> to context </span><span class="token string" style="color:#e3116c">&quot;devman@kubernetes&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看dev下pod，发现没有权限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 pki</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token known-class-name class-name">Error</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">server</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">Forbidden</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> pods is forbidden</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">User</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;devman&quot;</span><span class="token plain"> cannot list resource </span><span class="token string" style="color:#e3116c">&quot;pods&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">API</span><span class="token plain"> group </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> the namespace </span><span class="token string" style="color:#e3116c">&quot;dev&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 切换到admin账户</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 pki</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl config use</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">context kubernetes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">admin@kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Switched</span><span class="token plain"> to context </span><span class="token string" style="color:#e3116c">&quot;kubernetes-admin@kubernetes&quot;</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2） 创建Role和RoleBinding，为devman用户授权</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Role</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> rbac</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">authorization</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">k8s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dev</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">rules</span><span class="token operator" style="color:#393A34">:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><ul><li><p>apiGroups: <!-- -->[&quot;&quot;]<!-- -->
resources: <!-- -->[&quot;pods&quot;]<!-- -->
verbs: <!-- -->[&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]</p><hr><p>kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
name: authorization-role-binding
namespace: dev
subjects:</p></li><li><p>kind: User
name: devman
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: Role
name: dev-role
apiGroup: rbac.authorization.k8s.io
<!-- -->[root@k8s-master01 pki]<!-- --># kubectl create -f dev-role.yaml
role.rbac.authorization.k8s.io/dev-role created
rolebinding.rbac.authorization.k8s.io/authorization-role-binding created</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><ol><li><p>切换账户，再次验证</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 切换账户到devman</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 pki</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl config use</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">context devman@kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Switched</span><span class="token plain"> to context </span><span class="token string" style="color:#e3116c">&quot;devman@kubernetes&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 再次查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 pki</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pods </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                                 </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">             </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">66cb59b984</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">8wp2k    </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          4d1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">66cb59b984</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dc46j    </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          4d1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">66cb59b984</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">thfck    </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          4d1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 为了不影响后面的学习</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">切回admin账户</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 pki</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl config use</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">context kubernetes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">admin@kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Switched</span><span class="token plain"> to context </span><span class="token string" style="color:#e3116c">&quot;kubernetes-admin@kubernetes&quot;</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="94-准入控制">9.4 准入控制<a href="#94-准入控制" class="hash-link" aria-label="9.4 准入控制的直接链接" title="9.4 准入控制的直接链接">​</a></h4><p>通过了前面的认证和授权之后，还需要经过准入控制处理通过之后，apiserver才会处理这个请求。</p><p>准入控制是一个可配置的控制器列表，可以通过在Api-Server上通过命令行设置选择执行哪些准入控制器：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">--</span><span class="token plain">admission</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">control</span><span class="token operator" style="color:#393A34">=</span><span class="token maybe-class-name">NamespaceLifecycle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token maybe-class-name">LimitRanger</span><span class="token punctuation" style="color:#393A34">,</span><span class="token maybe-class-name">ServiceAccount</span><span class="token punctuation" style="color:#393A34">,</span><span class="token maybe-class-name">PersistentVolumeLabel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token maybe-class-name">DefaultStorageClass</span><span class="token punctuation" style="color:#393A34">,</span><span class="token maybe-class-name">ResourceQuota</span><span class="token punctuation" style="color:#393A34">,</span><span class="token maybe-class-name">DefaultTolerationSeconds</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>只有当所有的准入控制器都检查通过之后，apiserver才执行该请求，否则返回拒绝。</p><p>当前可配置的Admission Control准入控制如下：</p></li></ol><ul><li><p>AlwaysAdmit：允许所有请求</p></li><li><p>AlwaysDeny：禁止所有请求，一般用于测试</p></li><li><p>AlwaysPullImages：在启动容器之前总去下载镜像</p></li><li><p>DenyExecOnPrivileged：它会拦截所有想在Privileged Container上执行命令的请求</p></li><li><p>ImagePolicyWebhook：这个插件将允许后端的一个Webhook程序来完成admission controller的功能。</p></li><li><p>Service Account：实现ServiceAccount实现了自动化</p></li><li><p>SecurityContextDeny：这个插件将使用SecurityContext的Pod中的定义全部失效</p></li><li><p>ResourceQuota：用于资源配额管理目的，观察所有请求，确保在namespace上的配额不会超标</p></li><li><p>LimitRanger：用于资源限制管理，作用于namespace上，确保对Pod进行资源限制</p></li><li><p>InitialResources：为未设置资源请求与限制的Pod，根据其镜像的历史资源的使用情况进行设置</p></li><li><p>NamespaceLifecycle：如果尝试在一个不存在的namespace中创建资源对象，则该创建请求将被拒绝。当删除一个namespace时，系统将会删除该namespace中所有对象。</p></li><li><p>DefaultStorageClass：为了实现共享存储的动态供应，为未指定StorageClass或PV的PVC尝试匹配默认的StorageClass，尽可能减少用户在申请PVC时所需了解的后端存储细节</p></li><li><p>DefaultTolerationSeconds：这个插件为那些没有设置forgiveness tolerations并具有notready:NoExecute和unreachable:NoExecute两种taints的Pod设置默认的“容忍”时间，为5min</p></li><li><p>PodSecurityPolicy：这个插件用于在创建或修改Pod时决定是否根据Pod的security context和可用的PodSecurityPolicy对Pod的安全策略进行控制</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="10-dashboard">10. DashBoard<a href="#10-dashboard" class="hash-link" aria-label="10. DashBoard的直接链接" title="10. DashBoard的直接链接">​</a></h3><p>之前在kubernetes中完成的所有操作都是通过命令行工具kubectl完成的。其实，为了提供更丰富的用户体验，kubernetes还开发了一个基于web的用户界面（Dashboard）。用户可以使用Dashboard部署容器化的应用，还可以监控应用的状态，执行故障排查以及管理kubernetes中各种资源。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="101-部署dashboard">10.1 部署Dashboard<a href="#101-部署dashboard" class="hash-link" aria-label="10.1 部署Dashboard的直接链接" title="10.1 部署Dashboard的直接链接">​</a></h4></li></ul><ol><li><p>下载yaml，并运行Dashboard</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 下载yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># wget  https</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">raw</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">githubusercontent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dashboard</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">0.0</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">aio</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">deploy</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">recommended</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 修改kubernetes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dashboard的Service类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">apiVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> kubernetes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dashboard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> kubernetes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dashboard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> kubernetes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dashboard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">NodePort</span><span class="token plain">  # 新增</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">ports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">targetPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">nodePort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30009</span><span class="token plain">  # 新增</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> kubernetes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dashboard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 部署</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f recommended</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看namespace下的kubernetes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dashboard下的资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">svc </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n kubernetes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dashboard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                                            </span><span class="token constant" style="color:#36acaa">READY</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">STATUS</span><span class="token plain">    </span><span class="token constant" style="color:#36acaa">RESTARTS</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dashboard</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">metrics</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">scraper</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c79c65bb7</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">zwfvw   </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          111s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dashboard</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">56484d4c5</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">z95z5        </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     </span><span class="token maybe-class-name">Running</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          111s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">NAME</span><span class="token plain">                               </span><span class="token constant" style="color:#36acaa">TYPE</span><span class="token plain">       </span><span class="token constant" style="color:#36acaa">CLUSTER</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">      </span><span class="token constant" style="color:#36acaa">EXTERNAL</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">  </span><span class="token constant" style="color:#36acaa">PORT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">         </span><span class="token constant" style="color:#36acaa">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dashboard</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">metrics</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">scraper  </span><span class="token maybe-class-name">ClusterIP</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">10.96</span><span class="token number" style="color:#36acaa">.89</span><span class="token number" style="color:#36acaa">.218</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none       </span><span class="token number" style="color:#36acaa">8000</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain">        111s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dashboard       </span><span class="token maybe-class-name">NodePort</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">10.104</span><span class="token number" style="color:#36acaa">.178</span><span class="token number" style="color:#36acaa">.171</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none       </span><span class="token number" style="color:#36acaa">443</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">30009</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain">   111s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2）创建访问账户，获取token</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建账号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create serviceaccount dashboard</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">admin </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n kubernetes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dashboard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 授权</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl create clusterrolebinding dashboard</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">admin</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">rb </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">clusterrole</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">cluster</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">admin </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">serviceaccount</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dashboard</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">dashboard</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 获取账号token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">#  kubectl </span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> secrets </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n kubernetes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dashboard </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> grep dashboard</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dashboard</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">admin</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">token</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">xbqhh        kubernetes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">account</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">token   </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">      2m35s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">root@k8s</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">master01 </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"># kubectl describe secrets dashboard</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">admin</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">token</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">xbqhh </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n kubernetes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dashboard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">         dashboard</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">admin</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">token</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">xbqhh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">    kubernetes</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dashboard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Labels</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">       </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Annotations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  kubernetes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> dashboard</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              kubernetes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">uid</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> 95d84d80</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">be7a</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">4d10</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">a2e0</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">68f90222d039</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  kubernetes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">service</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">account</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">===</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">20</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">token</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">      eyJhbGciOiJSUzI1NiIsImtpZCI6ImJrYkF4bW5XcDhWcmNGUGJtek5NODFuSXl1aWptMmU2M3o4LTY5a2FKS2cifQ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4teGJxaGgiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiOTVkODRkODAtYmU3YS00ZDEwLWEyZTAtNjhmOTAyMjJkMDM5Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmVybmV0ZXMtZGFzaGJvYXJkOmRhc2hib2FyZC1hZG1pbiJ9</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access maybe-class-name">NAl7e8ZfWWdDoPxkqzJzTB46sK9E8iuJYnUI9vnBaY3Jts7T1g1msjsBnbxzQSYgAG</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">cV0WYxjndzJY_UWCwaGPrQrt_GunxmOK9AUnzURqm55GR2RXIZtjsWVP2EBatsDgHRmuUbQvTFOvdJB4x3nXcYLN2opAaMqg3rnU2rr</span><span class="token operator" style="color:#393A34">-</span><span class="token maybe-class-name">A8zCrIuX_eca12wIp_QiuP3SF</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">tzpdLpsyRfegTJZl6YnSGyaVkC9id</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cxZRb307qdCfXPfCHR_2rt5FVfxARgg_C0e3eFHaaYQO7CitxsnIoIXpOFNAR8aUrmopJyODQIPqBWUehb7FhlU1DCduHnIIXVC_UICZ</span><span class="token operator" style="color:#393A34">-</span><span class="token maybe-class-name">MKYewBDLw</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ca</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">crt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">1025</span><span class="token plain"> bytes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>3）通过浏览器访问Dashboard的UI</p><p>在登录页面上输入上面的token</p><p><img loading="lazy" alt="image-20200520144548997" src="/blog/assets/images/image-20200520144548997-810535a80acdab0804e222de92b82bf5.png" width="1030" height="528" class="img_ev3q"></p><p>出现下面的页面代表成功</p><p><img loading="lazy" alt="image-20200520144959353" src="/blog/assets/images/image-20200520144959353-ba05068dcffbb1846bcbe1b2402c7982.png" width="1911" height="925" class="img_ev3q"></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="102-使用dashboard">10.2 使用DashBoard<a href="#102-使用dashboard" class="hash-link" aria-label="10.2 使用DashBoard的直接链接" title="10.2 使用DashBoard的直接链接">​</a></h4><p>本章节以Deployment为例演示DashBoard的使用</p><p><strong>查看</strong></p><p>选择指定的命名空间<code>dev</code>，然后点击<code>Deployments</code>，查看dev空间下的所有deployment</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200520154628679-1060a3b85c484ae1c17c5c9987cef365.png" width="1890" height="389" class="img_ev3q"></p><p><strong>扩缩容</strong></p><p>在<code>Deployment</code>上点击<code>规模</code>，然后指定<code>目标副本数量</code>，点击确定</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200520162605102-c61a117b37f9fc2d56d7aee99b190d74.png" width="1583" height="616" class="img_ev3q"></p><p><strong>编辑</strong></p><p>在<code>Deployment</code>上点击<code>编辑</code>，然后修改<code>yaml文件</code>，点击确定</p><p><img loading="lazy" alt="image-20200520163253644" src="/blog/assets/images/image-20200520163253644-a5bd3d867de1eed4dca69d8053557ac8.png" width="1557" height="382" class="img_ev3q"></p><p><strong>查看Pod</strong></p><p>点击<code>Pods</code>, 查看pods列表</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200520163552110-84b9424d34a57cb043681ecdc66c1fea.png" width="1879" height="535" class="img_ev3q"></p><p><strong>操作Pod</strong></p><p>选中某个Pod，可以对其执行日志（logs）、进入执行（exec）、编辑、删除操作</p><p><img loading="lazy" alt="img" src="/blog/assets/images/image-20200520163832827-0f359538f9245131eb036cb49a0a0e65.png" width="1530" height="313" class="img_ev3q"></p><p> Dashboard提供了kubectl的绝大部分功能，这里不再一一演示</p></li></ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/CICD/Kubernetes.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/docs/CICD/jenkins源码学习"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Jenkins源码学习</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/docs/python/正则表达式"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">正则表达式</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#kubernetes详细教程" class="table-of-contents__link toc-highlight">kubernetes详细教程</a><ul><li><a href="#1-kubernetes介绍" class="table-of-contents__link toc-highlight">1. Kubernetes介绍</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/blog/assets/js/runtime~main.53b44da0.js"></script>
<script src="/blog/assets/js/main.20f910f3.js"></script>
</body>
</html>